<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="keywords" content="YANZ, Forgot Password, Password Reset, Account Recovery">
  <meta name="theme-color" content="#0c1b33">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="icon" href="https://i.postimg.cc/TPNFmJ50/a7f768b4dc4e12857e1e56f350cd2818.jpg" type="image/png" />
  <title>Reset Password</title>
  <meta name="description" content="Reset your YANZ account password securely." />

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
  
  <style>
    :root {
      --primary-bg: #0c1b33;
      --secondary-bg: #1e3a5f;
      --accent-color: #4fc3f7;
      --accent-secondary: #29b6f6;
      --winter-blue: #4fc3f7;
      --winter-light-blue: #b3e5fc;
      --winter-white: #e1f5fe;
      --text-primary: #f8fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #a0aec0;
      --success-color: #81c784;
      --error-color: #e57373;
      --warning-color: #ffb74d;
      --card-bg: rgba(30, 58, 95, 0.8);
      --card-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      
      --space-xs: 0.5rem;
      --space-sm: 1rem;
      --space-md: 1.5rem;
      --space-lg: 2rem;
      --space-xl: 3rem;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes winter-glow {
      0%, 100% { box-shadow: 0 0 5px var(--winter-blue), 0 0 10px var(--winter-blue); }
      50% { box-shadow: 0 0 15px var(--winter-blue), 0 0 30px var(--winter-blue); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: var(--primary-bg);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
      overflow-x: hidden;
    }

    .winter-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg), var(--primary-bg));
    }

    .floating-crystals {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .crystal {
      position: absolute;
      color: var(--winter-light-blue);
      font-size: 24px;
      opacity: 0.3;
      animation: float 8s ease-in-out infinite;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl) var(--space-md);
    }

    .auth-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius-xl);
      padding: var(--space-xl);
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(79, 195, 247, 0.3);
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
    }

    .auth-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--winter-blue), var(--winter-light-blue), var(--winter-white));
    }

    .auth-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }

    .auth-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
      text-decoration: none;
    }

    .auth-logo img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid var(--winter-blue);
      animation: winter-glow 3s infinite;
    }

    .auth-logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--winter-blue), var(--winter-light-blue));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .auth-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
    }

    .auth-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-xl);
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: rgba(79, 195, 247, 0.2);
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
      position: relative;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(79, 195, 247, 0.1);
      border: 2px solid rgba(79, 195, 247, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--space-xs);
      transition: var(--transition);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .step.active .step-circle {
      background: var(--winter-blue);
      border-color: var(--winter-blue);
      color: var(--primary-bg);
      box-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
    }

    .step.completed .step-circle {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    .step.completed .step-circle::after {
      content: '✓';
    }

    .step-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    .step.active .step-label {
      color: var(--text-primary);
      font-weight: 500;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .form-group {
      position: relative;
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-xs);
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .form-label.required::after {
      content: ' *';
      color: var(--error-color);
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      background: rgba(30, 58, 95, 0.5);
      border: 1px solid rgba(79, 195, 247, 0.3);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
      font-size: 1rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--winter-blue);
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
    }

    .form-input.error {
      border-color: var(--error-color);
    }

    .input-with-icon {
      position: relative;
    }

    .input-icon {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      cursor: pointer;
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .password-strength {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin-top: 0.25rem;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0%;
      transition: var(--transition);
      border-radius: 2px;
    }

    .strength-weak { background: var(--error-color); }
    .strength-fair { background: var(--warning-color); }
    .strength-good { background: #ffd166; }
    .strength-strong { background: var(--success-color); }

    .password-requirements {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .requirement {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.125rem;
    }

    .requirement.valid {
      color: var(--success-color);
    }

    .requirement.invalid {
      color: var(--text-muted);
    }

    .otp-container {
      text-align: center;
    }

    .otp-inputs {
      display: flex;
      gap: var(--space-sm);
      justify-content: center;
      margin: var(--space-lg) 0;
    }

    .otp-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      background: rgba(30, 58, 95, 0.5);
      border: 1px solid rgba(79, 195, 247, 0.3);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      transition: var(--transition);
    }

    .otp-input:focus {
      outline: none;
      border-color: var(--winter-blue);
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
    }

    .otp-timer {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: var(--space-sm);
    }

    .resend-otp {
      background: none;
      border: none;
      color: var(--winter-blue);
      cursor: pointer;
      font-size: 0.875rem;
      transition: var(--transition);
      margin-top: var(--space-sm);
    }

    .resend-otp:hover:not(:disabled) {
      text-decoration: underline;
    }

    .resend-otp:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: var(--border-radius);
      border: none;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--winter-blue), var(--winter-light-blue));
      color: #0c1b33;
      box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 195, 247, 0.6);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid rgba(79, 195, 247, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(79, 195, 247, 0.1);
      color: var(--winter-blue);
      border-color: var(--winter-blue);
    }

    .back-to-login {
      text-align: center;
      margin-top: var(--space-lg);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .back-link {
      color: var(--winter-blue);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .security-info {
      background: rgba(30, 58, 95, 0.3);
      border-radius: var(--border-radius);
      padding: var(--space-md);
      margin-top: var(--space-lg);
      border: 1px solid rgba(79, 195, 247, 0.2);
    }

    .security-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: var(--space-xs);
    }

    .security-list {
      list-style: none;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .security-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .step-content {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .step-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .success-message {
      text-align: center;
      padding: var(--space-lg);
    }

    .success-icon {
      font-size: 4rem;
      color: var(--success-color);
      margin-bottom: var(--space-md);
      animation: float 3s ease-in-out infinite;
    }

    .success-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
    }

    .success-text {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: var(--space-lg);
    }

    .notification {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      background: var(--secondary-bg);
      color: var(--text-primary);
      padding: var(--space-md);
      border-radius: var(--border-radius);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      max-width: 400px;
      border-left: 4px solid var(--winter-blue);
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      margin-left: auto;
      transition: var(--transition);
    }

    .notification-close:hover {
      color: var(--text-primary);
    }

    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(79, 195, 247, 0.3);
      border-top: 4px solid var(--winter-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--space-md);
    }

    .loader-text {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    @media (max-width: 768px) {
      .auth-card {
        padding: var(--space-lg);
      }
      
      .otp-input {
        width: 45px;
        height: 55px;
        font-size: 1.25rem;
      }
      
      .progress-steps::before {
        left: 5%;
        right: 5%;
      }
    }

    @media (max-width: 480px) {
      .auth-card {
        padding: var(--space-md);
      }
      
      .otp-inputs {
        gap: var(--space-xs);
      }
      
      .otp-input {
        width: 40px;
        height: 50px;
        font-size: 1.125rem;
      }
      
      .progress-steps::before {
        left: 2%;
        right: 2%;
      }
    }
  </style>
</head>
<body>
  <div class="winter-bg"></div>
  
  <div class="floating-crystals" id="floating-crystals"></div>

  <div class="loader" id="loader">
    <div style="text-align: center;">
      <div class="loader-spinner"></div>
      <div class="loader-text">Initializing Password Reset...</div>
    </div>
  </div>

  <div class="container" id="container">
    <div class="auth-card">
      <div class="auth-header">
        <a href="https://lphisv5.github.io/v4/" class="auth-logo">
          <img src="https://i.postimg.cc/TPNFmJ50/a7f768b4dc4e12857e1e56f350cd2818.jpg" alt="YANZ Logo">
          <span class="auth-logo-text">YANZ</span>
        </a>
        <h1 class="auth-title">Reset Your Password</h1>
        <p class="auth-subtitle">Follow these steps to recover your account</p>
      </div>

      <div class="progress-steps">
        <div class="step active" id="step-1">
          <div class="step-circle">1</div>
          <div class="step-label">Verify Email</div>
        </div>
        <div class="step" id="step-2">
          <div class="step-circle">2</div>
          <div class="step-label">Enter OTP</div>
        </div>
        <div class="step" id="step-3">
          <div class="step-circle">3</div>
          <div class="step-label">New Password</div>
        </div>
      </div>

      <!-- Step 1: Email Verification -->
      <div class="step-content active" id="step-content-1">
        <form class="auth-form" id="email-form">
          <div class="form-group">
            <label for="email" class="form-label required">Email Address</label>
            <input type="email" id="email" class="form-input" placeholder="Enter your registered email" required>
            <div class="error-message" id="email-error"></div>
          </div>

          <div class="form-group">
            <div class="captcha-container">
              <div class="captcha-text" id="captcha-text">ABC123</div>
              <div class="input-with-icon">
                <input type="text" id="captcha-input" class="form-input" placeholder="Enter the code above" required>
                <button type="button" class="captcha-refresh" id="refresh-captcha">
                  <i class="fas fa-redo"></i>
                </button>
              </div>
            </div>
            <div class="error-message" id="captcha-error"></div>
          </div>

          <div class="auth-buttons">
            <button type="submit" class="btn btn-primary" id="send-otp-btn">
              <i class="fas fa-paper-plane"></i> Send Verification Code
            </button>
          </div>
        </form>

        <div class="back-to-login">
          <a href="https://lphisv5.github.io/v4/" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Login
          </a>
        </div>

        <div class="security-info">
          <div class="security-title">
            <i class="fas fa-shield-alt"></i>
            <span>Security Information</span>
          </div>
          <ul class="security-list">
            <li><i class="fas fa-check-circle"></i> We'll send a verification code to your email</li>
            <li><i class="fas fa-check-circle"></i> The code expires in 5 minutes</li>
            <li><i class="fas fa-check-circle"></i> Your email is kept confidential</li>
          </ul>
        </div>
      </div>

      <!-- Step 2: OTP Verification -->
      <div class="step-content" id="step-content-2">
        <div class="otp-container">
          <p class="auth-subtitle">Enter the 6-digit code sent to <strong id="user-email"></strong></p>
          
          <div class="otp-inputs" id="otp-inputs">
            <input type="text" class="otp-input" maxlength="1" data-index="0">
            <input type="text" class="otp-input" maxlength="1" data-index="1">
            <input type="text" class="otp-input" maxlength="1" data-index="2">
            <input type="text" class="otp-input" maxlength="1" data-index="3">
            <input type="text" class="otp-input" maxlength="1" data-index="4">
            <input type="text" class="otp-input" maxlength="1" data-index="5">
          </div>

          <div class="error-message" id="otp-error"></div>

          <div class="otp-timer">
            Code expires in: <span id="otp-timer">05:00</span>
          </div>

          <div class="auth-buttons">
            <button type="button" class="btn btn-primary" id="verify-otp-btn">
              <i class="fas fa-check-circle"></i> Verify Code
            </button>
            <button type="button" class="btn btn-secondary" id="resend-otp-btn" disabled>
              <i class="fas fa-redo"></i> Resend Code (<span id="resend-timer">60</span>s)
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: New Password -->
      <div class="step-content" id="step-content-3">
        <form class="auth-form" id="password-form">
          <div class="form-group">
            <label for="new-password" class="form-label required">New Password</label>
            <div class="input-with-icon">
              <input type="password" id="new-password" class="form-input" placeholder="Enter new password" required>
              <i class="fas fa-eye input-icon" id="toggle-new-password"></i>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar" id="password-strength-bar"></div>
            </div>
            <div class="password-requirements" id="password-requirements">
              <div class="requirement invalid" id="req-length">
                <i class="fas fa-circle"></i> At least 8 characters
              </div>
              <div class="requirement invalid" id="req-uppercase">
                <i class="fas fa-circle"></i> One uppercase letter
              </div>
              <div class="requirement invalid" id="req-lowercase">
                <i class="fas fa-circle"></i> One lowercase letter
              </div>
              <div class="requirement invalid" id="req-number">
                <i class="fas fa-circle"></i> One number
              </div>
            </div>
            <div class="error-message" id="new-password-error"></div>
          </div>

          <div class="form-group">
            <label for="confirm-password" class="form-label required">Confirm Password</label>
            <div class="input-with-icon">
              <input type="password" id="confirm-password" class="form-input" placeholder="Confirm new password" required>
              <i class="fas fa-eye input-icon" id="toggle-confirm-password"></i>
            </div>
            <div class="error-message" id="confirm-password-error"></div>
          </div>

          <div class="auth-buttons">
            <button type="submit" class="btn btn-primary" id="reset-password-btn">
              <i class="fas fa-key"></i> Reset Password
            </button>
            <button type="button" class="btn btn-secondary" id="back-to-email-btn">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>
        </form>
      </div>

      <!-- Success Message -->
      <div class="step-content" id="success-content">
        <div class="success-message">
          <div class="success-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h2 class="success-title">Password Reset Successful!</h2>
          <p class="success-text">Your password has been updated successfully. You can now log in with your new password.</p>
          <div class="auth-buttons">
            <a href="https://lphisv5.github.io/v4/" class="btn btn-primary">
              <i class="fas fa-sign-in-alt"></i> Go to Login
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notification-message">This is a notification</span>
    <button class="notification-close" id="notification-close">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script>
    // Initialize EmailJS
    (function() {
      emailjs.init("QRpj9mdUY5jURnFt7");
      console.log('✅ EmailJS initialized');
    })();

    document.addEventListener('DOMContentLoaded', function() {
      console.log('Password Reset Initializing...');
      
      createFloatingCrystals();
      initializeFirebase();
      initializeApp();
      
      setTimeout(() => {
        document.getElementById('loader').classList.add('hidden');
      }, 1000);
    });

    function createFloatingCrystals() {
      const container = document.getElementById('floating-crystals');
      const symbols = ['✦', '❄', '❅', '❆', '✧'];
      
      for (let i = 0; i < 12; i++) {
        const crystal = document.createElement('div');
        crystal.className = 'crystal';
        crystal.innerHTML = symbols[Math.floor(Math.random() * symbols.length)];
        crystal.style.left = `${Math.random() * 100}%`;
        crystal.style.top = `${Math.random() * 100}%`;
        crystal.style.animationDelay = `${Math.random() * 5}s`;
        crystal.style.fontSize = `${Math.random() * 15 + 20}px`;
        container.appendChild(crystal);
      }
    }

    let database = null;
    let authSystem = null;

    function initializeFirebase() {
      try {
        if (!firebase.apps.length) {
          const firebaseConfig = {
            apiKey: "AIzaSyA_sh9fh7h1gGOurALEWJAq3Y-o7vSeaCM",
            authDomain: "yanzz-6e06c.firebaseapp.com",
            databaseURL: "https://yanzz-6e06c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "yanzz-6e06c",
            storageBucket: "yanzz-6e06c.firebasestorage.app",
            messagingSenderId: "951083749698",
            appId: "1:951083749698:web:3e279cd0dc9a9be39bf8db",
            measurementId: "G-YV2G95Z9HE"
          };

          firebase.initializeApp(firebaseConfig);
          console.log('✅ Firebase initialized successfully');
        }
        
        database = firebase.database();
        
      } catch (error) {
        console.error('Firebase initialization failed:', error);
      }
    }

    class PasswordResetSystem {
      constructor() {
        this.currentCaptcha = this.generateCaptcha();
        this.currentOTP = '';
        this.currentEmail = '';
        this.userId = '';
        this.otpTimer = null;
        this.resendTimer = null;
      }

      generateCaptcha() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        let captcha = '';
        for (let i = 0; i < 6; i++) {
          captcha += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return captcha;
      }

      generateOTP() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }

      hashPassword(password) {
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
          const char = password.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash.toString(36) + password.length;
      }

      async checkEmailExists(email) {
        if (!database) return false;
        
        try {
          const snapshot = await database.ref('users').once('value');
          if (!snapshot.exists()) return false;

          let exists = false;
          let userId = null;
          
          snapshot.forEach((child) => {
            const user = child.val();
            if (user.email && user.email.toLowerCase() === email.toLowerCase()) {
              exists = true;
              userId = child.key;
            }
          });

          return { exists, userId };
        } catch (error) {
          console.error('Error checking email:', error);
          return { exists: false, userId: null };
        }
      }

      async sendResetOTP(email) {
        this.currentOTP = this.generateOTP();
        this.currentEmail = email;

        try {
          // Get user ID
          const emailCheck = await this.checkEmailExists(email);
          if (!emailCheck.exists) {
            throw new Error('Email not found');
          }
          this.userId = emailCheck.userId;

          // Send email using EmailJS
          const templateParams = {
            to_email: email,
            otp_code: this.currentOTP,
            app_name: 'YANZ Hub',
            from_name: 'YANZ Password Reset',
            expiry_minutes: 5
          };

          const response = await emailjs.send(
            'service_wxwtcsh',
            'template_5fwmpvu',
            templateParams
          );

          console.log('✅ Reset email sent successfully:', response.status);
          
          if (database) {
            const otpRef = database.ref(`password_reset_otps/${email.replace(/[^a-z0-9]/gi, '_')}`);
            await otpRef.set({
              otp: this.currentOTP,
              email: email,
              userId: this.userId,
              createdAt: Date.now(),
              expiresAt: Date.now() + 5 * 60 * 1000
            });
          }
          
          return { 
            success: true, 
            message: 'Verification code sent to your email'
          };

        } catch (error) {
          console.error('Reset OTP error:', error);
          
          if (database && this.userId) {
            try {
              const otpRef = database.ref(`password_reset_otps/${email.replace(/[^a-z0-9]/gi, '_')}`);
              await otpRef.set({
                otp: this.currentOTP,
                email: email,
                userId: this.userId,
                createdAt: Date.now(),
                expiresAt: Date.now() + 5 * 60 * 1000
              });
              
              console.log('✅ OTP saved to Firebase as fallback');
              return { 
                success: true, 
                message: 'Verification code generated',
                otp: this.currentOTP
              };
            } catch (firebaseError) {
              console.error('Failed to store OTP in Firebase:', firebaseError);
            }
          }
          
          throw error;
        }
      }

      async verifyResetOTP(otp) {
        if (otp === this.currentOTP) {
          return { success: true, userId: this.userId };
        }

        if (database) {
          try {
            const otpRef = database.ref(`password_reset_otps/${this.currentEmail.replace(/[^a-z0-9]/gi, '_')}`);
            const snapshot = await otpRef.once('value');
            
            if (snapshot.exists()) {
              const otpData = snapshot.val();
              
              if (Date.now() > otpData.expiresAt) {
                await otpRef.remove();
                throw new Error('OTP expired');
              }

              if (otpData.otp === otp) {
                await otpRef.remove();
                this.userId = otpData.userId;
                return { success: true, userId: otpData.userId };
              }
            }
          } catch (error) {
            console.error('Firebase OTP verification error:', error);
          }
        }

        throw new Error('Invalid OTP code');
      }

      async updatePassword(newPassword) {
        if (!database || !this.userId) {
          throw new Error('System error');
        }

        try {
          const hashedPassword = this.hashPassword(newPassword);
          await database.ref(`users/${this.userId}/password`).set(hashedPassword);
          
          await database.ref(`password_history/${this.userId}`).push().set({
            changedAt: Date.now(),
            ip: await getClientIP()
          });
          
          return { success: true };
        } catch (error) {
          console.error('Password update error:', error);
          throw error;
        }
      }
    }

    async function getClientIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'unknown';
      }
    }

    function initializeApp() {
      authSystem = new PasswordResetSystem();
      updateCaptcha();
      setupEventListeners();
      
      console.log('✅ Password Reset System initialized');
    }

    function updateCaptcha() {
      if (authSystem && document.getElementById('captcha-text')) {
        document.getElementById('captcha-text').textContent = authSystem.currentCaptcha;
      }
    }

    function setupEventListeners() {
      // Email form submission
      document.getElementById('email-form').addEventListener('submit', handleEmailSubmit);
      
      // OTP verification
      document.getElementById('verify-otp-btn').addEventListener('click', verifyOTP);
      document.getElementById('resend-otp-btn').addEventListener('click', resendOTP);
      
      // Password form submission
      document.getElementById('password-form').addEventListener('submit', handlePasswordReset);
      
      // Back button
      document.getElementById('back-to-email-btn').addEventListener('click', goToStep1);
      
      // CAPTCHA refresh
      document.getElementById('refresh-captcha').addEventListener('click', () => {
        if (authSystem) {
          authSystem.currentCaptcha = authSystem.generateCaptcha();
          updateCaptcha();
          document.getElementById('captcha-input').value = '';
        }
      });
      
      // Password visibility toggle
      document.getElementById('toggle-new-password').addEventListener('click', () => 
        togglePassword('new-password', 'toggle-new-password'));
      document.getElementById('toggle-confirm-password').addEventListener('click', () => 
        togglePassword('confirm-password', 'toggle-confirm-password'));
      
      // Password strength
      document.getElementById('new-password').addEventListener('input', checkPasswordStrength);
      document.getElementById('confirm-password').addEventListener('input', checkPasswordMatch);
      
      // OTP inputs
      document.querySelectorAll('.otp-input').forEach((input, index) => {
        input.addEventListener('input', (e) => handleOTPInput(e, index));
        input.addEventListener('keydown', (e) => handleOTPKeydown(e, index));
      });
      
      // Notification close
      document.getElementById('notification-close').addEventListener('click', hideNotification);
      
      // Auto-hide notification
      setInterval(() => {
        const notification = document.getElementById('notification');
        if (notification.classList.contains('show')) {
          hideNotification();
        }
      }, 5000);
    }

    function showStep(stepNumber) {
      // Hide all step contents
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show selected step content
      document.getElementById(`step-content-${stepNumber}`).classList.add('active');
      
      // Update progress steps
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
          step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
          step.classList.add('active');
        }
      });
    }

    function showSuccess() {
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById('success-content').classList.add('active');
      
      // Mark all steps as completed
      document.querySelectorAll('.step').forEach(step => {
        step.classList.add('completed');
        step.classList.remove('active');
      });
    }

    async function handleEmailSubmit(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const captcha = document.getElementById('captcha-input').value.trim();
      
      let isValid = true;
      
      // Validate email
      if (!email) {
        showError('email', 'Email is required');
        isValid = false;
      } else if (!isValidEmail(email)) {
        showError('email', 'Please enter a valid email');
        isValid = false;
      }
      
      // Validate CAPTCHA
      if (!captcha) {
        showError('captcha', 'CAPTCHA is required');
        isValid = false;
      } else if (captcha !== authSystem.currentCaptcha) {
        showError('captcha', 'Incorrect CAPTCHA');
        authSystem.currentCaptcha = authSystem.generateCaptcha();
        updateCaptcha();
        isValid = false;
      }
      
      if (!isValid) return;
      
      const submitBtn = document.getElementById('send-otp-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
      
      try {
        // Check if email exists
        const emailCheck = await authSystem.checkEmailExists(email);
        if (!emailCheck.exists) {
          throw new Error('Email not found. Please check your email address.');
        }
        
        // Send OTP
        const result = await authSystem.sendResetOTP(email);
        
        // Update UI
        document.getElementById('user-email').textContent = email;
        showStep(2);
        startOTPTimer(300);
        startResendTimer(60);
        
        showNotification(result.message, 'info');
        
      } catch (error) {
        showError('email', error.message);
        authSystem.currentCaptcha = authSystem.generateCaptcha();
        updateCaptcha();
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    async function verifyOTP() {
      const otpInputs = document.querySelectorAll('.otp-input');
      const otp = Array.from(otpInputs).map(input => input.value).join('');
      
      if (otp.length !== 6) {
        showError('otp', 'Please enter the complete 6-digit code');
        return;
      }
      
      const verifyBtn = document.getElementById('verify-otp-btn');
      const originalText = verifyBtn.innerHTML;
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
      
      try {
        const result = await authSystem.verifyResetOTP(otp);
        
        if (result.success) {
          showStep(3);
          clearOTPTimer();
        }
      } catch (error) {
        showError('otp', error.message);
        otpInputs.forEach(input => input.value = '');
        otpInputs[0].focus();
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = originalText;
      }
    }

    async function resendOTP() {
      const resendBtn = document.getElementById('resend-otp-btn');
      if (resendBtn.disabled) return;
      
      const originalText = resendBtn.innerHTML;
      resendBtn.disabled = true;
      resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
      
      try {
        const result = await authSystem.sendResetOTP(authSystem.currentEmail);
        showNotification('New verification code sent!', 'info');
        startOTPTimer(300);
        startResendTimer(60);
      } catch (error) {
        showNotification('Failed to resend OTP: ' + error.message, 'error');
      } finally {
        resendBtn.disabled = false;
        resendBtn.innerHTML = originalText;
      }
    }

    async function handlePasswordReset(e) {
      e.preventDefault();
      
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      let isValid = true;
      
      // Validate password
      if (!newPassword) {
        showError('new-password', 'Password is required');
        isValid = false;
      } else if (!isStrongPassword(newPassword)) {
        showError('new-password', 'Password must be at least 8 characters with uppercase, lowercase, and number');
        isValid = false;
      }
      
      // Validate confirm password
      if (!confirmPassword) {
        showError('confirm-password', 'Please confirm your password');
        isValid = false;
      } else if (newPassword !== confirmPassword) {
        showError('confirm-password', 'Passwords do not match');
        isValid = false;
      }
      
      if (!isValid) return;
      
      const submitBtn = document.getElementById('reset-password-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
      
      try {
        const result = await authSystem.updatePassword(newPassword);
        
        if (result.success) {
          showSuccess();
          showNotification('Password reset successful!', 'success');
          
          // Clear sensitive data
          setTimeout(() => {
            authSystem.currentOTP = '';
            authSystem.currentEmail = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
          }, 3000);
        }
      } catch (error) {
        showNotification('Failed to reset password: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    function goToStep1() {
      showStep(1);
      document.getElementById('captcha-input').value = '';
      authSystem.currentCaptcha = authSystem.generateCaptcha();
      updateCaptcha();
    }

    function startOTPTimer(duration) {
      let timeLeft = duration;
      const timerElement = document.getElementById('otp-timer');
      
      if (authSystem.otpTimer) clearInterval(authSystem.otpTimer);
      
      authSystem.otpTimer = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(authSystem.otpTimer);
          showError('otp', 'Verification code has expired');
          document.getElementById('verify-otp-btn').disabled = true;
        }
      }, 1000);
    }

    function startResendTimer(duration) {
      let timeLeft = duration;
      const resendBtn = document.getElementById('resend-otp-btn');
      const timerElement = document.getElementById('resend-timer');
      
      resendBtn.disabled = true;
      
      if (authSystem.resendTimer) clearInterval(authSystem.resendTimer);
      
      authSystem.resendTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(authSystem.resendTimer);
          resendBtn.disabled = false;
          resendBtn.innerHTML = '<i class="fas fa-redo"></i> Resend Code';
          timerElement.textContent = '';
        }
      }, 1000);
    }

    function clearOTPTimer() {
      if (authSystem.otpTimer) {
        clearInterval(authSystem.otpTimer);
        authSystem.otpTimer = null;
      }
      if (authSystem.resendTimer) {
        clearInterval(authSystem.resendTimer);
        authSystem.resendTimer = null;
      }
    }

    function togglePassword(passwordId, toggleId) {
      const passwordInput = document.getElementById(passwordId);
      const toggleIcon = document.getElementById(toggleId);
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash input-icon';
      } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye input-icon';
      }
    }

    function checkPasswordStrength() {
      const password = document.getElementById('new-password').value;
      const strengthBar = document.getElementById('password-strength-bar');
      const requirements = document.querySelectorAll('.requirement');
      
      const checks = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password)
      };
      
      requirements.forEach(req => {
        const type = req.id.replace('req-', '');
        if (checks[type]) {
          req.classList.add('valid');
          req.classList.remove('invalid');
          req.innerHTML = `<i class="fas fa-check-circle"></i> ${req.textContent.replace('●', '').trim()}`;
        } else {
          req.classList.remove('valid');
          req.classList.add('invalid');
          req.innerHTML = `<i class="fas fa-circle"></i> ${req.textContent.replace('✓', '').trim()}`;
        }
      });
      
      const strength = Object.values(checks).filter(Boolean).length;
      const percent = (strength / 4) * 100;
      
      strengthBar.style.width = `${percent}%`;
      strengthBar.className = 'password-strength-bar';
      
      if (percent <= 25) strengthBar.classList.add('strength-weak');
      else if (percent <= 50) strengthBar.classList.add('strength-fair');
      else if (percent <= 75) strengthBar.classList.add('strength-good');
      else strengthBar.classList.add('strength-strong');
    }

    function checkPasswordMatch() {
      const password = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;
      
      if (!confirm) {
        hideError('confirm-password');
        return;
      }
      
      if (password !== confirm) {
        showError('confirm-password', 'Passwords do not match');
      } else {
        hideError('confirm-password');
      }
    }

    function handleOTPInput(e, index) {
      const input = e.target;
      const value = input.value;
      
      if (!/^\d?$/.test(value)) {
        input.value = '';
        return;
      }
      
      if (value && index < 5) {
        document.querySelector(`.otp-input[data-index="${index + 1}"]`).focus();
      }
      
      if (index === 5 && value) {
        const allFilled = Array.from(document.querySelectorAll('.otp-input'))
          .every(input => input.value);
        if (allFilled) {
          setTimeout(verifyOTP, 100);
        }
      }
    }

    function handleOTPKeydown(e, index) {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        document.querySelector(`.otp-input[data-index="${index - 1}"]`).focus();
      }
    }

    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function isStrongPassword(password) {
      const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password)
      };
      
      return Object.values(requirements).filter(Boolean).length >= 3;
    }

    function showError(field, message) {
      const errorElement = document.getElementById(`${field}-error`);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add('show');
        
        const input = document.getElementById(field);
        if (input) input.classList.add('error');
      }
    }

    function hideError(field) {
      const errorElement = document.getElementById(`${field}-error`);
      if (errorElement) {
        errorElement.classList.remove('show');
        
        const input = document.getElementById(field);
        if (input) input.classList.remove('error');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notification-message');
      
      messageElement.textContent = message;
      notification.className = `notification show`;
      
      if (type === 'success') {
        notification.style.borderLeftColor = '#81c784';
      } else if (type === 'error') {
        notification.style.borderLeftColor = '#e57373';
      } else if (type === 'warning') {
        notification.style.borderLeftColor = '#ffb74d';
      } else {
        notification.style.borderLeftColor = '#4fc3f7';
      }
    }

    function hideNotification() {
      document.getElementById('notification').classList.remove('show');
    }
  </script>
</body>
</html>   
