<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow A Garden – Weather</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #2d3748;
      --accent: #38b2ac;
      --muted: #a0aec0;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    #weather-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      flex: 1;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .card.active {
      animation: rainbow-border 3s linear infinite;
    }

    @keyframes rainbow-border {
      0% { box-shadow: 0 0 8px 2px red; }
      14% { box-shadow: 0 0 8px 2px orange; }
      28% { box-shadow: 0 0 8px 2px yellow; }
      42% { box-shadow: 0 0 8px 2px green; }
      57% { box-shadow: 0 0 8px 2px blue; }
      71% { box-shadow: 0 0 8px 2px indigo; }
      85% { box-shadow: 0 0 8px 2px violet; }
      100% { box-shadow: 0 0 8px 2px red; }
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .card img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-bottom: 0.5rem;
    }

    .card .name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      text-transform: capitalize;
    }

    .card .status {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .card .status.active {
      color: var(--accent);
      font-weight: 600;
    }

    .card .duration {
      font-size: 0.75rem;
      color: var(--muted);
    }

    #next-page-container {
      text-align: center;
      padding: 1.5rem 0;
    }

    .next-button {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: #fff;
      font-weight: 500;
      font-size: 1rem;
      border-radius: var(--radius);
      text-decoration: none;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .next-button:hover {
      background: #319795;
      transform: translateY(-2px);
    }

    .next-button:active {
      transform: translateY(0);
    }

    @media (min-width: 600px) {
      #weather-container {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }

      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <h1>Grow A Garden</h1>
  <div id="weather-container"></div>
  <div id="next-page-container">
    <a href="https://lphisv5.github.io/webv4/growagarden-stock" class="next-button">STOCK</a>
  </div>

  <script>
    const JSTUDIO_KEY = 'js_52f39c0a889f9fc7e0f48880d98dd03ceebf0aada452435cb854596b9270fc00';
    let lastDataHash = '';
    let timers = {};

    // Function to generate a hash from data for comparison
    function generateHash(data) {
      return JSON.stringify(data.weather.map(w => ({
        id: w.weather_id,
        active: w.active,
        icon: w.icon,
        name: w.weather_name,
        duration: w.duration,
        end_duration_unix: w.end_duration_unix
      }))).split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0);
    }

    async function fetchWeather() {
      try {
        const res = await fetch('https://api.joshlei.com/v2/growagarden/weather', {
          headers: {
            'JStudio-key': JSTUDIO_KEY
          }
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        return data;
      } catch (err) {
        console.error('Error fetching weather:', err);
        throw err;
      }
    }

    function updateUI(data) {
      const container = document.getElementById('weather-container');
      container.innerHTML = '';

      Object.values(timers).forEach(clearInterval);
      timers = {};

      data.weather.forEach(w => {
        const card = document.createElement('div');
        card.className = `card ${w.active ? 'active' : ''}`;

        const img = document.createElement('img');
        img.src = w.icon;
        img.alt = w.weather_name;
        card.appendChild(img);

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = w.weather_name;
        card.appendChild(name);

        const status = document.createElement('div');
        status.className = 'status';
        status.textContent = w.active ? 'Active' : 'Inactive';
        if (w.active) status.classList.add('active');
        card.appendChild(status);

        const dur = document.createElement('div');
        dur.className = 'duration';
        if (w.active && w.end_duration_unix > 0) {
          const updateTimer = () => {
            const now = Math.floor(Date.now() / 1000);
            const remaining = w.end_duration_unix - now;
            if (remaining <= 0) {
              clearInterval(timers[w.weather_id]);
              dur.textContent = 'Expired';
            } else {
              dur.textContent = `Time left: ${remaining} sec`;
            }
          };
          updateTimer();
          timers[w.weather_id] = setInterval(updateTimer, 1000);
        } else {
          dur.textContent = `Duration: ${w.duration} sec`;
        }
        card.appendChild(dur);

        container.appendChild(card);
      });

      const activeCard = container.querySelector('.card.active');
      if (activeCard) {
        activeCard.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'nearest'
        });
      }
    }

    async function checkForUpdates(firstUpdate = false) {
      try {
        const data = await fetchWeather();
        const newHash = generateHash(data);

        if (firstUpdate || newHash !== lastDataHash) {
          lastDataHash = newHash;
          updateUI(data);
          console.log('UI updated due to data change');
        } else {
          console.log('No update needed');
        }
      } catch (err) {
        const container = document.getElementById('weather-container');
        container.innerHTML = '<p style="text-align: center; color: #e53e3e;">ไม่สามารถโหลดข้อมูลได้</p>';
      }
    }

    function setupWebSocket() {
      const ws = new WebSocket('wss://api.joshlei.com/v2/growagarden/weather/ws');
      ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({ key: JSTUDIO_KEY }));
      };
      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        const newHash = generateHash(data);
        if (newHash !== lastDataHash) {
          lastDataHash = newHash;
          updateUI(data);
          console.log('UI updated via WebSocket');
        }
      };
      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        startPolling();
      };
      ws.onclose = () => {
        console.log('WebSocket closed, switching to polling');
        startPolling();
      };
    }

    function startPolling() {
      checkForUpdates(true);
      setInterval(() => checkForUpdates(false), 30000);
    }

    window.addEventListener('load', () => {
      if ('WebSocket' in window) {
        setupWebSocket();
      } else {
        startPolling();
      }
    });
  </script>
</body>
</html>
