<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow A Garden – Weather</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #2d3748;
      --accent: #38b2ac;
      --muted: #a0aec0;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .last-updated {
      font-size: 0.85rem;
      color: var(--muted);
      background: var(--card-bg);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--muted);
      padding-bottom: 0.5rem;
    }

    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .nav-tab.active {
      background-color: var(--accent);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .filter-btn {
      background: var(--card-bg);
      border: 1px solid var(--muted);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--muted);
      font-size: 1rem;
    }

    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }

    #weather-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      flex: 1;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .card.active {
      animation: rainbow-border 3s linear infinite;
    }

    @keyframes rainbow-border {
      0% { box-shadow: 0 0 8px 2px red; }
      14% { box-shadow: 0 0 8px 2px orange; }
      28% { box-shadow: 0 0 8px 2px yellow; }
      42% { box-shadow: 0 0 8px 2px green; }
      57% { box-shadow: 0 0 8px 2px blue; }
      71% { box-shadow: 0 0 8px 2px indigo; }
      85% { box-shadow: 0 0 8px 2px violet; }
      100% { box-shadow: 0 0 8px 2px red; }
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .card img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      margin: 0.5rem auto;
    }

    .card .name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      text-transform: capitalize;
    }

    .card .status {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .card .status.active {
      color: var(--success);
      font-weight: 600;
    }

    .card .status.inactive {
      color: var(--muted);
    }

    .card .duration {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: auto;
    }

    .card .countdown {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-top: 0.5rem;
    }

    .card .countdown.expired {
      color: var(--danger);
    }

    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      grid-column: 1 / -1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-left-color: var(--accent);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #next-page-container {
      text-align: center;
      padding: 1.5rem 0;
      margin-top: 1rem;
    }

    .next-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: #fff;
      font-weight: 500;
      font-size: 1rem;
      border-radius: var(--radius);
      text-decoration: none;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .next-button:hover {
      background: #319795;
      transform: translateY(-2px);
    }

    .next-button:active {
      transform: translateY(0);
    }

    .connection-status {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .connection-status.connected {
      background: var(--success);
      color: white;
    }

    .connection-status.disconnected {
      background: var(--danger);
      color: white;
    }

    /* Webhook Configuration Styles */
    .webhook-config {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .webhook-config h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .webhook-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .webhook-input input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--muted);
      font-size: 1rem;
    }

    .webhook-input button {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
    }

    .webhook-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
    }

    .btn-edit {
      background: var(--warning);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
    }

    .test-notification {
      background: var(--warning);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    .notification-history {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-history h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .notification-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--muted);
      font-size: 0.9rem;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-success {
      color: var(--success);
    }

    .notification-error {
      color: var(--danger);
    }

    @media (min-width: 600px) {
      #weather-container {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }

      h1 {
        font-size: 2rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 1rem;
      }
      
      header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls {
        justify-content: center;
      }

      .webhook-input {
        flex-direction: column;
      }

      .webhook-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-cloud-sun"></i> Grow A Garden Weather</h1>
    <div class="last-updated" id="last-updated">Last updated: <span id="update-time">-</span></div>
  </header>

  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="weather">Weather</div>
    <div class="nav-tab" data-tab="notifications">Notifications</div>
  </div>

  <!-- Weather Tab -->
  <div id="weather-tab" class="tab-content active">
    <div class="controls">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="active">Active</button>
      <button class="filter-btn" data-filter="inactive">Inactive</button>
    </div>

    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="Search weather...">
    </div>

    <div id="weather-container">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="next-page-container">
      <a href="https://lphisv5.github.io/v4/growagarden-stock" class="next-button">
        <i class="fas fa-seedling"></i> STOCK
      </a>
    </div>
  </div>

  <!-- Notifications Tab -->
  <div id="notifications-tab" class="tab-content">
    <div class="webhook-config">
      <h2><i class="fas fa-bell"></i> Discord Webhook Configuration</h2>
      <div class="webhook-input">
        <input type="text" id="webhook-url" placeholder="Enter Discord Webhook URL">
        <button id="save-webhook">Save</button>
      </div>
      
      <div class="webhook-actions">
        <button id="edit-webhook" class="btn-edit">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button id="delete-webhook" class="btn-delete">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
      
      <button id="test-webhook" class="test-notification">
        <i class="fas fa-paper-plane"></i> Send Test Notification
      </button>
    </div>

    <div class="notification-history">
      <h2><i class="fas fa-history"></i> Notification History</h2>
      <div id="notification-list">
        <div class="notification-item">No notifications sent yet</div>
      </div>
    </div>
  </div>

  <div id="connection-status" class="connection-status disconnected">
    <i class="fas fa-wifi"></i> <span>Disconnected</span>
  </div>

  <script>
    const JSTUDIO_KEY = 'js_52f39c0a889f9fc7e0f48880d98dd03ceebf0aada452435cb854596b9270fc00';
    
    let lastDataHash = '';
    let timers = {};
    let currentFilter = 'all';
    let searchQuery = '';
    let weatherData = [];
    let timeUpdateInterval;
    let webhookUrl = '';
    let notificationHistory = [];
    let previousActiveWeather = {};
    let isEditing = false;

    function initializeApp() {
      const savedWebhook = localStorage.getItem('gag_webhook_url');
      webhookUrl = savedWebhook || '';
      
      document.getElementById('webhook-url').value = '';
      
      const savedHistory = localStorage.getItem('gag_notification_history');
      if (savedHistory) {
        notificationHistory = JSON.parse(savedHistory);
        updateNotificationHistoryUI();
      }
      
      const savedActiveWeather = localStorage.getItem('gag_previous_active_weather');
      if (savedActiveWeather) {
        previousActiveWeather = JSON.parse(savedActiveWeather);
      }
      
      updateWebhookUI();
    }

    function updateWebhookUI() {
      const webhookInput = document.getElementById('webhook-url');
      const saveBtn = document.getElementById('save-webhook');
      const editBtn = document.getElementById('edit-webhook');
      const deleteBtn = document.getElementById('delete-webhook');
      
      if (webhookUrl) {
        webhookInput.value = '••••••••••••••••••••••••••••••';
        webhookInput.disabled = true;
        saveBtn.style.display = 'none';
        editBtn.style.display = 'block';
        deleteBtn.style.display = 'block';
      } else {
        webhookInput.value = '';
        webhookInput.disabled = false;
        webhookInput.placeholder = 'Enter Discord Webhook URL';
        saveBtn.style.display = 'block';
        editBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
      }
    }

    function saveWebhookUrl(url) {
      if (!url) {
        addNotification('Please enter a valid webhook URL', false);
        return;
      }
      
      webhookUrl = url;
      localStorage.setItem('gag_webhook_url', url);
      updateWebhookUI();
      addNotification('Webhook URL saved successfully', true);
    }

    function editWebhookUrl() {
      const webhookInput = document.getElementById('webhook-url');
      webhookInput.value = webhookUrl;
      webhookInput.disabled = false;
      webhookInput.focus();
      
      document.getElementById('save-webhook').style.display = 'block';
      document.getElementById('edit-webhook').style.display = 'none';
      isEditing = true;
    }

    function deleteWebhookUrl() {
      if (confirm('Are you sure you want to delete the webhook URL?')) {
        webhookUrl = '';
        localStorage.removeItem('gag_webhook_url');
        updateWebhookUI();
        addNotification('Webhook URL deleted', true);
      }
    }

    function addNotification(message, success = true) {
      const timestamp = new Date().toLocaleString();
      notificationHistory.unshift({
        message,
        success,
        timestamp
      });
      
      if (notificationHistory.length > 50) {
        notificationHistory.pop();
      }
      
      localStorage.setItem('gag_notification_history', JSON.stringify(notificationHistory));
      
      updateNotificationHistoryUI();
    }

    function updateNotificationHistoryUI() {
      const container = document.getElementById('notification-list');
      
      if (notificationHistory.length === 0) {
        container.innerHTML = '<div class="notification-item">No notifications sent yet</div>';
        return;
      }
      
      container.innerHTML = '';
      notificationHistory.forEach(notif => {
        const item = document.createElement('div');
        item.className = `notification-item ${notif.success ? 'notification-success' : 'notification-error'}`;
        item.innerHTML = `<strong>[${notif.timestamp}]</strong> ${notif.message}`;
        container.appendChild(item);
      });
    }

    async function sendDiscordNotification(weather, isStart) {
      if (!webhookUrl) {
        addNotification('Webhook URL not configured', false);
        return false;
      }
      
      try {
        const now = Math.floor(Date.now() / 1000);
        const endsIn = weather.end_duration_unix - now;
        const endsInMinutes = Math.max(1, Math.ceil(endsIn / 60));
        
        const embed = {
          title: `YANZ - lphisv5.github.io/v4/ • discord.gg/mNGeUVcjKB`,
          description: `**${weather.weather_name} ${isStart ? 'Started' : 'Ended'}**`,
          color: isStart ? 0x00ff00 : 0xff0000,
          thumbnail: {
            url: weather.icon
          },
          fields: [],
          footer: {
            text: "Grow A Garden Weather Notifications"
          },
          timestamp: new Date().toISOString()
        };
        
        if (isStart) {
          embed.fields.push(
            {
              name: "ชื่อสภาพอากาศที่ทำงานอยู่",
              value: weather.weather_name,
              inline: false
            },
            {
              name: "Ends",
              value: `อีก ${endsInMinutes} นาที`,
              inline: true
            },
            {
              name: "Duration",
              value: `${Math.floor(weather.duration / 60)} minutes`,
              inline: true
            }
          );
        } else {
          embed.fields.push(
            {
              name: "สถานะ",
              value: "หยุดทำงานแล้ว",
              inline: false
            }
          );
        }
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            embeds: [embed]
          })
        });
        
        if (response.ok) {
          addNotification(`Sent notification: ${weather.weather_name} ${isStart ? 'started' : 'ended'}`);
          return true;
        } else {
          addNotification(`Failed to send notification: HTTP ${response.status}`, false);
          return false;
        }
      } catch (error) {
        console.error('Error sending Discord notification:', error);
        addNotification(`Error sending notification: ${error.message}`, false);
        return false;
      }
    }

    function checkForWeatherChanges(newWeatherData) {
      if (!newWeatherData || !newWeatherData.weather) return;
      
      const currentActiveWeather = {};
      
      newWeatherData.weather.forEach(w => {
        if (w.active) {
          currentActiveWeather[w.weather_id] = true;
          
          if (!previousActiveWeather[w.weather_id]) {
            sendDiscordNotification(w, true);
          }
        }
      });
      
      Object.keys(previousActiveWeather).forEach(id => {
        if (!currentActiveWeather[id]) {
          const endedWeather = newWeatherData.weather.find(w => w.weather_id === id);
          if (endedWeather) {
            sendDiscordNotification(endedWeather, false);
          }
        }
      });
      
      previousActiveWeather = currentActiveWeather;
      localStorage.setItem('gag_previous_active_weather', JSON.stringify(previousActiveWeather));
    }

    function generateHash(data) {
      if (!data || !data.weather || !Array.isArray(data.weather)) {
        console.warn('Invalid or missing weather data:', data);
        return '';
      }
      return JSON.stringify(data.weather.map(w => ({
        id: w.weather_id,
        active: w.active,
        icon: w.icon,
        name: w.weather_name,
        duration: w.duration,
        end_duration_unix: w.end_duration_unix
      }))).split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0);
    }

    function updateLastUpdated() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}:${seconds}`;
      document.getElementById('update-time').textContent = timeString;
    }

    function startRealTimeClock() {
      updateLastUpdated();
      timeUpdateInterval = setInterval(updateLastUpdated, 1000);
    }

    function stopRealTimeClock() {
      if (timeUpdateInterval) {
        clearInterval(timeUpdateInterval);
      }
    }

    async function fetchWeather() {
      try {
        const res = await fetch('https://api.joshlei.com/v2/growagarden/weather', {
          headers: {
            'JStudio-key': JSTUDIO_KEY
          }
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        if (!data || !data.weather || !Array.isArray(data.weather)) {
          throw new Error('Invalid API response structure');
        }
        return data;
      } catch (err) {
        console.error('Error fetching weather:', err);
        throw err;
      }
    }

    function updateUI(data) {
      if (!data || !data.weather) {
        console.warn('No valid weather data to update UI');
        return;
      }
      
      checkForWeatherChanges(data);
      
      weatherData = data.weather;
      applyFilters();
      updateLastUpdated();
    }

    function applyFilters() {
      const container = document.getElementById('weather-container');
      
      Object.values(timers).forEach(timer => clearInterval(timer));
      timers = {};
      
      let filteredData = weatherData;
      
      if (currentFilter === 'active') {
        filteredData = filteredData.filter(w => w.active);
      } else if (currentFilter === 'inactive') {
        filteredData = filteredData.filter(w => !w.active);
      }
      
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filteredData = filteredData.filter(w => 
          w.weather_name && w.weather_name.toLowerCase().includes(query)
        );
      }
      
      if (filteredData.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-cloud" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h3>No weather conditions found</h3>
            <p>Try adjusting your search or filter</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      filteredData.forEach(w => {
        const card = document.createElement('div');
        card.className = `card ${w.active ? 'active' : ''}`;
        card.dataset.id = w.weather_id;

        const img = document.createElement('img');
        img.src = w.icon || 'https://via.placeholder.com/64';
        img.alt = w.weather_name || 'Weather';
        card.appendChild(img);

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = w.weather_name || 'Unknown';
        card.appendChild(name);

        const status = document.createElement('div');
        status.className = `status ${w.active ? 'active' : 'inactive'}`;
        status.innerHTML = w.active 
          ? '<i class="fas fa-check-circle"></i> Active' 
          : '<i class="fas fa-times-circle"></i> Inactive';
        card.appendChild(status);

        const dur = document.createElement('div');
        dur.className = 'duration';
        dur.textContent = `Duration: ${w.duration || 0} sec`;
        card.appendChild(dur);

        if (w.active && w.end_duration_unix > 0) {
          const countdown = document.createElement('div');
          countdown.className = 'countdown';
          
          const updateTimer = () => {
            const now = Math.floor(Date.now() / 1000);
            const remaining = w.end_duration_unix - now;
            
            if (remaining <= 0) {
              clearInterval(timers[w.weather_id]);
              countdown.textContent = 'Expired';
              countdown.className = 'countdown expired';
              status.innerHTML = '<i class="fas fa-times-circle"></i> Inactive';
              status.className = 'status inactive';
              card.classList.remove('active');
            } else {
              const minutes = Math.floor(remaining / 60);
              const seconds = remaining % 60;
              
              countdown.textContent = `Ends in: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
              
              if (remaining < 30) {
                countdown.className = 'countdown expired';
              } else {
                countdown.className = 'countdown';
              }
            }
          };
          
          updateTimer();
          timers[w.weather_id] = setInterval(updateTimer, 1000);
          card.appendChild(countdown);
        }

        container.appendChild(card);
      });

      const activeCard = container.querySelector('.card.active');
      if (activeCard) {
        activeCard.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'nearest'
        });
      }
    }

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connection-status');
      if (connected) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = '<i class="fas fa-wifi"></i> <span>Connected</span>';
      } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> <span>Disconnected</span>';
      }
    }

    async function checkForUpdates(firstUpdate = false) {
      try {
        const data = await fetchWeather();
        const newHash = generateHash(data);

        if (firstUpdate || newHash !== lastDataHash) {
          lastDataHash = newHash;
          updateUI(data);
          console.log('UI updated due to data change');
        } else {
          console.log('No update needed');
        }
        
        updateConnectionStatus(true);
      } catch (err) {
        const container = document.getElementById('weather-container');
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load weather data</p>
          </div>`;
        updateConnectionStatus(false);
      }
    }

    function setupWebSocket() {
      const ws = new WebSocket('wss://api.joshlei.com/v2/growagarden/weather/ws');
      
      ws.onopen = () => {
        console.log('WebSocket connected');
        ws.send(JSON.stringify({ key: JSTUDIO_KEY }));
        updateConnectionStatus(true);
      };
      
      ws.onmessage = async (event) => {
        try {
          console.log('WebSocket data:', event.data);
          const data = JSON.parse(event.data);
          if (!data || !data.weather || !Array.isArray(data.weather)) {
            throw new Error('Invalid WebSocket data structure');
          }
          const newHash = generateHash(data);
          
          if (newHash !== lastDataHash) {
            lastDataHash = newHash;
            weatherData = data.weather;
            applyFilters();
            updateLastUpdated();
            console.log('UI updated via WebSocket');
          }
          
          updateConnectionStatus(true);
        } catch (err) {
          console.error('Error processing WebSocket message:', err);
          updateConnectionStatus(false);
        }
      };
      
      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        updateConnectionStatus(false);
        startPolling();
      };
      
      ws.onclose = () => {
        console.log('WebSocket closed, switching to polling');
        updateConnectionStatus(false);
        startPolling();
      };
      
      return ws;
    }

    function startPolling() {
      checkForUpdates(true);
      return setInterval(() => checkForUpdates(false), 30000);
    }

    async function sendTestNotification() {
      if (!webhookUrl) {
        addNotification('Please set a webhook URL first', false);
        return;
      }
      
      try {
        const testWeather = {
          weather_name: 'Test Weather',
          icon: 'https://cdn3.emoji.gg/emojis/5128-weather-sunny.png',
          active: true,
          duration: 300,
          end_duration_unix: Math.floor(Date.now() / 1000) + 300,
          weather_id: 'test'
        };
        
        const success = await sendDiscordNotification(testWeather, true);
        
        if (success) {
          addNotification('Test notification sent successfully');
        }
      } catch (error) {
        console.error('Error sending test notification:', error);
        addNotification(`Error sending test: ${error.message}`, false);
      }
    }

    window.addEventListener('load', () => {
      initializeApp();
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
      
      document.getElementById('save-webhook').addEventListener('click', () => {
        const url = document.getElementById('webhook-url').value.trim();
        saveWebhookUrl(url);
      });
      
      document.getElementById('edit-webhook').addEventListener('click', editWebhookUrl);
      
      document.getElementById('delete-webhook').addEventListener('click', deleteWebhookUrl);
      
      document.getElementById('test-webhook').addEventListener('click', sendTestNotification);
      
      startRealTimeClock();
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          applyFilters();
        });
      });
      
      document.getElementById('search-input').addEventListener('input', (e) => {
        searchQuery = e.target.value;
        applyFilters();
      });
      
      let pollingInterval;
      let ws;
      
      if ('WebSocket' in window) {
        ws = setupWebSocket();
      } else {
        pollingInterval = startPolling();
      }
      
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopRealTimeClock();
          if (ws) {
            ws.close();
          }
          if (pollingInterval) {
            clearInterval(pollingInterval);
          }
        } else {
          startRealTimeClock();
          if ('WebSocket' in window) {
            ws = setupWebSocket();
          } else {
            pollingInterval = startPolling();
          }
        }
      });
    });
  </script>
</body>
</html>
