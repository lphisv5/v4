<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YANZ - Anime Clash</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff4d89;
      --secondary: #6a5acd;
      --dark: #1a1a2e;
      --darker: #121212;
      --light: #f8f9fa;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --radius: 12px;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--darker);
      color: var(--light);
      font-family: 'Poppins', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Auth Screen */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 40px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.5s ease-out;
    }

    .logo {
      font-size: 3.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .tagline {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 300;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255, 255, 255, 0.8);
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      background: rgba(0, 0, 0, 0.3);
      color: var(--light);
      font-size: 1rem;
      transition: var(--transition);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 77, 137, 0.2);
    }

    .input-field:invalid {
      border-color: var(--danger);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--light);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .auth-footer {
      margin-top: 30px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
    }

    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .auth-footer a:hover {
      text-decoration: underline;
    }

    .alert {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background: rgba(40, 167, 69, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .alert-error {
      background: rgba(220, 53, 69, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .app-alert {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 1200px;
      margin: 20px auto;
    }

    /* App Screen */
    .app-container {
      display: none;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      font-size: 1.8rem;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }

    .username {
      font-weight: 500;
    }

    .sign-out-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px 10px;
      border-radius: var(--radius);
    }

    .sign-out-btn:hover {
      color: var(--primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .select-wrapper {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .select-wrapper::after {
      content: '‚ñº';
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      color: var(--light);
      pointer-events: none;
      font-size: 0.8rem;
    }

    .select-field {
      width: 100%;
      padding: 12px 15px;
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      background: rgba(0, 0, 0, 0.3);
      color: var(--light);
      font-size: 1rem;
      cursor: pointer;
    }

    .select-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 77, 137, 0.2);
    }

    .battle-arena {
      position: relative;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
      min-height: 500px;
    }

    .anime-card {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
      aspect-ratio: 2/3;
    }

    .anime-card:hover {
      transform: translateY(-5px) scale(1.02);
    }

    .anime-card.selected {
      box-shadow: 0 0 0 3px var(--primary), 0 0 20px rgba(255, 77, 137, 0.5);
    }

    .anime-card.winner::after {
      content: 'üèÜ';
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 30px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      z-index: 5;
    }

    .anime-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .anime-image.loaded {
      opacity: 1;
    }

    .anime-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
    }

    .anime-title {
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .anime-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      grid-column: 1 / -1;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .leaderboard-list {
      list-style: none;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
    }

    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .rank {
      font-weight: 700;
      color: var(--primary);
      min-width: 30px;
    }

    .anime-name {
      flex: 1;
      margin: 0 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .score {
      background: rgba(255, 77, 137, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: 500;
    }

    .comment-form {
      margin-bottom: 20px;
    }

    .comment-box {
      width: 100%;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      background: rgba(0, 0, 0, 0.3);
      color: var(--light);
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 15px;
      min-height: 100px;
      max-height: 200px;
    }

    .comment-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 77, 137, 0.2);
    }

    .comment-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }

    .comment-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 1rem;
      font-weight: bold;
      color: white;
    }

    .comment-user {
      font-weight: 500;
    }

    .comment-anime {
      font-size: 0.8rem;
      color: var(--primary);
      margin-left: 10px;
    }

    .comment-text {
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .comment-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .reward-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reward-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .reward-card.unlocked {
      border-color: var(--success);
      background: rgba(40, 167, 69, 0.1);
    }

    .reward-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .reward-name {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .reward-price {
      display: inline-block;
      background: rgba(255, 215, 0, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      margin-bottom: 15px;
      color: gold;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .history-anime {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .history-date {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .hidden {
      display: none !important;
    }

    .vs-badge {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 2rem;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 50%;
      z-index: 10;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      animation: pulse 2s infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { transform: scale(1) translate(-50%, -50%); }
      50% { transform: scale(1.05) translate(-50%, -50%); }
      100% { transform: scale(1) translate(-50%, -50%); }
    }

    @media (max-width: 768px) {
      .auth-box {
        padding: 30px 20px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .battle-arena {
        grid-template-columns: 1fr;
        min-height: 600px;
      }
      
      .vs-badge {
        font-size: 1.5rem;
        width: 60px;
        height: 60px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .rewards-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="authScreen" class="auth-container">
    <div class="auth-box">
      <div class="logo">YANZ - Anime Clash</div>
      <div class="tagline">Battle with your favorite anime characters and choose the ultimate champion!</div>
      
      <div id="authAlert" class="alert hidden"></div>
      
      <div id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password" required minlength="6">
        </div>
        <div class="btn-group">
          <button id="loginBtn" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> Log In
          </button>
          <button id="showRegisterBtn" class="btn btn-outline">
            <i class="fas fa-user-plus"></i> Create Account
          </button>
        </div>
      </div>
      
      <div id="registerForm" class="hidden">
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" class="input-field" placeholder="Create a password" required minlength="6">
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm your password" required minlength="6">
        </div>
        <div class="btn-group">
          <button id="registerBtn" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Sign Up
          </button>
          <button id="showLoginBtn" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Login
          </button>
        </div>
      </div>
      
      <div class="auth-footer">
        By continuing, you agree to our <a href="#" onclick="alert('Terms of Service: This is a demo app. All rights reserved.')">Terms of Service</a> and <a href="#" onclick="alert('Privacy Policy: User data is stored securely in Firebase.')">Privacy Policy</a>
      </div>
    </div>
  </div>

  <!-- App Screen -->
  <div id="appScreen" class="app-container">
    <div class="container">
      <div id="appAlert" class="app-alert hidden"></div>
      <header>
        <div class="header-left">
          <div class="header-logo">YANZ - Anime Clash</div>
        </div>
        <div class="user-profile">
          <div class="avatar" id="userAvatar">U</div>
          <div>
            <div class="username" id="username">User</div>
            <button class="sign-out-btn" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
          </div>
        </div>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="coins">0</div>
          <div class="stat-label">Coins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="battles">0</div>
          <div class="stat-label">Battles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="wins">0</div>
          <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="streak">0</div>
          <div class="stat-label">Win Streak</div>
        </div>
      </div>

      <div class="filter-bar">
        <div class="select-wrapper">
          <select id="genreSelect" class="select-field">
            <option value="">All Genres</option>
            <option value="1">Action</option>
            <option value="2">Adventure</option>
            <option value="4">Comedy</option>
            <option value="10">Fantasy</option>
            <option value="22">Romance</option>
            <option value="27">Shounen</option>
            <option value="25">Shoujo</option>
            <option value="37">Supernatural</option>
            <option value="30">Sports</option>
            <option value="62">Isekai</option>
          </select>
        </div>
        <button id="newBattleBtn" class="btn btn-primary">
          <i class="fas fa-random"></i> New Battle
        </button>
        <button id="shareBtn" class="btn btn-outline hidden">
          <i class="fas fa-share-alt"></i> Share
        </button>
      </div>

      <div id="battleArena" class="battle-arena">
        <div class="loader">
          <div class="spinner"></div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-trophy"></i> Your Leaderboard</h3>
        <ul id="leaderboardList" class="leaderboard-list">
          <!-- Leaderboard items will be inserted here -->
        </ul>
      </div>

      <div id="commentSection" class="section hidden">
        <h3 class="section-title"><i class="fas fa-comments"></i> Community Comments</h3>
        <div class="comment-form">
          <textarea id="commentBox" class="comment-box" placeholder="Why did you choose this anime? Share your thoughts! (Max 500 chars)"></textarea>
          <button id="submitCommentBtn" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Post Comment
          </button>
        </div>
        <div id="commentsContainer">
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-gift"></i> Rewards Shop</h3>
        <div class="rewards-grid">
          <div class="reward-card" data-reward="Custom Theme" data-cost="50">
            <div class="reward-icon"><i class="fas fa-palette"></i></div>
            <div class="reward-name">Custom Theme</div>
            <div class="reward-price">50 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
          <div class="reward-card" data-reward="Premium Badge" data-cost="100">
            <div class="reward-icon"><i class="fas fa-id-badge"></i></div>
            <div class="reward-name">Premium Badge</div>
            <div class="reward-price">100 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
          <div class="reward-card" data-reward="Special Avatar" data-cost="150">
            <div class="reward-icon"><i class="fas fa-user-astronaut"></i></div>
            <div class="reward-name">Special Avatar</div>
            <div class="reward-price">150 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
          <div class="reward-card" data-reward="Ad-Free Mode" data-cost="200">
            <div class="reward-icon"><i class="fas fa-ad"></i></div>
            <div class="reward-name">Ad-Free Mode</div>
            <div class="reward-price">200 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
          <div class="reward-card" data-reward="Coin Booster" data-cost="250">
            <div class="reward-icon"><i class="fas fa-coins"></i></div>
            <div class="reward-name">Coin Booster</div>
            <div class="reward-price">250 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
          <div class="reward-card" data-reward="Exclusive Emojis" data-cost="300">
            <div class="reward-icon"><i class="fas fa-smile"></i></div>
            <div class="reward-name">Exclusive Emojis</div>
            <div class="reward-price">300 Coins</div>
            <button class="btn btn-outline unlock-btn">
              <i class="fas fa-unlock"></i> Unlock
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-history"></i> Battle History (Last 10)</h3>
        <div id="historyList">
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // Firebase imports and configuration
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCXhQjlhxwoucAPNSqAzF3bXhSulijEELo",
    authDomain: "anime-be8d4.firebaseapp.com",
    projectId: "anime-be8d4",
    storageBucket: "anime-be8d4.firebasestorage.app",
    messagingSenderId: "794531180479",
    appId: "1:794531180479:web:6ee28da415c3f729a47b0a",
    measurementId: "G-F57EW6BTBQ"
  };

  // Global variables
  let app, auth, db;
  let currentUser = null;
  let userData = {
    coins: 0,
    battles: 0,
    wins: 0,
    streak: 0,
    leaderboard: {},
    comments: [],
    history: [],
    unlockedRewards: []
  };
  let selectedAnime = null;
  let battleAnimes = [];

  // DOM element cache for performance - queried after DOM load to prevent null errors
  let elements = {};

  /**
   * Queries all DOM elements after ensuring DOM is loaded.
   * Prevents "Cannot read properties of null" errors by guaranteeing elements exist.
   */
  function queryElements() {
    elements = {
      authScreen: document.getElementById('authScreen'),
      appScreen: document.getElementById('appScreen'),
      authAlert: document.getElementById('authAlert'),
      appAlert: document.getElementById('appAlert'),
      loginForm: document.getElementById('loginForm'),
      registerForm: document.getElementById('registerForm'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      registerEmail: document.getElementById('registerEmail'),
      registerPassword: document.getElementById('registerPassword'),
      confirmPassword: document.getElementById('confirmPassword'),
      userAvatar: document.getElementById('userAvatar'),
      username: document.getElementById('username'),
      coins: document.getElementById('coins'),
      battles: document.getElementById('battles'),
      wins: document.getElementById('wins'),
      streak: document.getElementById('streak'),
      battleArena: document.getElementById('battleArena'),
      leaderboardList: document.getElementById('leaderboardList'),
      commentsContainer: document.getElementById('commentsContainer'),
      commentSection: document.getElementById('commentSection'),
      commentBox: document.getElementById('commentBox'),
      shareBtn: document.getElementById('shareBtn'),
      historyList: document.getElementById('historyList'),
      genreSelect: document.getElementById('genreSelect'),
      loginBtn: document.getElementById('loginBtn'),
      registerBtn: document.getElementById('registerBtn'),
      showRegisterBtn: document.getElementById('showRegisterBtn'),
      showLoginBtn: document.getElementById('showLoginBtn'),
      newBattleBtn: document.getElementById('newBattleBtn'),
      submitCommentBtn: document.getElementById('submitCommentBtn'),
      logoutBtn: document.getElementById('logoutBtn')
    };

    // Log if any critical element is missing
    const missing = Object.entries(elements).filter(([key, el]) => !el && key !== 'authAlert' && key !== 'appAlert').map(([key]) => key);
    if (missing.length > 0) {
      console.error('Missing DOM elements:', missing);
    }
  }

  /**
   * Initializes Firebase app, auth, and Firestore with offline persistence.
   * Handles initialization errors gracefully.
   */
  function initializeFirebase() {
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      
      enableIndexedDbPersistence(db)
        .catch((err) => {
          if (err.code === 'failed-precondition') {
            console.warn('Offline persistence can only be enabled in one tab at a time.');
          } else if (err.code === 'unimplemented') {
            console.warn('The current browser doesn\'t support offline persistence.');
          } else {
            console.error('Persistence error:', err);
          }
        });
      
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      showAlert('Failed to initialize Firebase. Please check your connection and try again.', 'error', true); // true for app alert if available
      throw error; // Re-throw to prevent app init
    }
  }

  /**
   * Sets up all event listeners for buttons and forms.
   * Uses optional chaining for safety and only after elements are queried.
   */
  function setupEventListeners() {
    elements.loginBtn?.addEventListener('click', handleLogin);
    elements.registerBtn?.addEventListener('click', handleRegister);
    elements.showRegisterBtn?.addEventListener('click', showRegisterForm);
    elements.showLoginBtn?.addEventListener('click', showLoginForm);
    elements.newBattleBtn?.addEventListener('click', loadBattle);
    elements.submitCommentBtn?.addEventListener('click', submitComment);
    elements.shareBtn?.addEventListener('click', shareBattle);
    elements.logoutBtn?.addEventListener('click', handleLogout);
    elements.genreSelect?.addEventListener('change', loadBattle); // Auto-load on genre change for better UX

    // Delegate reward unlocks for dynamic elements
    elements.appScreen?.addEventListener('click', (e) => {
      if (e.target.classList?.contains('unlock-btn')) {
        const card = e.target.closest('.reward-card');
        if (card) {
          const reward = card.dataset.reward;
          const cost = parseInt(card.dataset.cost);
          unlockReward(reward, cost);
        }
      }
    });

    // Enter key support for forms
    elements.loginPassword?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
    elements.registerPassword?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
    elements.confirmPassword?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
    elements.commentBox?.addEventListener('keypress', (e) => { if (e.key === 'Enter' && e.ctrlKey) submitComment(); });
  }

  /**
   * Initializes the application: DOM query, Firebase, auth listener, and event listeners.
   * Ensures DOM is fully loaded before querying elements.
   */
  async function init() {
    // Ensure DOM is loaded before querying elements
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        queryElements();
        initializeAppCore();
      });
    } else {
      queryElements();
      initializeAppCore();
    }
  }

  function initializeAppCore() {
    try {
      initializeFirebase();
      setupEventListeners();

      onAuthStateChanged(auth, async (user) => {
        console.log('Auth state changed:', user ? `User ${user.uid} logged in` : 'No user');
        currentUser = user;
        if (user) {
          await loadUserData();
          showAppScreen();
        } else {
          showAuthScreen();
        }
      });
    } catch (error) {
      console.error('App initialization failed:', error);
      showAlert('Application failed to start. Please refresh the page.', 'error', true);
    }
  }

  /**
   * Displays the authentication screen and shows the login form by default.
   */
  function showAuthScreen() {
    if (!elements.authScreen || !elements.appScreen) return;
    elements.authScreen.style.display = 'flex';
    elements.appScreen.style.display = 'none';
    showLoginForm();
  }

  /**
   * Displays the main app screen, updates profile, and loads initial battle.
   */
  function showAppScreen() {
    if (!elements.authScreen || !elements.appScreen) return;
    elements.authScreen.style.display = 'none';
    elements.appScreen.style.display = 'block';
    updateUserProfile();
    loadBattle(); // Load initial battle for immediate engagement
  }

  /**
   * Shows the login form and hides the register form.
   */
  function showLoginForm() {
    if (elements.loginForm) elements.loginForm.classList.remove('hidden');
    if (elements.registerForm) elements.registerForm.classList.add('hidden');
    hideAlert(false);
    elements.loginEmail?.focus();
  }

  /**
   * Shows the register form and hides the login form.
   */
  function showRegisterForm() {
    if (elements.loginForm) elements.loginForm.classList.add('hidden');
    if (elements.registerForm) elements.registerForm.classList.remove('hidden');
    hideAlert(false);
    elements.registerEmail?.focus();
  }

  /**
   * Displays an alert message with type (success/error) and auto-hides success after 3s.
   * Supports auth or app alert based on isApp flag.
   * @param {string} message - The message to display.
   * @param {string} type - 'success' or 'error'.
   * @param {boolean} isApp - Use app alert if true (default false for auth).
   */
  function showAlert(message, type, isApp = false) {
    const alertEl = isApp ? elements.appAlert : elements.authAlert;
    if (!alertEl) {
      console.warn('Alert element not found, logging message:', message);
      return;
    }
    alertEl.textContent = message;
    alertEl.className = `alert alert-${type} ${isApp ? 'app-alert' : ''}`;
    alertEl.classList.remove('hidden');
    if (type === 'success') {
      setTimeout(() => hideAlert(isApp), 3000);
    }
  }

  /**
   * Hides the alert message.
   * @param {boolean} isApp - Hide app alert if true.
   */
  function hideAlert(isApp = false) {
    const alertEl = isApp ? elements.appAlert : elements.authAlert;
    if (alertEl) alertEl.classList.add('hidden');
  }

  /**
   * Handles user login with email/password.
   * Includes validation, loading state, and error handling.
   */
  async function handleLogin() {
    const email = elements.loginEmail?.value.trim();
    const password = elements.loginPassword?.value.trim();
    
    if (!email || !password) {
      showAlert('Please enter both email and password.', 'error');
      return;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showAlert('Please enter a valid email address.', 'error');
      return;
    }
    
    const btn = elements.loginBtn;
    if (!btn) return;
    try {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging In...';
      hideAlert(false);
      
      await signInWithEmailAndPassword(auth, email, password);
      console.log('Login successful');
      // Alert not needed as screen switches automatically
    } catch (error) {
      console.error('Login error:', error);
      showAlert(getAuthErrorMessage(error), 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Log In';
    }
  }

  /**
   * Handles user registration with email/password.
   * Includes validation for passwords and email.
   */
  async function handleRegister() {
    const email = elements.registerEmail?.value.trim();
    const password = elements.registerPassword?.value.trim();
    const confirm = elements.confirmPassword?.value.trim();
    
    if (!email || !password || !confirm) {
      showAlert('Please fill in all fields.', 'error');
      return;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showAlert('Please enter a valid email address.', 'error');
      return;
    }
    
    if (password !== confirm) {
      showAlert('Passwords do not match.', 'error');
      if (elements.confirmPassword) elements.confirmPassword.value = '';
      return;
    }
    
    if (password.length < 6) {
      showAlert('Password must be at least 6 characters long.', 'error');
      return;
    }
    
    const btn = elements.registerBtn;
    if (!btn) return;
    try {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing Up...';
      hideAlert(false);
      
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      console.log('Registration successful');
      
      // Initialize user data in Firestore
      await setDoc(doc(db, 'users', userCredential.user.uid), {
        coins: 100, // Starter coins for new users
        battles: 0,
        wins: 0,
        streak: 0,
        leaderboard: {},
        comments: [],
        history: [],
        unlockedRewards: []
      });
      
      showAlert('Account created! Redirecting to app...', 'success');
      // Clear forms
      if (elements.registerEmail) elements.registerEmail.value = '';
      if (elements.registerPassword) elements.registerPassword.value = '';
      if (elements.confirmPassword) elements.confirmPassword.value = '';
      // Screen switch handled by auth listener
    } catch (error) {
      console.error('Register error:', error);
      showAlert(getAuthErrorMessage(error), 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
    }
  }

  /**
   * Handles user logout and resets local state.
   */
  async function handleLogout() {
    try {
      await signOut(auth);
      console.log('Logout successful');
      // Reset local state
      resetUserData();
    } catch (error) {
      console.error('Logout error:', error);
      showAlert('An error occurred while logging out. Please try again.', 'error', true);
    }
  }

  /**
   * Maps Firebase auth errors to user-friendly messages.
   * @param {Object} error - The error object from Firebase.
   * @returns {string} User-friendly error message.
   */
  function getAuthErrorMessage(error) {
    const code = error.code || '';
    const messages = {
      'auth/invalid-email': 'Invalid email address.',
      'auth/user-disabled': 'This account has been disabled.',
      'auth/user-not-found': 'No account found with this email.',
      'auth/wrong-password': 'Incorrect password.',
      'auth/email-already-in-use': 'This email is already registered.',
      'auth/weak-password': 'Password is too weak. Use at least 6 characters.',
      'auth/invalid-credential': 'Invalid login credentials.',
      'auth/too-many-requests': 'Too many failed attempts. Try again later.',
      'auth/network-request-failed': 'Network error. Check your connection.'
    };
    return messages[code] || `An error occurred: ${error.message}`;
  }

  /**
   * Updates the user profile display with avatar and username.
   */
  function updateUserProfile() {
    if (!currentUser) return;
    const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
    if (elements.username) elements.username.textContent = displayName;
    if (elements.userAvatar) elements.userAvatar.textContent = displayName.charAt(0).toUpperCase();
  }

  /**
   * Loads user data from Firestore and updates local state/UI.
   * Initializes if no data exists.
   */
  async function loadUserData() {
    if (!currentUser || !db) return;
    
    try {
      const userDoc = doc(db, 'users', currentUser.uid);
      const docSnap = await getDoc(userDoc);
      
      if (docSnap.exists()) {
        userData = { ...userData, ...docSnap.data() }; // Merge to preserve defaults
        console.log('User data loaded');
      } else {
        console.log('No existing user data, using defaults');
        await saveUserData();
      }
      
      updateStatsUI();
      renderLeaderboard();
      renderComments();
      renderHistory();
      applyUnlockedRewards();
    } catch (error) {
      console.error('Error loading user data:', error);
      showAlert('Failed to load your data. Some features may be limited.', 'error', true);
      // Use local defaults as fallback
    }
  }

  /**
   * Saves current userData to Firestore with merge to avoid overwrites.
   */
  async function saveUserData() {
    if (!currentUser || !db) return;
    
    try {
      await setDoc(doc(db, 'users', currentUser.uid), userData, { merge: true });
      console.log('User data saved successfully');
    } catch (error) {
      console.error('Error saving user data:', error);
      showAlert('Failed to save your progress. Please try again.', 'error', true);
    }
  }

  /**
   * Updates the stats grid UI with current userData values.
   */
  function updateStatsUI() {
    if (elements.coins) elements.coins.textContent = userData.coins || 0;
    if (elements.battles) elements.battles.textContent = userData.battles || 0;
    if (elements.wins) elements.wins.textContent = userData.wins || 0;
    if (elements.streak) elements.streak.textContent = userData.streak || 0;
  }

  /**
   * Loads a new battle by fetching two random anime based on selected genre.
   * Handles loading states and errors.
   */
  async function loadBattle() {
    const arena = elements.battleArena;
    const btn = elements.newBattleBtn;
    if (!arena || !btn) {
      console.error('Battle arena or button not found');
      return;
    }

    arena.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
    if (elements.commentSection) elements.commentSection.classList.add('hidden');
    if (elements.shareBtn) elements.shareBtn.classList.add('hidden');
    selectedAnime = null;
    battleAnimes = [];
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Battle...';
    
    try {
      const genre = elements.genreSelect?.value || '';
      const [anime1, anime2] = await Promise.all([
        fetchRandomAnime(genre),
        fetchRandomAnime(genre)
      ]);
      
      if (!anime1 || !anime2 || anime1.mal_id === anime2.mal_id) {
        throw new Error('Failed to load unique anime pair');
      }
      
      battleAnimes = [anime1, anime2];
      arena.innerHTML = '';
      arena.appendChild(createAnimeCard(anime1, 0));
      arena.appendChild(createAnimeCard(anime2, 1));
      
      // Add VS badge overlay
      const vsBadge = document.createElement('div');
      vsBadge.className = 'vs-badge';
      vsBadge.textContent = 'VS';
      arena.appendChild(vsBadge);
      
      console.log('Battle loaded:', anime1.title, 'vs', anime2.title);
    } catch (error) {
      console.error('Error loading battle:', error);
      arena.innerHTML = '<div class="alert alert-error">Failed to load battle. <button class="btn btn-primary" style="margin-top:10px; width:auto;" onclick="loadBattle()">Retry</button></div>';
      showAlert('Battle load failed. Check your connection.', 'error', true);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-random"></i> New Battle';
    }
  }

  /**
   * Fetches a random anime from Jikan API, optionally filtered by genre.
   * Includes fallback and rate-limit handling.
   * @param {string} genreId - Genre ID (e.g., '1' for Action).
   * @returns {Object|null} Anime object or null on failure.
   */
  async function fetchRandomAnime(genreId = '') {
    const maxRetries = 3;
    let attempt = 0;
    
    while (attempt < maxRetries) {
      try {
        const page = Math.floor(Math.random() * 5) + 1; // Limit pages to reduce load
        const baseUrl = 'https://api.jikan.moe/v4/anime';
        const params = genreId ? `genres=${genreId}&sfw=true&order_by=score&sort=desc` : 'sfw=true&order_by=score&sort=desc';
        const url = `${baseUrl}?${params}&page=${page}`;
        
        const response = await fetch(url, {
          headers: { 'User-Agent': 'YANZ-AnimeClash/1.0' } // Polite API usage
        });
        
        if (!response.ok) {
          if (response.status === 429) { // Rate limit
            await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1))); // Backoff
            attempt++;
            continue;
          }
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        if (!data.data || data.data.length === 0) {
          throw new Error('No anime available');
        }
        
        // Filter out NSFW or invalid
        let anime = data.data[Math.floor(Math.random() * data.data.length)];
        if (!anime.images?.jpg?.image_url || anime.score < 5) { // Basic quality filter
          return fetchRandomAnime(genreId); // Recursive retry for quality
        }
        
        return anime;
      } catch (error) {
        console.warn(`Fetch attempt ${attempt + 1} failed:`, error);
        attempt++;
        if (attempt >= maxRetries) {
          // Fallback to any anime
          try {
            const fallbackResponse = await fetch('https://api.jikan.moe/v4/top/anime?page=1&limit=1');
            const fallbackData = await fallbackResponse.json();
            return fallbackData.data?.[0] || null;
          } catch (fallbackError) {
            console.error('Complete fallback failed:', fallbackError);
            return null;
          }
        }
      }
    }
  }

  /**
   * Creates a clickable anime card element for the battle arena.
   * @param {Object} anime - Anime data from API.
   * @param {number} index - Index for event handling.
   * @returns {HTMLElement} The card element.
   */
  function createAnimeCard(anime, index) {
    const card = document.createElement('div');
    card.className = 'anime-card';
    card.dataset.index = index;
    
    const imageUrl = anime.images?.jpg?.large_image_url || anime.images?.jpg?.image_url || 'https://via.placeholder.com/300x450?text=No+Image';
    const title = anime.title?.english || anime.title || 'Unknown Anime';
    const score = anime.score ? parseFloat(anime.score).toFixed(1) : 'N/A';
    const episodes = anime.episodes || '?';
    const year = anime.year || (anime.aired?.prop?.from?.year || '?');
    
    card.innerHTML = `
      <img src="${imageUrl}" alt="${title.replace(/"/g, '&quot;')}" class="anime-image" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450?text=Error'">
      <div class="anime-info">
        <div class="anime-title" title="${title}">${title}</div>
        <div class="anime-details">
          <span>‚≠ê ${score}</span>
          <span>üì∫ ${episodes} eps</span>
          <span>üìÖ ${year}</span>
        </div>
      </div>
    `;
    
    const img = card.querySelector('.anime-image');
    if (img) {
      img.onload = () => img.classList.add('loaded');
      img.onerror = () => { img.src = 'https://via.placeholder.com/300x450?text=No+Image'; };
    }
    
    card.addEventListener('click', (e) => handleAnimeSelect(e, anime));
    
    return card;
  }

  /**
   * Handles anime selection in a battle, updates stats, and shows winner effects.
   * @param {Event} event - Click event.
   * @param {Object} anime - Selected anime data.
   */
  async function handleAnimeSelect(event, anime) {
    if (selectedAnime) return; // Prevent multiple selections
    const currentTarget = event.currentTarget;
    if (!currentTarget || !currentTarget.classList) return;
    
    currentTarget.classList.add('selected');
    document.querySelectorAll('.anime-card').forEach(c => {
      if (c !== currentTarget) c.style.opacity = '0.7'; // Dim loser
    });
    
    selectedAnime = anime;
    if (elements.commentSection) elements.commentSection.classList.remove('hidden');
    if (elements.shareBtn) elements.shareBtn.classList.remove('hidden');
    elements.commentBox?.focus();
    
    // Update user stats (always "win" on selection)
    userData.battles = (userData.battles || 0) + 1;
    userData.wins = (userData.wins || 0) + 1;
    userData.streak = (userData.streak || 0) + 1; // Note: Always increases; consider loss mechanic for real streak
    let coinReward = 10; // Base reward
    if (userData.unlockedRewards && userData.unlockedRewards.includes('Coin Booster')) {
      coinReward *= 2; // Double coins if booster unlocked
    }
    userData.coins = (userData.coins || 0) + coinReward;
    
    // Update leaderboard (personal votes)
    userData.leaderboard = userData.leaderboard || {};
    userData.leaderboard[anime.title] = (userData.leaderboard[anime.title] || 0) + 1;
    
    // Add to history
    userData.history = userData.history || [];
    userData.history.unshift({
      anime: anime.title,
      date: new Date().toISOString(),
      score: anime.score
    });
    if (userData.history.length > 10) userData.history.pop();
    
    // Visual winner effect
    setTimeout(() => {
      currentTarget.classList.add('winner');
      // Confetti or animation could be added here for UX
    }, 500);
    
    updateStatsUI();
    renderLeaderboard();
    renderHistory();
    await saveUserData();
    
    console.log(`Selected winner: ${anime.title}`);
  }

  /**
   * Renders the user's personal leaderboard based on choice counts.
   */
  function renderLeaderboard() {
    const list = elements.leaderboardList;
    if (!list) return;
    
    list.innerHTML = '';
    
    const sorted = Object.entries(userData.leaderboard || {})
      .sort(([,a], [,b]) => b - a)
      .slice(0, 10);
    
    if (sorted.length === 0) {
      list.innerHTML = '<li class="leaderboard-item"><div class="alert" style="margin:0; width:100%; text-align:center;">No battles yet. Start choosing winners!</div></li>';
      return;
    }
    
    sorted.forEach(([title, wins], index) => {
      const li = document.createElement('li');
      li.className = 'leaderboard-item';
      li.innerHTML = `
        <div class="rank">${index + 1}${index === 0 ? ' üëë' : ''}</div>
        <div class="anime-name" title="${title}">${title}</div>
        <div class="score">${wins} Wins</div>
      `;
      list.appendChild(li);
    });
  }

  /**
   * Renders the last 5 comments in the community section.
   */
  function renderComments() {
    const container = elements.commentsContainer;
    if (!container) return;
    
    container.innerHTML = '';
    
    const comments = userData.comments || [];
    if (comments.length === 0) {
      container.innerHTML = '<div class="alert" style="margin:0;">No comments yet. Share your thoughts on your choice!</div>';
      return;
    }
    
    comments.slice(0, 5).forEach(comment => {
      const div = document.createElement('div');
      div.className = 'comment-card';
      div.innerHTML = `
        <div class="comment-header">
          <div class="comment-avatar">${(comment.user || 'U').charAt(0).toUpperCase()}</div>
          <div class="comment-user">${escapeHtml(comment.user || 'Anonymous')}</div>
          <div class="comment-anime">on ${escapeHtml(comment.anime)}</div>
        </div>
        <div class="comment-text">${escapeHtml(comment.text)}</div>
        <div class="comment-footer">
          <div class="comment-date">${new Date(comment.date).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</div>
          <div class="comment-likes">‚ù§Ô∏è ${comment.likes || 0}</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  /**
   * Renders the battle history list.
   */
  function renderHistory() {
    const list = elements.historyList;
    if (!list) return;
    
    list.innerHTML = '';
    
    const history = userData.history || [];
    if (history.length === 0) {
      list.innerHTML = '<div class="alert" style="margin:0;">No history yet. Battle to see your choices!</div>';
      return;
    }
    
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = `
        <div class="history-anime" title="${item.anime}">${item.anime}</div>
        <div class="history-date">${new Date(item.date).toLocaleDateString('en-US')} ${item.score ? `‚≠ê ${item.score}` : ''}</div>
      `;
      list.appendChild(div);
    });
  }

  /**
   * Submits a new comment on the selected anime.
   * Validates length and updates UI/data.
   */
  async function submitComment() {
    const text = (elements.commentBox?.value || '').trim();
    
    if (!text || !selectedAnime) {
      showAlert('Please select an anime and write a comment first.', 'error', true);
      elements.commentBox?.focus();
      return;
    }
    
    if (text.length > 500) {
      showAlert('Comment too long! Keep it under 500 characters.', 'error', true);
      return;
    }
    
    const comment = {
      user: elements.username?.textContent || 'Anonymous',
      anime: selectedAnime,
      text: text,
      date: new Date().toISOString(),
      likes: 0
    };
    
    userData.comments = userData.comments || [];
    userData.comments.unshift(comment);
    if (userData.comments.length > 50) userData.comments.pop();
    
    if (elements.commentBox) elements.commentBox.value = '';
    renderComments();
    await saveUserData();
    
    showAlert('Comment posted! Great share!', 'success', true);
    if (elements.commentBox) elements.commentBox.placeholder = 'Your comment has been added. Why the next winner?';
  }

  /**
   * Unlocks a reward if user has enough coins.
   * Updates UI and applies effects.
   * @param {string} reward - Reward name.
   * @param {number} cost - Coin cost.
   */
  async function unlockReward(reward, cost) {
    if ((userData.coins || 0) < cost) {
      showAlert(`Not enough coins! You need ${cost - (userData.coins || 0)} more. Battle to earn!`, 'error', true);
      return;
    }
    
    if (userData.unlockedRewards?.includes(reward)) {
      showAlert(`You already unlocked ${reward}! Check your profile.`, 'error', true);
      return;
    }
    
    userData.coins -= cost;
    userData.unlockedRewards = userData.unlockedRewards || [];
    userData.unlockedRewards.push(reward);
    
    // Update reward card UI
    const card = document.querySelector(`[data-reward="${reward}"]`);
    if (card) {
      card.classList.add('unlocked');
      const btn = card.querySelector('.unlock-btn');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-check"></i> Unlocked!';
        btn.disabled = true;
        btn.style.opacity = '0.7';
      }
    }
    
    updateStatsUI();
    await saveUserData();
    showAlert(`Unlocked ${reward}! Enjoy your new perk.`, 'success', true);
    
    applyRewardEffect(reward);
  }

  /**
   * Applies visual/effect changes for unlocked rewards.
   * @param {string} reward - The unlocked reward.
   */
  function applyRewardEffect(reward) {
    switch (reward) {
      case 'Custom Theme':
        document.documentElement.style.setProperty('--primary', '#ff9ff3');
        document.documentElement.style.setProperty('--secondary', '#feca57');
        showAlert('Theme applied! Refresh for full effect.', 'success', true);
        break;
      case 'Premium Badge':
        if (elements.userAvatar) {
          elements.userAvatar.style.background = 'linear-gradient(45deg, gold, silver)';
          elements.userAvatar.innerHTML += ' ‚≠ê';
        }
        break;
      case 'Special Avatar':
        if (elements.userAvatar) elements.userAvatar.innerHTML = 'üöÄ';
        break;
      case 'Ad-Free Mode':
        // Simulate ad-free by hiding potential ad placeholders (none exist, but extensible)
        console.log('Ad-Free Mode activated: No ads will appear.');
        showAlert('Ad-Free Mode activated! Enjoy uninterrupted battles.', 'success', true);
        break;
      case 'Coin Booster':
        // Effect applied in handleAnimeSelect (doubles coin rewards)
        showAlert('Coin Booster activated! Future battles earn double coins.', 'success', true);
        break;
      case 'Exclusive Emojis':
        // Add emoji to comments or UI (simulated by updating placeholder)
        if (elements.commentBox) elements.commentBox.placeholder += ' üéâüî•';
        showAlert('Exclusive Emojis unlocked! Use them in comments for flair.', 'success', true);
        break;
      default:
        break;
    }
  }

  /**
   * Applies all unlocked rewards on load.
   */
  function applyUnlockedRewards() {
    (userData.unlockedRewards || []).forEach(applyRewardEffect);
    
    // Update reward cards
    document.querySelectorAll('.reward-card').forEach(card => {
      const reward = card.dataset.reward;
      if (userData.unlockedRewards?.includes(reward)) {
        card.classList.add('unlocked');
        const btn = card.querySelector('.unlock-btn');
        if (btn) {
          btn.innerHTML = '<i class="fas fa-check"></i> Unlocked!';
          btn.disabled = true;
        }
      }
    });
  }

  /**
   * Shares the selected battle result via Web Share API or fallback.
   */
  function shareBattle() {
    if (!selectedAnime) {
      showAlert('Select a winner first to share!', 'error', true);
      return;
    }
    
    const shareData = {
      title: 'YANZ - Anime Clash',
      text: `I picked ${selectedAnime} as the champion! Battle me: ${window.location.href}`,
      url: window.location.href
    };
    
    if (navigator.share) {
      navigator.share(shareData).catch(err => {
        console.error('Share failed:', err);
        fallbackShare(shareData.text);
      });
    } else {
      fallbackShare(shareData.text);
    }
  }

  /**
   * Fallback sharing via clipboard or prompt.
   * @param {string} text - Text to share.
   */
  function fallbackShare(text) {
    navigator.clipboard.writeText(text).then(() => {
      showAlert('Battle link copied! Share with friends.', 'success', true);
    }).catch(() => {
      const input = prompt('Copy this to share:', text);
      if (input !== null) showAlert('Copied manually!', 'success', true);
    });
  }

  /**
   * Escapes HTML to prevent XSS in rendered content.
   * @param {string} unsafe - Input text.
   * @returns {string} Escaped text.
   */
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  /**
   * Resets userData to defaults on logout.
   */
  function resetUserData() {
    userData = {
      coins: 0,
      battles: 0,
      wins: 0,
      streak: 0,
      leaderboard: {},
      comments: [],
      history: [],
      unlockedRewards: []
    };
    selectedAnime = null;
    battleAnimes = [];
    // Reset theme
    document.documentElement.style.setProperty('--primary', '#ff4d89');
    document.documentElement.style.setProperty('--secondary', '#6a5acd');
  }

  // Initialize the app
  init();

  // Expose functions globally for inline onclicks (e.g., retry button)
  window.loadBattle = loadBattle;
</script>
</body>
</html>
