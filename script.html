<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Script</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.href='/local/font-awesome.css'">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" onerror="this.src='/local/purify.min.js'"></script>
  <style>
    :root {
      --bg: #0d0d0d;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --accent: #4a90e2;
      --accent-hover: #6aa0f5;
      --danger: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --discord-bg: #5865F2;
      --discord-hover: #7289DA;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --glow: 0 0 8px rgba(255, 255, 255, 0.5);
      --gradient: linear-gradient(135deg, #1a1a1a, #4a90e2);
      --transition: all 0.3s ease;
      --font-scale: calc(1 + (var(--dpi, 1) - 1) * 0.2);
      --icon-scale: calc(1 + (var(--dpi, 1) - 1) * 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-size: calc(16px * var(--font-scale));
      min-height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      padding: calc(1.5rem * var(--font-scale));
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      box-shadow: var(--box-shadow);
      text-align: center;
      width: 100%;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 1rem;
      position: relative;
      height: calc(80px * var(--icon-scale));
      width: 100%;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }

    .icon-wrapper {
      position: absolute;
      cursor: pointer;
      width: calc(60px * var(--icon-scale));
      height: calc(60px * var(--icon-scale));
      left: 0;
      transform: translateX(0);
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 2;
      will-change: transform;
    }

    .icon-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: var(--box-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .icon-wrapper:hover img {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .icon-wrapper.active {
      transform: translateX(calc(100% - calc(60px * var(--icon-scale))));
    }

    .title-slide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateX(-100%);
      opacity: 0;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease;
      font-size: calc(1.5rem * var(--font-scale));
      font-weight: 700;
      color: #ffffff;
      text-shadow: var(--glow);
      white-space: nowrap;
      letter-spacing: 1px;
      will-change: transform, opacity;
    }

    .title-slide.show {
      transform: translate(-50%, -50%) translateX(0);
      opacity: 1;
    }

    .title-slide.hidden {
      transform: translate(-50%, -50%) translateX(-100%);
      opacity: 0;
    }

    .search-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      padding: calc(0.75rem * var(--font-scale));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .search-container:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      background: #2a2a2a;
      border-radius: var(--border-radius);
      padding: calc(0.3rem * var(--font-scale));
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-box:focus-within {
      box-shadow: 0 0 0 2px var(--accent), var(--glow);
      border-color: var(--accent);
    }

    input {
      flex: 1;
      background: transparent;
      color: var(--text);
      padding: calc(0.7rem * var(--font-scale));
      border: none;
      font-size: calc(0.95rem * var(--font-scale));
      outline: none;
    }

    input::placeholder {
      color: #888;
      font-style: italic;
    }

    .search-btn {
      background: var(--gradient);
      color: #fff;
      padding: calc(0.7rem * var(--font-scale)) calc(1.2rem * var(--font-scale));
      border-radius: calc(var(--border-radius) - 2px);
      font-size: calc(0.95rem * var(--font-scale));
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .search-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .search-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .search-btn:hover::before {
      left: 100%;
    }

    .search-btn:active {
      transform: scale(1);
    }

    .filter-btn {
      background: var(--gradient);
      color: #fff;
      padding: calc(0.6rem * var(--font-scale));
      width: calc(2.2rem * var(--icon-scale));
      height: calc(2.2rem * var(--icon-scale));
      border-radius: 50%;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .filter-btn:hover {
      transform: rotate(90deg);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .close-panel-btn {
      background: var(--danger);
      padding: calc(0.5rem * var(--font-scale));
      width: calc(2rem * var(--icon-scale));
      height: calc(2rem * var(--icon-scale));
      border-radius: 50%;
      align-self: flex-end;
      transition: var(--transition);
    }

    .close-panel-btn:hover {
      background: #ff6655;
      transform: scale(1.1);
    }

    .clear-cache-btn, .discord-btn {
      background: var(--danger);
      color: #fff;
      padding: calc(0.6rem * var(--font-scale));
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-weight: 600;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .discord-btn {
      background: var(--discord-bg);
      text-decoration: none;
    }

    .clear-cache-btn:hover {
      background: #ff6655;
      transform: scale(1.02);
    }

    .discord-btn:hover {
      background: var(--discord-hover);
      transform: scale(1.02);
    }

    .filter-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(calc(200px * var(--font-scale)), 80vw);
      height: 100vh;
      background: var(--card);
      padding: calc(1rem * var(--font-scale));
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filter-panel.show {
      transform: translateX(0);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .filter-group label {
      font-size: calc(0.85rem * var(--font-scale));
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
    }

    .dropdown-container {
      position: relative;
      width: 100%;
    }

    .dropdown-toggle {
      background: #2a2a2a;
      color: var(--text);
      padding: calc(0.7rem * var(--font-scale));
      border-radius: var(--border-radius);
      font-size: calc(0.95rem * var(--font-scale));
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: var(--box-shadow);
    }

    .dropdown-toggle:hover {
      background: #333;
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(74, 144, 226, 0.3);
    }

    .dropdown-toggle::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #888;
      font-size: calc(0.85rem * var(--icon-scale));
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 0.5rem);
      left: 0;
      right: 0;
      background: #2a2a2a;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 10;
      overflow: hidden;
      transform: scaleY(0);
      transform-origin: top;
      transition: transform 0.2s ease-in-out;
    }

    .dropdown-menu.show {
      transform: scaleY(1);
    }

    .dropdown-item {
      padding: calc(0.7rem * var(--font-scale));
      font-size: calc(0.95rem * var(--font-scale));
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
    }

    .dropdown-item:hover {
      background: var(--accent);
      color: #fff;
    }

    .dropdown-item.selected {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
    }

    #results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(calc(280px * var(--font-scale)), 1fr));
      gap: 1.5rem;
      padding: calc(2rem * var(--font-scale));
      width: 100%;
      max-width: 1200px;
    }

    .card {
      background: var(--card);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      opacity: 0;
      transform: translateY(20px);
    }

    .card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .card-img {
      width: 100%;
      height: calc(160px * var(--font-scale));
      object-fit: cover;
    }

    .card-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--gradient);
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      font-size: calc(0.8rem * var(--font-scale));
      font-weight: 600;
    }

    .card-content {
      padding: calc(1.2rem * var(--font-scale));
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card-title {
      font-size: calc(1.1rem * var(--font-scale));
      font-weight: 700;
      color: #fff;
    }

    .card-meta, .card-game, .card-status, .card-likes {
      font-size: calc(0.85rem * var(--font-scale));
      color: #bbb;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-meta i, .card-game i, .card-status i {
      font-size: calc(0.95rem * var(--icon-scale));
    }

    .card-game i { color: var(--warning); }
    .verified { color: var(--success); }
    .key-required { color: var(--warning); }
    .universal { color: var(--accent); }
    .patched { color: var(--danger); }
    .card-likes i.fa-thumbs-up { color: var(--success); }
    .card-likes i.fa-thumbs-down { color: var(--danger); }

    .script-display-container {
      position: relative;
    }

    .script-display {
      width: 100%;
      background: #2a2a2a;
      color: #fff;
      padding: calc(0.8rem * var(--font-scale));
      font-family: 'Courier New', monospace;
      font-size: calc(0.85rem * var(--font-scale));
      border-radius: var(--border-radius);
      resize: none;
      min-height: calc(70px * var(--font-scale));
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .script-copy-btn {
      position: absolute;
      top: calc(0.6rem * var(--font-scale));
      right: calc(0.6rem * var(--font-scale));
      background: var(--accent);
      padding: calc(0.4rem * var(--font-scale));
      border-radius: 50%;
      cursor: pointer;
      z-index: 1;
      transition: var(--transition);
    }

    .script-copy-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--gradient);
      padding: calc(0.8rem * var(--font-scale));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 0.5rem;
      color: #fff;
      font-size: calc(0.95rem * var(--font-scale));
    }

    .spinner {
      width: calc(1.2rem * var(--icon-scale));
      height: calc(1.2rem * var(--icon-scale));
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state, .error-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: calc(2.5rem * var(--font-scale));
      color: #888;
    }

    .error-state {
      color: var(--danger);
      background: rgba(231, 76, 60, 0.1);
      border-radius: var(--border-radius);
    }

    .empty-state i, .error-state i {
      font-size: calc(2.5rem * var(--icon-scale));
      margin-bottom: 0.75rem;
    }

    .suggestion-btn, .retry-btn {
      background: var(--gradient);
      color: #fff;
      padding: calc(0.6rem * var(--font-scale)) calc(1.2rem * var(--font-scale));
      border-radius: var(--border-radius);
      font-size: calc(0.85rem * var(--font-scale));
      font-weight: 600;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .suggestion-btn:hover, .retry-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .toast {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      padding: calc(0.6rem * var(--font-scale)) calc(1.2rem * var(--font-scale));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
    }

    .toast.show {
      opacity: 1;
      bottom: 2.5rem;
    }

    .toast.danger { background: var(--danger); }
    .toast.warning { background: var(--warning); }

    .skeleton-card {
      background: var(--card);
      border-radius: var(--border-radius);
      height: calc(300px * var(--font-scale));
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { background-color: rgba(255, 255, 255, 0.05); }
      50% { background-color: rgba(255, 255, 255, 0.1); }
      100% { background-color: rgba(255, 255, 255, 0.05); }
    }

    @media (max-width: 768px) {
      :root {
        --font-scale: calc(0.85 + (var(--dpi, 1) - 1) * 0.15);
        --icon-scale: calc(0.9 + (var(--dpi, 1) - 1) * 0.25);
      }

      header { padding: calc(1rem * var(--font-scale)); }
      .search-container {
        padding: calc(0.5rem * var(--font-scale));
      }
      .search-box {
        padding: calc(0.2rem * var(--font-scale));
      }
      input {
        padding: calc(0.5rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      .search-btn {
        padding: calc(0.5rem * var(--font-scale)) calc(1rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      .filter-btn {
        margin-top: calc(0.5rem * var(--font-scale));
        width: calc(2rem * var(--icon-scale));
        height: calc(2rem * var(--icon-scale));
      }
      .close-panel-btn {
        padding: calc(0.4rem * var(--font-scale));
        width: calc(1.8rem * var(--icon-scale));
        height: calc(1.8rem * var(--icon-scale));
      }
      .clear-cache-btn, .discord-btn {
        padding: calc(0.5rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      .filter-panel {
        width: min(calc(160px * var(--font-scale)), 80vw);
        padding: calc(0.75rem * var(--font-scale));
      }
      .dropdown-toggle {
        padding: calc(0.5rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      .dropdown-item {
        padding: calc(0.5rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      #results {
        grid-template-columns: 1fr;
        padding: calc(1.5rem * var(--font-scale));
      }
      .card-img { height: calc(140px * var(--font-scale)); }
      .skeleton-card { height: calc(280px * var(--font-scale)); }
      #loading {
        padding: calc(0.6rem * var(--font-scale));
        font-size: calc(0.85rem * var(--font-scale));
      }
      .logo-container {
        height: calc(70px * var(--icon-scale));
      }
      .icon-wrapper {
        width: calc(50px * var(--icon-scale));
        height: calc(50px * var(--icon-scale));
        left: 0;
        transform: translateX(0);
      }
      .icon-wrapper.active {
        transform: translateX(calc(100% - calc(50px * var(--icon-scale))));
      }
      .title-slide {
        font-size: calc(1.2rem * var(--font-scale));
      }
    }

    @media (max-width: 480px) {
      :root {
        --font-scale: calc(0.8 + (var(--dpi, 1) - 1) * 0.1);
        --icon-scale: calc(0.85 + (var(--dpi, 1) - 1) * 0.2);
      }

      .search-btn { padding: calc(0.4rem * var(--font-scale)) calc(0.8rem * var(--font-scale)); }
      .filter-panel { width: min(calc(140px * var(--font-scale)), 80vw); }
      .card-img { height: calc(120px * var(--font-scale)); }
      .skeleton-card { height: calc(260px * var(--font-scale)); }
      #loading {
        padding: calc(0.5rem * var(--font-scale));
        font-size: calc(0.75rem * var(--font-scale));
      }
      .logo-container {
        height: calc(60px * var(--icon-scale));
      }
      .icon-wrapper {
        width: calc(40px * var(--icon-scale));
        height: calc(40px * var(--icon-scale));
        left: 0;
        transform: translateX(0);
      }
      .icon-wrapper.active {
        transform: translateX(calc(100% - calc(40px * var(--icon-scale))));
      }
      .title-slide {
        font-size: calc(1rem * var(--font-scale));
      }
    }

    @media (min-width: 769px) {
      .search-container {
        flex-direction: row;
        align-items: center;
      }
      .filter-btn {
        margin-right: calc(0.5rem * var(--font-scale));
        margin-top: 0;
      }
      .search-box {
        flex: 1;
      }
    }

    @media (min-width: 1200px) {
      #results {
        grid-template-columns: repeat(auto-fill, minmax(calc(300px * var(--font-scale)), 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <div class="icon-wrapper" id="iconWrapper">
        <img src="https://i.postimg.cc/g0zJXrYK/a7f768b4dc4e12857e1e56f350cd2818.jpg" alt="Icon" onerror="this.src='/images/fallback.webp'">
      </div>
      <div class="title-slide hidden" id="titleSlide">Search Script</div>
    </div>
    <div class="search-container">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search scripts..." aria-label="Search scripts">
        <button class="search-btn" id="searchButton" aria-label="Search">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
      <button class="filter-btn" id="filterButton" aria-label="Toggle filters">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="filter-panel" id="filterPanel" tabindex="-1">
      <button class="close-panel-btn" id="closePanelButton" aria-label="Close filter panel">
        <i class="fas fa-times"></i>
      </button>
      <div class="filter-group">
        <label for="scriptTypeFilter">Script Type</label>
        <div class="dropdown-container" id="scriptTypeFilter">
          <div class="dropdown-toggle" tabindex="0" aria-expanded="false">All</div>
          <div class="dropdown-menu">
            <div class="dropdown-item" data-value="all">All</div>
            <div class="dropdown-item" data-value="free">Free</div>
            <div class="dropdown-item" data-value="premium">Paid</div>
          </div>
        </div>
      </div>
      <button class="clear-cache-btn" id="clearCacheButton" aria-label="Clear cache">
        <i class="fas fa-trash"></i> Clear Cache
      </button>
      <a href="https://discord.com/invite/mNGeUVcjKB" class="discord-btn" aria-label="Join our Discord">
        <i class="fab fa-discord"></i> Join Discord
      </a>
    </div>
  </header>

  <div id="loading">
    <div class="spinner"></div>
    <span id="loadingMessage">Loading scripts...</span>
  </div>

  <div id="results"></div>
  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
    document.documentElement.style.setProperty('--dpi', window.devicePixelRatio || 1);

    const CONFIG = {
      API_URL: "https://scriptblox.com/api/script/search",
      CACHE_DURATION: 1000 * 60 * 60,
      CACHE_VERSION: "v1",
      RANDOM_QUERIES: ["Blox Fruits", "Adopt Me", "Murder Mystery 2", "Pet Simulator X"],
      CORS_PROXY: "https://api.allorigins.win/get?url=",
      SUGGESTED_QUERIES: ["Blox Fruits", "Adopt Me", "Murder Mystery 2", "Pet Simulator X"],
      TITLE_TIMEOUT: 3000,
      ITEMS_PER_PAGE: 20,
    };

    const state = {
      scripts: [],
      currentQuery: "",
      currentPage: 1,
      isLoading: false,
      lastError: null,
      filters: { scriptType: "all" },
      isFilterPanelVisible: false,
      isTitleVisible: false,
      titleTimeout: null,
      observer: null,
      hasMore: true,
    };

    const elements = {
      searchInput: document.getElementById("searchInput"),
      searchButton: document.getElementById("searchButton"),
      filterButton: document.getElementById("filterButton"),
      closePanelButton: document.getElementById("closePanelButton"),
      clearCacheButton: document.getElementById("clearCacheButton"),
      filterPanel: document.getElementById("filterPanel"),
      scriptTypeFilter: document.getElementById("scriptTypeFilter"),
      results: document.getElementById("results"),
      loading: document.getElementById("loading"),
      loadingMessage: document.getElementById("loadingMessage"),
      toast: document.getElementById("toast"),
      iconWrapper: document.getElementById("iconWrapper"),
      titleSlide: document.getElementById("titleSlide"),
      logoContainer: document.querySelector(".logo-container"),
    };

    const init = () => {
      setupEventListeners();
      setupDropdown();
      setupIntersectionObserver();
      setupInfiniteScroll();
      loadRandomQuery();
      setupIconAnimation();
    };

    const resetTitleAndIcon = () => {
      state.isTitleVisible = false;
      elements.iconWrapper.classList.remove('active');
      elements.titleSlide.classList.remove('show');
      elements.titleSlide.classList.add('hidden');
      elements.iconWrapper.style.transform = '';
      clearTimeout(state.titleTimeout);
    };

    const setupIconAnimation = () => {
      elements.iconWrapper.addEventListener('click', () => {
        clearTimeout(state.titleTimeout);
        state.isTitleVisible = !state.isTitleVisible;
        elements.iconWrapper.classList.toggle('active', state.isTitleVisible);
        elements.titleSlide.classList.toggle('show', state.isTitleVisible);
        elements.titleSlide.classList.toggle('hidden', !state.isTitleVisible);
        elements.iconWrapper.style.transform = '';
        if (state.isTitleVisible) {
          state.titleTimeout = setTimeout(resetTitleAndIcon, CONFIG.TITLE_TIMEOUT);
        }
      });

      elements.iconWrapper.addEventListener('touchstart', (e) => {
        e.preventDefault();
        clearTimeout(state.titleTimeout);
        state.isTitleVisible = !state.isTitleVisible;
        elements.iconWrapper.classList.toggle('active', state.isTitleVisible);
        elements.titleSlide.classList.toggle('show', state.isTitleVisible);
        elements.titleSlide.classList.toggle('hidden', !state.isTitleVisible);
        elements.iconWrapper.style.transform = '';
        if (state.isTitleVisible) {
          state.titleTimeout = setTimeout(resetTitleAndIcon, CONFIG.TITLE_TIMEOUT);
        }
      });
    };

    const setupEventListeners = () => {
      let debounceTimeout;
      elements.searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          state.currentQuery = elements.searchInput.value.trim();
          state.currentPage = 1;
          state.hasMore = true;
          fetchResults(true);
        }, 300);
      });

      elements.searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          state.currentQuery = elements.searchInput.value.trim();
          state.currentPage = 1;
          state.hasMore = true;
          fetchResults(true);
        }
      });

      elements.searchButton.addEventListener("click", () => {
        state.currentQuery = elements.searchInput.value.trim();
        state.currentPage = 1;
        state.hasMore = true;
        fetchResults(true);
      });

      elements.filterButton.addEventListener("click", () => {
        state.isFilterPanelVisible = !state.isFilterPanelVisible;
        elements.filterPanel.classList.toggle("show", state.isFilterPanelVisible);
        if (state.isFilterPanelVisible) elements.filterPanel.focus();
      });

      elements.closePanelButton.addEventListener("click", () => {
        state.isFilterPanelVisible = false;
        elements.filterPanel.classList.remove("show");
        elements.filterButton.focus();
      });

      elements.filterPanel.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          state.isFilterPanelVisible = false;
          elements.filterPanel.classList.remove("show");
          elements.filterButton.focus();
        }
      });

      elements.clearCacheButton.addEventListener("click", () => {
        clearCache();
        showToast("Cache cleared!", "success");
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".filter-panel") && !e.target.closest(".filter-btn") && state.isFilterPanelVisible) {
          state.isFilterPanelVisible = false;
          elements.filterPanel.classList.remove("show");
        }
      });
    };

    const setupDropdown = () => {
      const dropdown = elements.scriptTypeFilter;
      const toggle = dropdown.querySelector(".dropdown-toggle");
      const menu = dropdown.querySelector(".dropdown-menu");
      const items = dropdown.querySelectorAll(".dropdown-item");

      const toggleDropdown = () => {
        menu.classList.toggle("show");
        toggle.setAttribute("aria-expanded", menu.classList.contains("show"));
      };

      toggle.addEventListener("click", toggleDropdown);
      toggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleDropdown();
        }
      });

      items.forEach((item) => {
        item.addEventListener("click", () => {
          state.filters.scriptType = item.dataset.value;
          toggle.textContent = item.textContent;
          items.forEach((i) => i.classList.remove("selected"));
          item.classList.add("selected");
          menu.classList.remove("show");
          toggle.setAttribute("aria-expanded", "false");
          state.currentPage = 1;
          state.hasMore = true;
          fetchResults(true);
        });
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".dropdown-container")) {
          menu.classList.remove("show");
          toggle.setAttribute("aria-expanded", "false");
        }
      });
    };

    const setupIntersectionObserver = () => {
      if (state.observer) state.observer.disconnect();
      state.observer = new IntersectionObserver(
        (entries) => entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("visible");
            state.observer.unobserve(entry.target);
          }
        }),
        { rootMargin: "0px 0px 100px 0px", threshold: 0.1 }
      );
      document.querySelectorAll(".card").forEach((card) => state.observer.observe(card));
    };

    const setupInfiniteScroll = () => {
      const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), wait);
        };
      };

      window.addEventListener('scroll', debounce(() => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 && !state.isLoading && state.hasMore) {
          fetchResults(false);
        }
      }, 100));
    };

    const showToast = (message, type = "success") => {
      elements.toast.textContent = message;
      elements.toast.className = `toast ${type} show`;
      setTimeout(() => elements.toast.classList.remove("show"), 3000);
    };

    const normalizeQuery = (query) =>
      query.trim().toLowerCase().replace(/[^a-z0-9\s]/g, "").replace(/\s+/g, " ");

    const loadRandomQuery = () => {
      state.currentQuery = CONFIG.RANDOM_QUERIES[Math.floor(Math.random() * CONFIG.RANDOM_QUERIES.length)];
      elements.searchInput.value = state.currentQuery;
      state.currentPage = 1;
      state.hasMore = true;
      fetchResults(true);
    };

    const getCachedResults = (query, page) => {
      const cacheKey = `scripts_${CONFIG.CACHE_VERSION}_${normalizeQuery(query)}_page${page}`;
      const cached = localStorage.getItem(cacheKey);
      if (!cached) return null;
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp > CONFIG.CACHE_DURATION) {
        localStorage.removeItem(cacheKey);
        return null;
      }
      return data;
    };

    const cacheResults = (data, query, page) => {
      localStorage.setItem(`scripts_${CONFIG.CACHE_VERSION}_${normalizeQuery(query)}_page${page}`, JSON.stringify({
        data,
        timestamp: Date.now(),
      }));
    };

    const clearCache = () => {
      Object.keys(localStorage)
        .filter((key) => key.startsWith(`scripts_${CONFIG.CACHE_VERSION}_`))
        .forEach((key) => localStorage.removeItem(key));
      state.scripts = [];
      state.currentPage = 1;
      state.hasMore = true;
      renderResults();
      fetchResults(true);
    };

    const validateScriptData = (script) => {
      return (
        script &&
        typeof script._id === 'string' &&
        typeof script.title === 'string' &&
        typeof script.game === 'object' &&
        typeof script.game.name === 'string'
      );
    };

    const fetchResults = async (reset = false) => {
      if (state.isLoading || !state.hasMore) return;
      state.isLoading = true;
      state.lastError = null;
      elements.loadingMessage.textContent = `Loading scripts for "${state.currentQuery || "free"}" (Page ${state.currentPage})... Please wait.`;
      elements.loading.style.display = "flex";

      if (reset) {
        state.scripts = [];
        state.currentPage = 1;
        state.hasMore = true;
      }

      try {
        const query = state.currentQuery || "free";
        const cached = getCachedResults(query, state.currentPage);
        if (cached) {
          state.scripts = reset ? cached : [...state.scripts, ...cached];
          renderResults();
          showToast(`Loaded ${cached.length} scripts from cache`, "success");
          state.currentPage++;
          return;
        }

        const url = new URL(CONFIG.API_URL);
        url.searchParams.append("q", query);
        url.searchParams.append("page", state.currentPage);
        url.searchParams.append("max", CONFIG.ITEMS_PER_PAGE);

        let res;
        try {
          res = await fetchWithRetry(CONFIG.CORS_PROXY + encodeURIComponent(url));
        } catch (proxyErr) {
          console.warn("CORS proxy failed, trying direct API...");
          res = await fetchWithRetry(url);
        }

        if (!res.ok) throw new Error(`API failed: ${res.status}`);
        const data = await res.json();
        if (!data.contents) throw new Error("Invalid API response: Missing contents");
        const parsed = JSON.parse(data.contents);
        if (!parsed.result || !Array.isArray(parsed.result.scripts)) {
          throw new Error("Invalid API response: Missing or invalid scripts array");
        }
        const newScripts = parsed.result.scripts.filter(validateScriptData);
        state.scripts = reset ? newScripts : [...state.scripts, ...newScripts];
        state.hasMore = newScripts.length === CONFIG.ITEMS_PER_PAGE;
        cacheResults(newScripts, query, state.currentPage);
        renderResults();
        showToast(`Loaded ${newScripts.length} scripts`, newScripts.length ? "success" : "warning");
        if (!state.scripts.length && reset) {
          state.scripts = getSampleData();
          renderResults();
        }
        state.currentPage++;
      } catch (err) {
        state.lastError = err;
        showToast(`Error: ${err.message}. Using sample data.`, "danger");
        if (reset) {
          const cached = getCachedResults(query, 1) || getSampleData();
          state.scripts = cached;
          renderResults();
        }
      } finally {
        state.isLoading = false;
        elements.loading.style.display = "none";
      }
    };

    const fetchWithRetry = async (url, retries = 3, delay = 1000) => {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (res.status === 429) {
            const retryAfter = res.headers.get('Retry-After') || delay * 2 ** i;
            await new Promise((resolve) => setTimeout(resolve, retryAfter * 1000));
            continue;
          }
          if (res.ok) return res;
          throw new Error(`HTTP ${res.status}`);
        } catch (err) {
          if (i < retries - 1) await new Promise((resolve) => setTimeout(resolve, delay * 2 ** i));
          else throw err;
        }
      }
      throw new Error("Max retries reached.");
    };

    const getSampleData = () => [
      {
        _id: "683b3949a348d24efdf83b72",
        title: "Forge Hub (10+ GAMES, OP FEATURES, AUTOFARMS AND LOTS MORE!)",
        game: { gameId: 0, name: "Universal Script ðŸ“Œ", imageUrl: "/images/no-script.webp" },
        slug: "Universal-Script-Forge-Hub-41461",
        verified: true,
        key: true,
        views: 3137720,
        scriptType: "free",
        isUniversal: true,
        isPatched: false,
        image: "/images/script/0-1748711753445.png",
        lastBump: "2025-08-16T14:57:50.845Z",
        likeCount: 19,
        dislikeCount: 10,
        createdAt: "2025-05-31T17:15:53.512Z",
        script: "loadstring(game:HttpGet(\"https://rawscripts.net/raw/Universal-Script-Forge-Hub-41461\"))()",
        matched: ["title", "features"],
      },
      {
        _id: "689a6cc770d65046a249e924",
        title: "Garden Tower Defense ( OP script free gui Xenith )",
        game: {
          gameId: 108533757090220,
          name: "[ðŸ˜±] Garden Tower Defense ðŸŒ»",
          imageUrl: "https://tr.rbxcdn.com/180DAY-5bdc7bca1f2489f0caed6fabf50a1b24/480/270/Image/Png/noFilter",
        },
        slug: "Garden-Tower-Defense-Garden-Tower-Defense-OP-script-free-gui-Xenith-48253",
        verified: true,
        key: true,
        views: 28298,
        scriptType: "free",
        isUniversal: false,
        isPatched: false,
        image: "https://tr.rbxcdn.com/180DAY-5bdc7bca1f2489f0caed6fabf50a1b24/480/270/Image/Png/noFilter",
        lastBump: "2025-08-11T22:20:55.822Z",
        likeCount: 1,
        dislikeCount: 1,
        createdAt: "2025-08-11T22:20:55.824Z",
        script: "loadstring(game:HttpGet(\"https://rawscripts.net/raw/Garden-Tower-Defense-Garden-Tower-Defense-OP-script-free-gui-Xenith-48253\"))()",
        matched: ["features"],
      },
    ];

    const renderResults = () => {
      requestAnimationFrame(() => {
        const container = elements.results;
        if (state.isLoading) {
          container.innerHTML = Array(6).fill().map(() => '<div class="skeleton-card"></div>').join("");
          return;
        }
        if (state.lastError) {
          container.innerHTML = `
            <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error Loading Scripts</h3>
              <p>${sanitizeHTML(state.lastError.message)}</p>
              <button class="retry-btn" onclick="fetchResults(true)">Retry</button>
              <div class="empty-state-suggestions">
                ${CONFIG.SUGGESTED_QUERIES.map((q) => `<button class="suggestion-btn" onclick="searchSuggestion('${sanitizeHTML(q)}')">${sanitizeHTML(q)}</button>`).join("")}
              </div>
            </div>`;
          return;
        }

        const scripts = filterScripts();
        if (!scripts.length) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-file-code"></i>
              <h3>No scripts found</h3>
              <p>Try a different search term:</p>
              <div class="empty-state-suggestions">
                ${CONFIG.SUGGESTED_QUERIES.map((q) => `<button class="suggestion-btn" onclick="searchSuggestion('${sanitizeHTML(q)}')">${sanitizeHTML(q)}</button>`).join("")}
              </div>
            </div>`;
          return;
        }

        container.innerHTML = scripts.map(createScriptCard).join("");
        setupIntersectionObserver();
      });
    };

    const sanitizeHTML = (str) => DOMPurify.sanitize(str || "");

    const filterScripts = () => {
      let filtered = state.scripts;
      const query = normalizeQuery(state.currentQuery);
      if (query) {
        filtered = filtered.filter((script) =>
          [script.title, script.game?.name, script.slug, script.matched?.join(" ")].some((field) =>
            normalizeQuery(field || "").includes(query)
          )
        );
      }
      if (state.filters.scriptType !== "all") {
        filtered = filtered.filter((script) => script.scriptType === state.filters.scriptType);
      }
      return filtered;
    };

    const createScriptCard = (script) => {
      const imgSrc = sanitizeHTML(script.image || script.game.imageUrl || '/images/fallback.webp');
      const createdAt = new Date(script.createdAt).toLocaleDateString();
      const lastBump = new Date(script.lastBump).toLocaleDateString();
      const matchedFields = script.matched ? script.matched.join(", ") : "None";

      return `
        <div class="card" data-id="${sanitizeHTML(script._id)}">
          <div style="position: relative;">
            <img src="${imgSrc}" class="card-img" loading="lazy" alt="${sanitizeHTML(script.game.name)}">
            ${script.scriptType === "paid" ? '<span class="card-badge">PREMIUM</span>' : ""}
            ${script.isUniversal ? '<span class="card-badge universal">UNIVERSAL</span>' : ""}
            ${script.isPatched ? '<span class="card-badge patched">PATCHED</span>' : ""}
          </div>
          <div class="card-content">
            <div class="card-header">
              <h3 class="card-title">${sanitizeHTML(script.title)}</h3>
              <div class="card-meta">
                <i class="fas fa-eye"></i> ${script.views.toLocaleString()}
              </div>
            </div>
            <div class="card-game">
              <i class="fas fa-gamepad"></i> ${sanitizeHTML(script.game.name)}
            </div>
            <div class="card-meta">
              <i class="fas fa-id-badge"></i> ID: ${sanitizeHTML(script._id)}
            </div>
            <div class="card-meta">
              <i class="fas fa-link"></i> Slug: ${sanitizeHTML(script.slug)}
            </div>
            <div class="card-meta">
              <i class="fas fa-gamepad"></i> Game ID: ${script.game.gameId}
            </div>
            <div class="card-meta">
              <i class="fas fa-calendar-alt"></i> Created: ${createdAt}
            </div>
            <div class="card-meta">
              <i class="fas fa-calendar-check"></i> Last Bump: ${lastBump}
            </div>
            <div class="card-meta">
              <i class="fas fa-tags"></i> Matched: ${sanitizeHTML(matchedFields)}
            </div>
            <div class="card-likes">
              <span><i class="fas fa-thumbs-up"></i> ${script.likeCount}</span>
              <span><i class="fas fa-thumbs-down"></i> ${script.dislikeCount}</span>
            </div>
            <div class="card-status">
              ${script.verified ? '<span class="verified"><i class="fas fa-check-circle"></i> Verified</span>' : ''}
              ${script.key ? '<span class="key-required"><i class="fas fa-key"></i> Key Required</span>' : ''}
            </div>
            <div class="script-display-container">
              <textarea class="script-display" readonly>${sanitizeHTML(script.script)}</textarea>
              <button class="script-copy-btn" onclick="copyScript('${sanitizeHTML(script.script)}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>`;
    };

    const copyScript = (script) => {
      try {
        navigator.clipboard.writeText(script);
        showToast("Script copied!", "success");
      } catch (err) {
        showToast("Copy failed", "danger");
      }
    };

    const searchSuggestion = (query) => {
      state.currentQuery = query;
      elements.searchInput.value = query;
      state.currentPage = 1;
      state.hasMore = true;
      fetchResults(true);
    };

    document.addEventListener("DOMContentLoaded", init);
    window.copyScript = copyScript;
    window.fetchResults = fetchResults;
    window.searchSuggestion = searchSuggestion;
  </script>
</body>
</html>
