<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YANZ - Search Script</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0d0d0d;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --accent: #4a90e2;
      --accent-light: #6aa0f5;
      --danger: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --border-radius: 12px;
      --box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      --gradient: linear-gradient(135deg, #4a90e2, #6aa0f5);
      --discord-gradient: linear-gradient(135deg, #5865F2, #7289DA);
      --transition: all 0.3s ease;
      --font-scale: calc(1 + (var(--dpi, 1) - 1) * 0.25);
      --icon-scale: calc(1 + (var(--dpi, 1) - 1) * 0.35);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: calc(16px * var(--font-scale));
      touch-action: manipulation;
      min-height: 100vh;
      overflow-y: auto;
    }

    header {
      padding: calc(1rem * var(--font-scale)) 2rem;
      background: var(--card);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      box-shadow: var(--box-shadow);
      position: relative;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo i {
      color: var(--accent);
      font-size: calc(1.4rem * var(--icon-scale));
    }

    h1 {
      margin: 0;
      font-size: calc(1.4rem * var(--font-scale));
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-container {
      display: flex;
      align-items: center;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      gap: 0.75rem;
    }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
      display: flex;
      align-items: center;
    }

    .search-box i.fa-search {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
      font-size: calc(1.1rem * var(--icon-scale));
    }

    input, textarea {
      border-radius: var(--border-radius);
      border: none;
      font-size: calc(0.85rem * var(--font-scale));
      transition: var(--transition);
    }

    .search-box input {
      width: 100%;
      background: #2a2a2a;
      color: #fff;
      padding: calc(0.75rem * var(--font-scale)) calc(2.5rem * var(--font-scale));
    }

    input:focus {
      outline: 2px solid var(--accent);
      background: #333;
    }

    button {
      background: var(--gradient);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      white-space: nowrap;
      border: none;
      border-radius: var(--border-radius);
      font-size: calc(0.85rem * var(--font-scale));
      transition: var(--transition);
    }

    button:hover {
      background: var(--accent-light);
      transform: scale(1.05);
    }

    button:active {
      transform: scale(1);
    }

    .search-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      padding: calc(0.5rem * var(--font-scale));
      width: calc(2rem * var(--icon-scale));
      height: calc(2rem * var(--icon-scale));
      border-radius: 50%;
      font-size: calc(0.9rem * var(--icon-scale));
    }

    .filter-btn {
      padding: calc(0.75rem * var(--font-scale));
      width: calc(2.5rem * var(--icon-scale));
      height: calc(2.5rem * var(--icon-scale));
      border-radius: 50%;
      order: -1; /* Move to the left of search-box */
    }

    .close-panel-btn {
      background: var(--danger);
      padding: calc(0.5rem * var(--font-scale));
      width: calc(2rem * var(--icon-scale));
      height: calc(2rem * var(--icon-scale));
      border-radius: 50%;
      align-self: flex-end;
    }

    .close-panel-btn:hover {
      background: #ff6655;
    }

    .clear-cache-btn {
      background: var(--danger);
      padding: calc(0.5rem * var(--font-scale));
      justify-content: center;
    }

    .clear-cache-btn:hover {
      background: #ff6655;
    }

    .discord-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .discord-btn:hover {
      transform: scale(1.1);
    }

    .discord-btn i {
      font-size: calc(1.4rem * var(--icon-scale));
      color: #7289DA;
    }

    .filter-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: calc(200px * var(--font-scale));
      height: 100vh;
      background: var(--card);
      padding: calc(1rem * var(--font-scale));
      border-radius: 0;
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      animation: rgb-border 4s linear infinite;
    }

    .filter-panel.show {
      transform: translateX(0);
    }

    @keyframes rgb-border {
      0% {
        border-left: 2px solid #ff0000;
      }
      25% {
        border-left: 2px solid #00ff00;
      }
      50% {
        border-left: 2px solid #0000ff;
      }
      75% {
        border-left: 2px solid #ff00ff;
      }
      100% {
        border-left: 2px solid #ff0000;
      }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: calc(0.8rem * var(--font-scale));
      font-weight: 500;
    }

    .custom-select {
      position: relative;
      width: 100%;
    }

    .custom-select-toggle {
      background: #2a2a2a;
      color: #fff;
      padding: calc(0.5rem * var(--font-scale));
      border-radius: var(--border-radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-size: calc(0.8rem * var(--font-scale));
    }

    .custom-select-toggle:focus {
      outline: 2px solid var(--accent);
      background: #333;
    }

    .custom-select-toggle::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #777;
      font-size: calc(0.7rem * var(--icon-scale));
    }

    .custom-select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #2a2a2a;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 10;
      margin-top: 0.25rem;
    }

    .custom-select-options.show {
      display: block;
    }

    .custom-select-option {
      padding: calc(0.5rem * var(--font-scale));
      cursor: pointer;
      font-size: calc(0.8rem * var(--font-scale));
      color: #fff;
    }

    .custom-select-option:hover {
      background: #333;
    }

    .custom-select-option.selected {
      background: var(--accent);
    }

    #results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(calc(280px * var(--font-scale)), 1fr));
      gap: 1.5rem;
      padding: calc(2rem * var(--font-scale));
      padding-top: calc(1.5rem * var(--font-scale));
    }

    .card {
      background: var(--card);
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      opacity: 0;
      transform: translateY(20px);
    }

    .card.visible {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .card-img {
      width: 100%;
      height: calc(160px * var(--font-scale));
      object-fit: cover;
      border-bottom: 1px solid #333;
    }

    .card-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--gradient);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: calc(0.75rem * var(--font-scale));
      font-weight: bold;
    }

    .card-content {
      padding: calc(1.25rem * var(--font-scale));
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .card-title {
      margin: 0;
      font-size: calc(1.1rem * var(--font-scale));
      font-weight: 600;
      color: #fff;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: calc(0.85rem * var(--font-scale));
      color: #aaa;
    }

    .card-meta i {
      color: var(--accent);
      font-size: calc(0.9rem * var(--icon-scale));
    }

    .card-game {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: calc(0.9rem * var(--font-scale));
      color: #ccc;
    }

    .card-game i {
      color: var(--warning);
      font-size: calc(0.9rem * var(--icon-scale));
    }

    .card-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .script-display-container {
      position: relative;
      width: 100%;
    }

    .script-display {
      width: 100%;
      background: #2a2a2a;
      color: #fff;
      padding: calc(2rem * var(--font-scale)) 0.75rem 0.75rem 0.75rem;
      font-family: 'Courier New', Courier, monospace;
      font-size: calc(0.85rem * var(--font-scale));
      overflow-x: auto;
      white-space: pre;
      border-radius: var(--border-radius);
      resize: none;
      min-height: calc(80px * var(--font-scale));
    }

    .script-display::-webkit-scrollbar {
      height: 8px;
    }

    .script-display::-webkit-scrollbar-track {
      background: #333;
      border-radius: 4px;
    }

    .script-display::-webkit-scrollbar-thumb {
      background: #fff;
      border-radius: 4px;
    }

    .script-display::-webkit-scrollbar-thumb:hover {
      background: #ddd;
    }

    .script-copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: calc(1.5rem * var(--icon-scale));
      height: calc(1.5rem * var(--icon-scale));
      border-radius: 50%;
      padding: 0;
      font-size: calc(0.75rem * var(--icon-scale));
      background: var(--gradient);
    }

    #loading {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--gradient);
      padding: calc(0.75rem * var(--font-scale)) calc(1.25rem * var(--font-scale));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 0.75rem;
    }

    .spinner {
      width: calc(1rem * var(--icon-scale));
      height: calc(1rem * var(--icon-scale));
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: calc(3rem * var(--font-scale));
      color: #777;
    }

    .empty-state i {
      font-size: calc(3rem * var(--icon-scale));
      margin-bottom: 1rem;
      color: #444;
    }

    .empty-state-suggestions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .suggestion-btn {
      background: var(--gradient);
      color: #fff;
      padding: calc(0.5rem * var(--font-scale)) calc(1rem * var(--font-scale));
      border-radius: var(--border-radius);
      border: none;
      font-size: calc(0.85rem * var(--font-scale));
      cursor: pointer;
      transition: var(--transition);
    }

    .suggestion-btn:hover {
      background: var(--accent-light);
      transform: scale(1.05);
    }

    .suggestion-btn:active {
      transform: scale(1);
    }

    .error-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: calc(3rem * var(--font-scale));
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
      border-radius: var(--border-radius);
      margin: 1rem;
    }

    .error-state i {
      font-size: calc(3rem * var(--icon-scale));
      margin-bottom: 1rem;
    }

    .retry-btn {
      margin-top: 1rem;
      background: var(--danger);
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      padding: calc(0.75rem * var(--font-scale)) calc(1.5rem * var(--font-scale));
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
      max-width: 90%;
      font-size: calc(0.85rem * var(--font-scale));
    }

    .toast.show {
      opacity: 1;
      bottom: 2rem;
    }

    .toast.danger {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    @media (max-width: 768px) {
      :root {
        --font-scale: calc(0.85 + (var(--dpi, 1) - 1) * 0.2);
        --icon-scale: calc(0.9 + (var(--dpi, 1) - 1) * 0.3);
      }

      header {
        flex-direction: column;
        align-items: stretch;
        padding: calc(0.9rem * var(--font-scale));
      }

      .logo-container {
        justify-content: flex-start;
        max-width: none;
        margin: 0;
      }

      .search-container {
        flex-direction: column;
        gap: 0.65rem;
        margin: 0;
      }

      .search-box {
        width: 100%;
      }

      .search-box input {
        padding: calc(0.7rem * var(--font-scale)) calc(2.3rem * var(--font-scale));
        font-size: calc(0.8rem * var(--font-scale));
      }

      .search-box i.fa-search {
        font-size: calc(1rem * var(--icon-scale));
        left: 8px;
      }

      .search-btn {
        right: 8px;
        padding: calc(0.4rem * var(--font-scale));
        width: calc(1.8rem * var(--icon-scale));
        height: calc(1.8rem * var(--icon-scale));
        font-size: calc(0.8rem * var(--icon-scale));
      }

      .filter-btn {
        padding: calc(0.4rem * var(--font-scale));
        width: calc(2rem * var(--icon-scale));
        height: calc(2rem * var(--icon-scale));
        font-size: calc(0.8rem * var(--icon-scale));
      }

      .close-panel-btn {
        padding: calc(0.4rem * var(--font-scale));
        width: calc(1.8rem * var(--icon-scale));
        height: calc(1.8rem * var(--icon-scale));
        font-size: calc(0.8rem * var(--icon-scale));
      }

      .clear-cache-btn {
        padding: calc(0.5rem * var(--font-scale));
      }

      .filter-panel {
        width: calc(180px * var(--font-scale));
        padding: calc(0.6rem * var(--font-scale));
      }

      .filter-group label {
        font-size: calc(0.75rem * var(--font-scale));
      }

      .custom-select-toggle, .custom-select-option {
        padding: calc(0.4rem * var(--font-scale));
        font-size: calc(0.75rem * var(--font-scale));
      }

      .custom-select-toggle::after {
        font-size: calc(0.65rem * var(--icon-scale));
      }

      #results {
        grid-template-columns: 1fr;
        padding: calc(0.9rem * var(--font-scale));
        padding-top: calc(1.3rem * var(--font-scale));
      }

      .card-img {
        height: calc(140px * var(--font-scale));
      }

      .card-title {
        font-size: calc(1rem * var(--font-scale));
      }

      .card-meta, .card-game {
        font-size: calc(0.8rem * var(--font-scale));
      }

      .script-display {
        font-size: calc(0.8rem * var(--font-scale));
        min-height: calc(70px * var(--font-scale));
      }
    }

    @media (max-width: 480px) {
      :root {
        --font-scale: calc(0.8 + (var(--dpi, 1) - 1) * 0.15);
        --icon-scale: calc(0.85 + (var(--dpi, 1) - 1) * 0.25);
      }

      #results {
        grid-template-columns: 1fr;
      }

      .search-box input {
        padding: calc(0.65rem * var(--font-scale)) calc(2.2rem * var(--font-scale));
        font-size: calc(0.8rem * var(--font-scale));
      }

      .logo i {
        font-size: calc(1.1rem * var(--icon-scale));
      }

      h1 {
        font-size: calc(1.2rem * var(--font-scale));
      }

      .card-title {
        font-size: calc(0.9rem * var(--font-scale));
      }

      .card-img {
        height: calc(120px * var(--font-scale));
      }

      .toast {
        padding: calc(0.55rem * var(--font-scale)) calc(1.1rem * var(--font-scale));
        font-size: calc(0.8rem * var(--font-scale));
      }

      .search-btn {
        padding: calc(0.35rem * var(--font-scale));
        width: calc(1.6rem * var(--icon-scale));
        height: calc(1.6rem * var(--icon-scale));
        font-size: calc(0.7rem * var(--icon-scale));
      }

      .filter-btn {
        padding: calc(0.35rem * var(--font-scale));
        width: calc(1.8rem * var(--icon-scale));
        height: calc(1.8rem * var(--icon-scale));
        font-size: calc(0.7rem * var(--icon-scale));
      }

      .close-panel-btn {
        padding: calc(0.35rem * var(--font-scale));
        width: calc(1.6rem * var(--icon-scale));
        height: calc(1.6rem * var(--icon-scale));
        font-size: calc(0.7rem * var(--icon-scale));
      }

      .clear-cache-btn {
        padding: calc(0.45rem * var(--font-scale));
      }

      .filter-panel {
        width: calc(160px * var(--font-scale));
        padding: calc(0.5rem * var(--font-scale));
      }

      .filter-group label {
        font-size: calc(0.7rem * var(--font-scale));
      }

      .custom-select-toggle, .custom-select-option {
        padding: calc(0.35rem * var(--font-scale));
        font-size: calc(0.7rem * var(--font-scale));
      }

      .custom-select-toggle::after {
        font-size: calc(0.6rem * var(--icon-scale));
      }
    }

    @media (min-width: 1200px) {
      #results {
        grid-template-columns: repeat(auto-fill, minmax(calc(300px * var(--font-scale)), 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <div class="logo">
        <i class="fas fa-code"></i>
        <h1>YANZ - Search Script</h1>
      </div>
      <a href="https://discord.com/invite/mNGeUVcjKB" target="_blank" class="discord-btn" aria-label="Join our Discord">
        <i class="fab fa-discord"></i>
      </a>
    </div>
    <div class="search-container">
      <button class="filter-btn" id="filterButton" aria-label="Toggle filters">
        <i class="fas fa-bars"></i>
      </button>
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search scripts..." aria-label="Search scripts">
        <button class="search-btn" id="searchButton" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
    <div class="filter-panel" id="filterPanel">
      <button class="close-panel-btn" id="closePanelButton" aria-label="Close filter panel">
        <i class="fas fa-times"></i>
      </button>
      <div class="filter-group">
        <label for="scriptTypeFilter">Script Type</label>
        <div class="custom-select" id="scriptTypeFilter">
          <div class="custom-select-toggle" tabindex="0" aria-label="Filter by script type">All</div>
          <div class="custom-select-options">
            <div class="custom-select-option" data-value="all">All</div>
            <div class="custom-select-option" data-value="free">Free</div>
            <div class="custom-select-option" data-value="premium">paid</div>
          </div>
        </div>
      </div>
      <button class="clear-cache-btn" id="clearCacheButton" aria-label="Clear cache">
        <i class="fas fa-trash"></i> Clear Cache
      </button>
    </div>
  </header>

  <div id="loading">
    <div class="spinner"></div>
    <span>Loading scripts...</span>
  </div>

  <div id="results"></div>

  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <script>
    document.documentElement.style.setProperty('--dpi', window.devicePixelRatio || 1);

    const CONFIG = {
      API_URL: "https://scriptblox.com/api/script/search",
      CACHE_DURATION: 1000 * 60 * 60,
      CACHE_VERSION: "v1",
      RANDOM_QUERIES: [
        "Blox Fruits",
        "Prison Life",
        "Adopt Me",
        "Murder Mystery 2",
        "Brookhaven",
        "Arsenal",
        "Doors",
        "Pet Simulator X",
      ],
      CORS_PROXY: "https://api.allorigins.win/get?url=",
      SUGGESTED_QUERIES: [
        "Blox Fruits",
        "Adopt Me",
        "Murder Mystery 2 optimized",
        "Pet Simulator X",
      ],
    };

    const state = {
      scripts: [],
      filteredScripts: [],
      currentQuery: "",
      isLoading: false,
      lastError: null,
      filters: {
        scriptType: "all",
      },
      isFilterPanelVisible: false,
    };

    const elements = {
      searchInput: document.getElementById("searchInput"),
      searchButton: document.getElementById("searchButton"),
      filterButton: document.getElementById("filterButton"),
      closePanelButton: document.getElementById("closePanelButton"),
      clearCacheButton: document.getElementById("clearCacheButton"),
      filterPanel: document.getElementById("filterPanel"),
      scriptTypeFilter: document.getElementById("scriptTypeFilter"),
      results: document.getElementById("results"),
      loading: document.getElementById("loading"),
      toast: document.getElementById("toast"),
    };

    function init() {
      setupEventListeners();
      setupCustomSelects();
      setupIntersectionObserver();
      loadRandomQuery();
    }

    function setupEventListeners() {
      let debounceTimeout;
      elements.searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          state.currentQuery = elements.searchInput.value.trim();
          renderResults();
        }, 300);
      });
      elements.searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          state.currentQuery = elements.searchInput.value.trim();
          fetchResults(true);
        }
      });
      elements.searchButton.addEventListener("click", (e) => {
        e.preventDefault();
        state.currentQuery = elements.searchInput.value.trim();
        fetchResults(true);
      });
      elements.filterButton.addEventListener("click", () => {
        state.isFilterPanelVisible = !state.isFilterPanelVisible;
        elements.filterPanel.classList.toggle("show", state.isFilterPanelVisible);
      });
      elements.closePanelButton.addEventListener("click", () => {
        state.isFilterPanelVisible = false;
        elements.filterPanel.classList.remove("show");
      });
      elements.clearCacheButton.addEventListener("click", () => {
        clearCache();
        showToast("Cache cleared successfully!", "success");
      });
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest(".filter-panel") &&
          !e.target.closest(".filter-btn") &&
          state.isFilterPanelVisible
        ) {
          state.isFilterPanelVisible = false;
          elements.filterPanel.classList.remove("show");
        }
      });
    }

    function setupCustomSelects() {
      const selects = [
        { element: elements.scriptTypeFilter, key: "scriptType", options: ["all", "free", "premium"] },
      ];

      selects.forEach(({ element, key, options }) => {
        const toggle = element.querySelector(".custom-select-toggle");
        const optionsContainer = element.querySelector(".custom-select-options");
        const optionElements = element.querySelectorAll(".custom-select-option");

        toggle.addEventListener("click", () => {
          optionsContainer.classList.toggle("show");
        });

        toggle.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            optionsContainer.classList.toggle("show");
          }
        });

        optionElements.forEach((option) => {
          option.addEventListener("click", () => {
            const value = option.dataset.value;
            state.filters[key] = value;
            toggle.textContent = option.textContent;
            optionElements.forEach((opt) => opt.classList.remove("selected"));
            option.classList.add("selected");
            optionsContainer.classList.remove("show");
            renderResults();
          });
        });

        const selectedOption = Array.from(optionElements).find((opt) => opt.dataset.value === state.filters[key]);
        if (selectedOption) {
          toggle.textContent = selectedOption.textContent;
          selectedOption.classList.add("selected");
        }
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".custom-select")) {
          document.querySelectorAll(".custom-select-options").forEach((container) => {
            container.classList.remove("show");
          });
        }
      });
    }

    function setupIntersectionObserver() {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { rootMargin: "0px 0px 100px 0px", threshold: 0.1 }
      );

      const cards = document.querySelectorAll(".card");
      cards.forEach((card) => observer.observe(card));
    }

    function showToast(message, type = "success") {
      const toast = elements.toast;
      toast.textContent = message;
      toast.className = "toast";
      toast.classList.add(type, "show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    function normalizeQuery(query) {
      return query.trim().toLowerCase().replace(/\s+/g, " ");
    }

    function loadRandomQuery() {
      const randomQuery =
        CONFIG.RANDOM_QUERIES[Math.floor(Math.random() * CONFIG.RANDOM_QUERIES.length)];
      state.currentQuery = randomQuery;
      elements.searchInput.value = randomQuery;
      fetchResults(true);
    }

    function getCachedResults(query) {
      const cacheKey = `scripts_${CONFIG.CACHE_VERSION}_${normalizeQuery(query)}`;
      const cached = localStorage.getItem(cacheKey);
      if (!cached) return null;
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp > CONFIG.CACHE_DURATION) {
        localStorage.removeItem(cacheKey);
        return null;
      }
      return data;
    }

    function cacheResults(data, query) {
      const cacheKey = `scripts_${CONFIG.CACHE_VERSION}_${normalizeQuery(query)}`;
      localStorage.setItem(cacheKey, JSON.stringify({
        data,
        timestamp: Date.now(),
      }));
    }

    function clearCache() {
      Object.keys(localStorage)
        .filter((key) => key.startsWith(`scripts_${CONFIG.CACHE_VERSION}_`))
        .forEach((key) => localStorage.removeItem(key));
      state.scripts = [];
      state.filteredScripts = [];
      renderResults();
      fetchResults(true);
    }

    async function fetchResults(reset = false) {
      if (state.isLoading) return;

      state.isLoading = true;
      state.lastError = null;
      elements.loading.style.display = "flex";

      if (reset) state.scripts = [];

      try {
        const query = state.currentQuery || "free";
        const cached = getCachedResults(query);
        if (cached) {
          state.scripts = cached;
          state.filteredScripts = cached;
          renderResults();
          showToast(`Loaded scripts for "${query}" from cache`, "success");
          state.isLoading = false;
          elements.loading.style.display = "none";
          return;
        }

        const url = new URL(CONFIG.API_URL);
        url.searchParams.append("q", query);
        url.searchParams.append("page", "1");
        url.searchParams.append("max", "100000");

        const proxyUrl = CONFIG.CORS_PROXY + encodeURIComponent(url.toString());
        const res = await fetchWithRetry(proxyUrl, 3, 1000);

        if (!res.ok) {
          throw new Error(`API request failed with status ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (!data.contents) {
          throw new Error("Invalid API response format");
        }

        let json;
        try {
          json = JSON.parse(data.contents);
        } catch (e) {
          throw new Error("Failed to parse API response");
        }

        state.scripts = json.result?.scripts || [];
        state.filteredScripts = state.scripts;
        cacheResults(state.scripts, query);
        renderResults();

        if (state.scripts.length > 0) {
          showToast(`Loaded ${state.scripts.length} scripts for "${query}"`, "success");
        } else {
          showToast("No scripts found. Showing sample data.", "warning");
          state.scripts = getSampleData();
          state.filteredScripts = state.scripts;
          renderResults();
        }

        if (state.scripts.length < 1000) {
          showToast("API may have limited results. Try a suggested query.", "warning");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        state.lastError = err;
        showToast("Failed to load scripts. Showing sample data.", "danger");

        if (reset) {
          state.scripts = getSampleData();
          state.filteredScripts = state.scripts;
          renderResults();
        }
      } finally {
        state.isLoading = false;
        elements.loading.style.display = "none";
      }
    }

    async function fetchWithRetry(url, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, {
            headers: { 'Accept': 'application/json' },
          });
          if (res.ok) return res;
        } catch (err) {
          if (i < retries - 1) await new Promise((resolve) => setTimeout(resolve, delay * 2 ** i));
        }
      }
      throw new Error("Max retries reached");
    }

    function getSampleData() {
      return [
        {
          _id: "1",
          title: "Blox Fruits Auto Farm",
          game: { name: "Blox Fruits", imageUrl: "https://via.placeholder.com/480x270?text=Blox+Fruits" },
          slug: "#",
          views: 12345,
          scriptType: "free",
          createdAt: new Date().toISOString(),
          script: "print('Auto farming script for Blox Fruits')",
        },
        {
          _id: "2",
          title: "Prison Life ESP",
          game: { name: "Prison Life", imageUrl: "https://via.placeholder.com/480x270?text=Prison+Life" },
          slug: "#",
          views: 8765,
          scriptType: "free",
          createdAt: new Date(Date.now() - 86400000).toISOString(),
          script: "print('ESP script for Prison Life')",
        },
        {
          _id: "3",
          title: "Murder Mystery 2 Auto Win",
          game: { name: "Murder Mystery 2", imageUrl: "https://via.placeholder.com/480x270?text=MM2" },
          slug: "#",
          views: 5432,
          scriptType: "paid",
          createdAt: new Date(Date.now() - 172800000).toISOString(),
          script: "print('Auto win script for MM2')",
        },
      ];
    }

    function renderResults() {
      const container = elements.results;

      if (state.lastError) {
        container.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Scripts</h3>
            <p>${sanitizeHTML(state.lastError.message || "Unknown error occurred")}</p>
            <button class="retry-btn" onclick="fetchResults(true)" aria-label="Retry loading scripts">
              <i class="fas fa-sync-alt"></i> Retry
            </button>
            <div class="empty-state-suggestions">
              <p>Try these popular searches:</p>
              ${CONFIG.SUGGESTED_QUERIES.map(
                (query) => `
                  <button class="suggestion-btn" onclick="searchSuggestion('${query}')" aria-label="Search for ${query}">
                    ${sanitizeHTML(query)}
                  </button>
                `
              ).join("")}
            </div>
          </div>
        `;
        return;
      }

      const scripts = filterScripts();
      if (scripts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-code"></i>
            <h3>No scripts found</h3>
            <p>Try a different search term or explore these suggestions:</p>
            <div class="empty-state-suggestions">
              ${CONFIG.SUGGESTED_QUERIES.map(
                (query) => `
                  <button class="suggestion-btn" onclick="searchSuggestion('${query}')" aria-label="Search for ${query}">
                    ${sanitizeHTML(query)}
                  </button>
                `
              ).join("")}
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = scripts.map((script) => createScriptCard(script)).join("");
      setupIntersectionObserver();
    }

    function sanitizeHTML(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function filterScripts() {
      let filtered = state.scripts;

      const query = normalizeQuery(state.currentQuery);
      if (query) {
        filtered = filtered.filter((script) => {
          const title = normalizeQuery(script.title || "");
          const gameName = normalizeQuery(script.game?.name || "");
          return title.includes(query) || gameName.includes(query);
        });
      }

      if (state.filters.scriptType !== "all") {
        filtered = filtered.filter((script) => script.scriptType === state.filters.scriptType);
      }

      state.filteredScripts = filtered;
      return filtered;
    }

    function createScriptCard(script) {
      const imgSrc = sanitizeHTML(script.game.imageUrl);
      const createdAt = new Date(script.createdAt).toLocaleDateString();

      return `
        <div class="card" data-id="${sanitizeHTML(script._id)}">
          <div style="position: relative;">
            <img src="${imgSrc}" class="card-img" loading="lazy" alt="${sanitizeHTML(script.game.name)}">
            ${script.scriptType === "paid" ? '<span class="card-badge">PREMIUM</span>' : ""}
          </div>
          <div class="card-content">
            <div class="card-header">
              <h3 class="card-title">${sanitizeHTML(script.title)}</h3>
              <div class="card-meta">
                <i class="fas fa-eye"></i>
                <span>${script.views.toLocaleString()}</span>
              </div>
            </div>
            <div class="card-game">
              <i class="fas fa-gamepad"></i>
              <span>${sanitizeHTML(script.game.name)}</span>
            </div>
            <div class="card-meta">
              <i class="fas fa-calendar-alt"></i>
              <span>${createdAt}</span>
            </div>
            <div class="card-footer">
              <div class="script-display-container">
                <textarea class="script-display" readonly>${sanitizeHTML(script.script)}</textarea>
                <button class="script-copy-btn" onclick="copyScript('${encodeURIComponent(script.script)}')" aria-label="Copy script">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function copyScript(encodedScript) {
      try {
        const script = decodeURIComponent(encodedScript);
        navigator.clipboard.writeText(script);
        showToast("Script copied to clipboard!", "success");
      } catch (err) {
        console.error("Copy failed:", err);
        showToast("Failed to copy script", "danger");
      }
    }

    function searchSuggestion(query) {
      state.currentQuery = query;
      elements.searchInput.value = query;
      fetchResults(true);
    }

    document.addEventListener("DOMContentLoaded", init);

    window.copyScript = copyScript;
    window.fetchResults = fetchResults;
    window.searchSuggestion = searchSuggestion;
  </script>
</body>
</html>
