<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoinGecko Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary: #4a90e2;
  --primary-dark: #2a70c2;
  --secondary: #50e3c2;
  --secondary-dark: #30c3a2;
  --positive: #4CAF50;
  --negative: #f44336;
  --bg: #0f172a;
  --card-bg: rgba(30, 41, 59, 0.7);
  --card-bg-solid: #1e293b;
  --text: #f8fafc;
  --text-secondary: #94a3b8;
  --error: #ff5c5c;
  --radius: 16px;
  --radius-sm: 8px;
  --transition: 0.3s ease-in-out;
  --shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  --glass: rgba(255, 255, 255, 0.05);
}

* { 
  box-sizing: border-box; 
  margin:0; 
  padding:0; 
  font-family:'Roboto', sans-serif; 
}

body { 
  background: linear-gradient(135deg, var(--bg) 0%, #1a1a2e 100%);
  color: var(--text); 
  min-height: 100vh;
  line-height: 1.6;
}

header { 
  padding: 1.5rem 2rem; 
  background: linear-gradient(90deg, var(--card-bg-solid) 0%, rgba(30, 41, 59, 0.9) 100%);
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  border-bottom: 1px solid var(--glass);
  flex-wrap: wrap;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}

header h1 { 
  background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-size: 1.8rem; 
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

header span { 
  color: var(--text-secondary);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 0.5rem 1rem;
  background: var(--glass);
  border-radius: 50px;
}

main { 
  padding: 2rem; 
  max-width: 1600px; 
  margin: 0 auto; 
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.loader { 
  border: 6px solid rgba(255, 255, 255, 0.1); 
  border-top: 6px solid var(--primary); 
  border-radius: 50%; 
  width: 60px; 
  height: 60px; 
  animation: spin 1s linear infinite; 
  margin: 80px auto; 
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.card { 
  background: var(--card-bg);
  border-radius: var(--radius); 
  padding: 1.5rem; 
  margin-bottom: 1.5rem;
  transition: var(--transition); 
  overflow: hidden;
  border: 1px solid var(--glass);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
}

.card:hover { 
  transform: translateY(-8px); 
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
}

.card h2 {
  font-size: 1.4rem;
  margin-bottom: 1.2rem;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
  padding-bottom: 0.8rem;
  border-bottom: 1px solid var(--glass);
}

.card h2 i {
  color: var(--primary);
}

.stats-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: var(--glass);
  border-radius: var(--radius-sm);
  padding: 1rem;
  flex: 1;
  min-width: 150px;
  text-align: center;
  transition: var(--transition);
}

.stat-card:hover {
  background: rgba(74, 144, 226, 0.1);
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.stat-card .value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text);
}

.stat-card .change {
  font-size: 0.9rem;
  font-weight: 600;
  margin-top: 0.3rem;
  display: inline-block;
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
}

.change.positive {
  background-color: rgba(76, 175, 80, 0.2);
  color: var(--positive);
}

.change.negative {
  background-color: rgba(244, 67, 54, 0.2);
  color: var(--negative);
}

.filter-container {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.filter-input { 
  padding: 0.8rem 1.2rem; 
  flex: 1;
  min-width: 250px;
  border-radius: var(--radius-sm); 
  border: 1px solid var(--glass);
  outline: none; 
  font-size: 1rem; 
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
  transition: var(--transition);
}

.filter-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
}

.filter-select {
  padding: 0.8rem 1.2rem;
  border-radius: var(--radius-sm);
  border: 1px solid var(--glass);
  background: rgba(255, 255, 255, 0.05);
  color: var(--text);
  outline: none;
  cursor: pointer;
  transition: var(--transition);
}

.filter-select:focus {
  border-color: var(--primary);
}

table { 
  width:100%; 
  border-collapse:collapse; 
  min-width: 600px; 
}

th, td { 
  padding: 0.8rem 1rem; 
  text-align:left; 
  border-bottom:1px solid rgba(255, 255, 255, 0.05); 
  word-wrap: break-word; 
  white-space: nowrap;
}

th { 
  background: rgba(74, 144, 226, 0.1); 
  color: var(--text); 
  cursor:pointer; 
  position:sticky; 
  top:0; 
  z-index:1;
  font-weight: 600;
  transition: var(--transition);
}

th:hover {
  background: rgba(74, 144, 226, 0.2);
}

th i {
  margin-left: 5px;
  font-size: 0.8rem;
  opacity: 0.7;
}

tr { 
  transition: var(--transition);
}

tr:hover { 
  background: rgba(255, 255, 255, 0.05); 
}

.coin-name {
  display: flex;
  align-items: center;
  gap: 10px;
}

.coin-logo {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
}

.exchange-logo {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  margin-right: 10px;
  vertical-align: middle;
}

.error { 
  padding: 1.5rem; 
  background: rgba(255, 92, 92, 0.1); 
  color: var(--error);
  border-radius: var(--radius); 
  margin: 1.5rem 0; 
  text-align: center;
  border: 1px solid var(--error);
}

.pagination { 
  display:flex; 
  gap: 0.5rem; 
  justify-content:center; 
  align-items: center;
  margin-top: 1.5rem; 
  flex-wrap: wrap;
}

.pagination button { 
  padding: 0.6rem 1rem; 
  border: none; 
  border-radius: var(--radius-sm); 
  background: var(--glass); 
  color: var(--text); 
  cursor: pointer; 
  transition: var(--transition);
  font-weight: 500;
}

.pagination button:hover:not(:disabled) { 
  background: rgba(74, 144, 226, 0.3); 
  transform: translateY(-2px);
}

.pagination button:disabled { 
  background: rgba(255, 255, 255, 0.05); 
  color: var(--text-secondary);
  cursor: not-allowed; 
}

.pagination button.active {
  background: var(--primary);
  color: white;
}

.pagination-info {
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin: 0 1rem;
}

.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}

.price-change {
  font-weight: 600;
  padding: 0.2rem 0.6rem;
  border-radius: 4px;
  font-size: 0.9rem;
}

.positive-change {
  color: var(--positive);
  background-color: rgba(76, 175, 80, 0.1);
}

.negative-change {
  color: var(--negative);
  background-color: rgba(244, 67, 54, 0.1);
}

@media(max-width: 1200px) {
  .dashboard-grid {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
}

@media(max-width: 768px) {
  main { padding: 1rem; }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  table { min-width: 100%; }
  
  th, td { 
    font-size: 0.85rem; 
    padding: 0.6rem 0.8rem; 
  }
  
  header { 
    padding: 1rem; 
    flex-direction: column; 
    gap: 1rem;
    text-align: center;
  }
  
  header h1 { font-size: 1.5rem; }
  
  .stat-card { min-width: 100%; }
  
  .filter-container { flex-direction: column; }
  
  .filter-input, .filter-select { min-width: 100%; }
}

@media(max-width: 480px) {
  .card { padding: 1rem; }
  
  th, td { 
    font-size: 0.8rem; 
    padding: 0.5rem 0.6rem; 
  }
  
  .pagination button {
    padding: 0.5rem 0.8rem;
    font-size: 0.9rem;
  }
}

</style>
</head>
<body>

<header>
  <h1><i class="fas fa-chart-line"></i> CoinGecko Dashboard Pro Advanced</h1>
  <span><i class="fas fa-sync-alt"></i> Real-time Crypto Analytics</span>
</header>

<main>
  <div id="loader" class="loader"></div>
  <div id="error" class="error" style="display:none;"></div>

  <div class="card">
    <h2><i class="fas fa-chart-pie"></i> Market Overview</h2>
    <div class="stats-container" id="market-stats">
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card">
      <h2><i class="fas fa-arrow-up"></i> Top Gainers (24h)</h2>
      <div id="top-gainers">
      </div>
    </div>
    
    <div class="card">
      <h2><i class="fas fa-arrow-down"></i> Top Losers (24h)</h2>
      <div id="top-losers">
      </div>
    </div>
  </div>

  <div class="filter-container">
    <input type="text" id="filter" class="filter-input" placeholder="Filter coins/exchanges by name, symbol, or country...">
    <select id="coin-filter" class="filter-select">
      <option value="all">All Coins</option>
      <option value="top100">Top 100 by Market Cap</option>
      <option value="top250">Top 250 by Market Cap</option>
    </select>
    <select id="exchange-filter" class="filter-select">
      <option value="all">All Exchanges</option>
      <option value="trusted">Trust Score â‰¥ 8</option>
      <option value="us">US Based</option>
    </select>
  </div>
  
  <div class="card">
    <h2><i class="fas fa-coins"></i> Cryptocurrencies (USD)</h2>
    <table id="coins-table">
      <thead>
        <tr>
          <th data-sort="market_cap_rank">Rank <i class="fas fa-sort"></i></th>
          <th data-sort="name">Name <i class="fas fa-sort"></i></th>
          <th data-sort="current_price">Price <i class="fas fa-sort"></i></th>
          <th data-sort="price_change_percentage_24h">24h Change <i class="fas fa-sort"></i></th>
          <th data-sort="market_cap">Market Cap <i class="fas fa-sort"></i></th>
          <th data-sort="total_volume">Volume (24h) <i class="fas fa-sort"></i></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="coins-pagination"></div>
    <div class="pagination-info" id="coins-pagination-info"></div>
  </div>

  <div class="card">
    <h2><i class="fas fa-exchange-alt"></i> Exchanges</h2>
    <table id="exchanges-table">
      <thead>
        <tr>
          <th data-sort="name">Name <i class="fas fa-sort"></i></th>
          <th data-sort="year_established">Year <i class="fas fa-sort"></i></th>
          <th data-sort="country">Country <i class="fas fa-sort"></i></th>
          <th data-sort="trust_score">Trust Score <i class="fas fa-sort"></i></th>
          <th data-sort="trade_volume_24h_btc">Volume (24h BTC) <i class="fas fa-sort"></i></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="exchanges-pagination"></div>
    <div class="pagination-info" id="exchanges-pagination-info"></div>
  </div>

  <div class="card">
    <h2><i class="fas fa-chart-line"></i> BTC & ETH Price (USD) Real-time</h2>
    <div class="chart-container">
      <canvas id="crypto-chart" height="150"></canvas>
    </div>
  </div>
</main>

<script>
const loader = document.getElementById('loader');
const errorDiv = document.getElementById('error');
const filterInput = document.getElementById('filter');
const coinFilter = document.getElementById('coin-filter');
const exchangeFilter = document.getElementById('exchange-filter');
const marketStats = document.getElementById('market-stats');
const topGainers = document.getElementById('top-gainers');
const topLosers = document.getElementById('top-losers');

let coinsMarket = [], exchanges = [];
let coinsPage = 1, exchangesPage = 1, perPage = 15;
let sortState = { coins: {}, exchanges: {} };
let chart;

async function fetchWithCache(url, cacheKey, ttl = 60000) {
  const cached = JSON.parse(localStorage.getItem(cacheKey) || '{}');
  
  if (cached.time && (Date.now() - cached.time) < ttl) {
    console.log(`Using cached data for ${cacheKey}`);
    return cached.data;
  }
  
  try {
    const res = await fetch(url);
    
    if (res.status === 429) {
      throw new Error('Rate limit exceeded. Please try again later.');
    }
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    
    localStorage.setItem(cacheKey, JSON.stringify({
      time: Date.now(),
      data: data
    }));
    
    return data;
  } catch (error) {
    if (cached.data) {
      console.warn(`Using expired cache for ${cacheKey} due to error:`, error.message);
      return cached.data;
    }
    throw error;
  }
}

async function loadData() {
  try {
    loader.style.display = 'block';
    errorDiv.style.display = 'none';
    
    coinsMarket = await fetchWithCache(
      'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false',
      'coinsMarket',
      110000
    );
    
    exchanges = await fetchWithCache(
      'https://api.coingecko.com/api/v3/exchanges?per_page=100',
      'exchanges',
      100000
    );
    
    updateMarketStats();
    renderTopGainersLosers();
    renderCoinsTable();
    renderExchangesTable();
    startCryptoCharts();
    
  } catch (error) {
    console.error('Error loading data:', error);
    errorDiv.style.display = 'block';
    errorDiv.textContent = `Error: ${error.message}. Using cached data if available.`;
    
    const cachedCoins = localStorage.getItem('coinsMarket');
    const cachedExchanges = localStorage.getItem('exchanges');
    
    if (cachedCoins) {
      const coinsCache = JSON.parse(cachedCoins);
      if (coinsCache.data) {
        coinsMarket = coinsCache.data;
        renderCoinsTable();
        updateMarketStats();
        renderTopGainersLosers();
      }
    }
    
    if (cachedExchanges) {
      const exchangesCache = JSON.parse(cachedExchanges);
      if (exchangesCache.data) {
        exchanges = exchangesCache.data;
        renderExchangesTable();
      }
    }
  } finally {
    loader.style.display = 'none';
  }
}

function updateMarketStats() {
  if (!coinsMarket.length) return;
  
  const totalMarketCap = coinsMarket.reduce((sum, coin) => sum + (coin.market_cap || 0), 0);
  const totalVolume = coinsMarket.reduce((sum, coin) => sum + (coin.total_volume || 0), 0);
  
  const btc = coinsMarket.find(coin => coin.id === 'bitcoin');
  const btcDominance = btc ? (btc.market_cap / totalMarketCap * 100).toFixed(2) : 0;
  
  const positiveCoins = coinsMarket.filter(coin => coin.price_change_percentage_24h > 0).length;
  const marketSentiment = ((positiveCoins / coinsMarket.length) * 100).toFixed(1);
  
  marketStats.innerHTML = `
    <div class="stat-card">
      <h3>Total Market Cap</h3>
      <div class="value">$${(totalMarketCap / 1e12).toFixed(2)}T</div>
    </div>
    <div class="stat-card">
      <h3>24h Volume</h3>
      <div class="value">$${(totalVolume / 1e9).toFixed(2)}B</div>
    </div>
    <div class="stat-card">
      <h3>BTC Dominance</h3>
      <div class="value">${btcDominance}%</div>
      <div class="change ${btc && btc.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
        ${btc ? btc.price_change_percentage_24h.toFixed(2) : '0.00'}%
      </div>
    </div>
    <div class="stat-card">
      <h3>Market Sentiment</h3>
      <div class="value">${marketSentiment}%</div>
      <div class="change ${marketSentiment >= 50 ? 'positive' : 'negative'}">
        ${marketSentiment >= 50 ? 'Bullish' : 'Bearish'}
      </div>
    </div>
  `;
}
  
function renderTopGainersLosers() {
  if (!coinsMarket.length) return;

  const sortedByChange = [...coinsMarket].sort((a, b) => 
    (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0)
  );

  const gainers = sortedByChange.slice(0, 5);
  topGainers.innerHTML = gainers.map(coin => `
    <div class="stat-card">
      <div class="coin-name" style="justify-content: center; margin-bottom: 0.5rem;">
        <img src="${coin.image || 'https://via.placeholder.com/32'}" alt="${coin.name}" class="coin-logo">
        <div>
          <div style="font-weight: 600;">${coin.name}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">${coin.symbol.toUpperCase()}</div>
        </div>
      </div>
      <div class="value">$${coin.current_price?.toLocaleString() || 'N/A'}</div>
      <div class="change positive">+${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%</div>
    </div>
  `).join('');
  
  const losers = sortedByChange.slice(-5).reverse();
  topLosers.innerHTML = losers.map(coin => `
    <div class="stat-card">
      <div class="coin-name" style="justify-content: center; margin-bottom: 0.5rem;">
        <img src="${coin.image || 'https://via.placeholder.com/32'}" alt="${coin.name}" class="coin-logo">
        <div>
          <div style="font-weight: 600;">${coin.name}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">${coin.symbol.toUpperCase()}</div>
        </div>
      </div>
      <div class="value">$${coin.current_price?.toLocaleString() || 'N/A'}</div>
      <div class="change negative">${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%</div>
    </div>
  `).join('');
}

function renderPagination(containerId, totalItems, page, callback) {
  const container = document.getElementById(containerId);
  const totalPages = Math.ceil(totalItems / perPage);
  
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let paginationHTML = '';
  
  paginationHTML += `<button ${page <= 1 ? 'disabled' : ''} data-page="${page - 1}">Prev</button>`;
  
  const maxVisiblePages = 5;
  let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  if (startPage > 1) {
    paginationHTML += `<button data-page="1">1</button>`;
    if (startPage > 2) paginationHTML += `<button disabled>...</button>`;
  }
  
  for (let i = startPage; i <= endPage; i++) {
    paginationHTML += `<button ${i === page ? 'class="active"' : ''} data-page="${i}">${i}</button>`;
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) paginationHTML += `<button disabled>...</button>`;
    paginationHTML += `<button data-page="${totalPages}">${totalPages}</button>`;
  }
  
  paginationHTML += `<button ${page >= totalPages ? 'disabled' : ''} data-page="${page + 1}">Next</button>`;
  
  container.innerHTML = paginationHTML;
  
  container.querySelectorAll('button').forEach(button => {
    const pageNum = button.getAttribute('data-page');
    if (pageNum) {
      button.addEventListener('click', () => {
        callback(parseInt(pageNum));
      });
    }
  });
}

function renderCoinsTable() {
  const tbody = document.querySelector('#coins-table tbody');
  const paginationInfo = document.getElementById('coins-pagination-info');
  
  let filtered = coinsMarket.filter(coin => {
    const filterText = filterInput.value.toLowerCase();
    const matchesSearch = !filterText || 
      coin.name.toLowerCase().includes(filterText) || 
      coin.symbol.toLowerCase().includes(filterText);
    
    const coinFilterValue = coinFilter.value;
    let matchesCoinFilter = true;
    
    if (coinFilterValue === 'top100') {
      matchesCoinFilter = coin.market_cap_rank <= 100;
    } else if (coinFilterValue === 'top250') {
      matchesCoinFilter = coin.market_cap_rank <= 250;
    }
    
    return matchesSearch && matchesCoinFilter;
  });
  
  const totalCoins = filtered.length;
  const start = (coinsPage - 1) * perPage;
  const end = start + perPage;
  const pageCoins = filtered.slice(start, end);
  
  tbody.innerHTML = pageCoins.map(coin => {
    const priceChange = coin.price_change_percentage_24h || 0;
    const changeClass = priceChange >= 0 ? 'positive-change' : 'negative-change';
    const changeSymbol = priceChange >= 0 ? '+' : '';
    
    return `
      <tr>
        <td>${coin.market_cap_rank || '-'}</td>
        <td>
          <div class="coin-name">
            <img src="${coin.image || 'https://via.placeholder.com/24'}" alt="${coin.name}" class="coin-logo">
            <div>
              <div>${coin.name}</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">${coin.symbol.toUpperCase()}</div>
            </div>
          </div>
        </td>
        <td>$${coin.current_price?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 }) || '-'}</td>
        <td><span class="price-change ${changeClass}">${changeSymbol}${priceChange.toFixed(2)}%</span></td>
        <td>$${(coin.market_cap / 1e9).toFixed(2)}B</td>
        <td>$${(coin.total_volume / 1e9).toFixed(2)}B</td>
      </tr>
    `;
  }).join('');
  
  paginationInfo.textContent = `Showing ${start + 1}-${Math.min(end, totalCoins)} of ${totalCoins} coins`;
  
  renderPagination('coins-pagination', totalCoins, coinsPage, (page) => {
    coinsPage = page;
    renderCoinsTable();
  });
}

function renderExchangesTable() {
  const tbody = document.querySelector('#exchanges-table tbody');
  const paginationInfo = document.getElementById('exchanges-pagination-info');
  
  let filtered = exchanges.filter(exchange => {
    const filterText = filterInput.value.toLowerCase();
    const matchesSearch = !filterText || 
      exchange.name.toLowerCase().includes(filterText) || 
      (exchange.country && exchange.country.toLowerCase().includes(filterText));
    
    const exchangeFilterValue = exchangeFilter.value;
    let matchesExchangeFilter = true;
    
    if (exchangeFilterValue === 'trusted') {
      matchesExchangeFilter = exchange.trust_score >= 8;
    } else if (exchangeFilterValue === 'us') {
      matchesExchangeFilter = exchange.country && exchange.country.toLowerCase() === 'united states';
    }
    
    return matchesSearch && matchesExchangeFilter;
  });
  
  const totalExchanges = filtered.length;
  const start = (exchangesPage - 1) * perPage;
  const end = start + perPage;
  const pageExchanges = filtered.slice(start, end);
  
  tbody.innerHTML = pageExchanges.map(exchange => {
    return `
      <tr>
        <td>
          <img src="${exchange.image || 'https://via.placeholder.com/24'}" alt="${exchange.name}" class="exchange-logo">
          ${exchange.name}
        </td>
        <td>${exchange.year_established || '-'}</td>
        <td>${exchange.country || '-'}</td>
        <td>
          <div style="display: inline-block; width: 60px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
            <div style="width: ${(exchange.trust_score || 0) * 10}%; height: 100%; background: ${exchange.trust_score >= 8 ? '#4CAF50' : exchange.trust_score >= 5 ? '#FF9800' : '#f44336'};"></div>
          </div>
          <span style="margin-left: 8px;">${exchange.trust_score || '-'}</span>
        </td>
        <td>${exchange.trade_volume_24h_btc ? exchange.trade_volume_24h_btc.toLocaleString() : '-'} BTC</td>
      </tr>
    `;
  }).join('');
  
  paginationInfo.textContent = `Showing ${start + 1}-${Math.min(end, totalExchanges)} of ${totalExchanges} exchanges`;
  
  renderPagination('exchanges-pagination', totalExchanges, exchangesPage, (page) => {
    exchangesPage = page;
    renderExchangesTable();
  });
}

filterInput.addEventListener('input', () => {
  coinsPage = 1;
  exchangesPage = 1;
  renderCoinsTable();
  renderExchangesTable();
});

coinFilter.addEventListener('change', () => {
  coinsPage = 1;
  renderCoinsTable();
});

exchangeFilter.addEventListener('change', () => {
  exchangesPage = 1;
  renderExchangesTable();
});

function setupSorting() {
  document.querySelectorAll('#coins-table th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.sort;
      
      document.querySelectorAll('#coins-table th i').forEach(icon => {
        icon.className = 'fas fa-sort';
      });
      
      const icon = th.querySelector('i');
      const dir = sortState.coins[key] === 'asc' ? 'desc' : 'asc';
      icon.className = dir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
      
      coinsMarket.sort((a, b) => {
        let va = a[key];
        let vb = b[key];
        
        if (va === undefined || va === null) va = key.includes('price') || key.includes('market_cap') || key.includes('volume') ? 0 : '';
        if (vb === undefined || vb === null) vb = key.includes('price') || key.includes('market_cap') || key.includes('volume') ? 0 : '';
        
        if (typeof va === 'number' && typeof vb === 'number') {
          return dir === 'asc' ? va - vb : vb - va;
        } else {
          const strA = String(va).toLowerCase();
          const strB = String(vb).toLowerCase();
          return dir === 'asc' ? strA.localeCompare(strB) : strB.localeCompare(strA);
        }
      });
      
      sortState.coins[key] = dir;
      renderCoinsTable();
    });
  });
  
  document.querySelectorAll('#exchanges-table th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.sort;
      
      document.querySelectorAll('#exchanges-table th i').forEach(icon => {
        icon.className = 'fas fa-sort';
      });
      
      const icon = th.querySelector('i');
      const dir = sortState.exchanges[key] === 'asc' ? 'desc' : 'asc';
      icon.className = dir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
      
      exchanges.sort((a, b) => {
        let va = a[key];
        let vb = b[key];
        
        if (va === undefined || va === null) va = key.includes('volume') || key.includes('score') ? 0 : '';
        if (vb === undefined || vb === null) vb = key.includes('volume') || key.includes('score') ? 0 : '';
        
        if (typeof va === 'number' && typeof vb === 'number') {
          return dir === 'asc' ? va - vb : vb - va;
        } else {
          const strA = String(va).toLowerCase();
          const strB = String(vb).toLowerCase();
          return dir === 'asc' ? strA.localeCompare(strB) : strB.localeCompare(strA);
        }
      });
      
      sortState.exchanges[key] = dir;
      renderExchangesTable();
    });
  });
}

async function startCryptoCharts() {
  const ctx = document.getElementById('crypto-chart').getContext('2d');
  
  try {
    const [btcData, ethData] = await Promise.all([
      fetchWithCache(
        'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=hourly',
        'btcChart',
        10000
      ),
      fetchWithCache(
        'https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=1&interval=hourly',
        'ethChart',
        10000
      )
    ]);
    
    const btcLabels = btcData.prices.slice(-24).map(p => new Date(p[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
    const btcPrices = btcData.prices.slice(-24).map(p => p[1]);
    const ethPrices = ethData.prices.slice(-24).map(p => p[1]);
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: btcLabels,
        datasets: [
          {
            label: 'BTC/USD',
            data: btcPrices,
            borderColor: '#F7931A',
            backgroundColor: 'rgba(247, 147, 26, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          },
          {
            label: 'ETH/USD',
            data: ethPrices,
            borderColor: '#627EEA',
            backgroundColor: 'rgba(98, 126, 234, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: 'var(--text)',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(30, 41, 59, 0.9)',
            titleColor: 'var(--text)',
            bodyColor: 'var(--text)',
            borderColor: 'var(--glass)',
            borderWidth: 1
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: {
              color: 'var(--text-secondary)',
              maxTicksLimit: 8
            }
          },
          y: {
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: {
              color: 'var(--text-secondary)',
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'nearest'
        }
      }
    });
    
    setInterval(async () => {
      try {
        const [newBtcData, newEthData] = await Promise.all([
          fetchWithCache(
            'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=hourly',
            'btcChart',
            300000
          ),
          fetchWithCache(
            'https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=1&interval=hourly',
            'ethChart',
            300000
          )
        ]);
        
        const newBtcLabels = newBtcData.prices.slice(-24).map(p => new Date(p[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        const newBtcPrices = newBtcData.prices.slice(-24).map(p => p[1]);
        const newEthPrices = newEthData.prices.slice(-24).map(p => p[1]);
        
        chart.data.labels = newBtcLabels;
        chart.data.datasets[0].data = newBtcPrices;
        chart.data.datasets[1].data = newEthPrices;
        chart.update();
      } catch (error) {
        console.error('Error updating chart:', error);
      }
    }, 10000);
    
  } catch (error) {
    console.error('Error loading chart data:', error);
    
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'],
        datasets: [
          {
            label: 'BTC/USD',
            data: [45000, 45200, 45150, 45300, 45500, 45400, 45600],
            borderColor: '#F7931A',
            backgroundColor: 'rgba(247, 147, 26, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          },
          {
            label: 'ETH/USD',
            data: [3000, 3020, 3015, 3030, 3050, 3040, 3060],
            borderColor: '#627EEA',
            backgroundColor: 'rgba(98, 126, 234, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadData();
  setupSorting();
  
  setInterval(loadData, 10000);
});
</script>

</body>
</html>
