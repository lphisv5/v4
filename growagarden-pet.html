<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Grow A Garden Pet</title>
  <style>
    :root {
      --primary: #2b6cb0;
      --primary-light: #e6f0fa;
      --primary-dark: #1a4971;
      --bg: #f7fafc;
      --text: #1a202c;
      --muted: #718096;
      --border: #e2e8f0;
      --hover: #edf2f7;
      --shadow: rgba(0, 0, 0, 0.1);
      --radius: clamp(8px, 1vw, 10px);
      --transition: all 0.3s ease;
      --animation-duration: 0.4s;
      --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-size-base: clamp(14px, 3.5vw, 16px);
      --rarity-common: #a0aec0;
      --rarity-uncommon: #68d391;
      --rarity-rare: #63b3ed;
      --rarity-legendary: #f6ad55;
      --rarity-mythical: #ed64a6;
      --rarity-divine: #9f7aea;
      --rarity-prismatic: linear-gradient(45deg, #f687b3, #9f7aea, #63b3ed);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: linear-gradient(to bottom, var(--bg), var(--primary-light));
      color: var(--text);
      padding: clamp(1rem, 3vw, 1.5rem);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: var(--font-size-base);
      overscroll-behavior: none;
    }

    header {
      background: var(--primary-light);
      padding: clamp(1rem, 2.5vw, 1.25rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(0.8rem, 2vw, 1rem);
      border-radius: var(--radius);
      box-shadow: 0 2px 4px var(--shadow);
      animation: slideIn var(--animation-duration) var(--animation-easing);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    @keyframes slideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    header h1 {
      color: var(--primary-dark);
      font-size: clamp(1.8rem, 3.5vw, 2.2rem);
      margin: 0;
      text-align: center;
      text-shadow: 0 1px 2px var(--shadow);
    }

    .input-group {
      display: flex;
      gap: clamp(0.5rem, 1.5vw, 0.75rem);
      width: 100%;
      max-width: clamp(300px, 80vw, 600px);
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    header input,
    header select {
      padding: clamp(0.5rem, 1.5vw, 0.6rem);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex: 1;
      min-width: 150px;
      background: white;
      transition: var(--transition);
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
                       linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 20px) center, calc(100% - 15px) center;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }

    header input:focus,
    header select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      transform: scale(1.02) translateY(-2px);
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(200px, 30vw, 240px), 1fr));
      gap: clamp(1rem, 2.5vw, 1.25rem);
      padding: clamp(1rem, 2.5vw, 1.25rem);
      min-height: 300px;
      will-change: transform;
    }

    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      overflow: hidden;
      cursor: pointer;
      transition: transform var(--animation-duration) var(--animation-easing), box-shadow var(--animation-duration) ease;
      position: relative;
      animation: cardEnter var(--animation-duration) var(--animation-easing) forwards;
      animation-delay: calc(var(--index) * 0.1s);
    }

    .card[tabindex="0"]:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .card:hover, .card:focus {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 8px 20px var(--shadow);
    }

    .card img {
      width: 100%;
      height: clamp(150px, 25vw, 170px);
      object-fit: cover;
      background: var(--primary-light);
      transition: transform 0.5s ease;
    }

    .card:hover img, .card:focus img {
      transform: scale(1.1);
    }

    .card .rarity {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius);
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      color: white;
      font-weight: 600;
      backdrop-filter: blur(4px);
      animation: pulseRarity 2s infinite;
    }

    @keyframes pulseRarity {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .card-body {
      padding: clamp(0.75rem, 1.8vw, 0.9rem);
      background: linear-gradient(to bottom, var(--primary-light), white);
    }

    .card-body h3 {
      margin: 0 0 clamp(0.5rem, 1.2vw, 0.6rem);
      font-size: clamp(1.1rem, 2.5vw, 1.3rem);
      color: var(--text);
      transition: color 0.3s ease;
    }

    .card:hover .card-body h3, .card:focus .card-body h3 {
      color: var(--primary-dark);
    }

    .card-body p {
      margin: clamp(0.3rem, 0.8vw, 0.4rem) 0;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      color: var(--muted);
    }

    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: grid;
      place-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--animation-duration) var(--animation-easing);
    }

    #modal:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: clamp(1.25rem, 2.5vw, 1.5rem);
      max-width: clamp(340px, 90vw, 420px);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
      box-shadow: 0 8px 24px var(--shadow);
      animation: modalPop var(--animation-duration) var(--animation-easing);
      transform-origin: center;
    }

    @keyframes modalPop {
      from { transform: scale(0.8) rotate(2deg); opacity: 0; }
      to { transform: scale(1) rotate(0); opacity: 1; }
    }

    #modalClose {
      position: absolute;
      top: clamp(0.5rem, 1.2vw, 0.6rem);
      right: clamp(0.5rem, 1.2vw, 0.6rem);
      cursor: pointer;
      font-size: clamp(1.4rem, 3.5vw, 1.6rem);
      background: transparent;
      border: none;
      color: var(--text);
      transition: var(--transition);
      transform: rotate(0);
    }

    #modalClose:hover, #modalClose:focus {
      color: var(--primary);
      transform: rotate(90deg);
    }

    #modalIcon {
      width: 100%;
      max-width: clamp(140px, 30vw, 180px);
      height: auto;
      border-radius: var(--radius);
      margin-bottom: clamp(1rem, 2.5vw, 1.25rem);
      transition: transform 0.3s ease;
    }

    .modal-content:hover #modalIcon {
      transform: scale(1.05);
    }

    .modal-content h2 {
      font-size: clamp(1.4rem, 3.2vw, 1.6rem);
      color: var(--primary-dark);
      margin: clamp(0.5rem, 1.2vw, 0.6rem) 0;
      text-shadow: 0 1px 2px var(--shadow);
    }

    .modal-detail p {
      margin: clamp(0.5rem, 1.2vw, 0.6rem) 0;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      color: var(--muted);
      line-height: 1.5;
    }

    .modal-detail strong {
      color: var(--text);
    }

    .google-search-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: clamp(0.5rem, 1.5vw, 0.6rem);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      border: none;
      background: #4285f4;
      color: white;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      margin-top: clamp(0.5rem, 1.2vw, 0.6rem);
      position: relative;
    }

    .google-search-btn:hover, .google-search-btn:focus {
      background: #3267d6;
      transform: translateY(-2px);
      animation: pulseGoogle 1.5s infinite;
    }

    .google-search-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
      opacity: 0.7;
    }

    @keyframes pulseGoogle {
      0%, 100% { transform: translateY(-2px); }
      50% { transform: translateY(0); }
    }

    #loading {
      text-align: center;
      padding: clamp(1.5rem, 3vw, 2rem);
      display: none;
      aria-live: "polite";
    }

    #loading:not(.hidden) {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--primary-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #error {
      text-align: center;
      font-size: clamp(1.1rem, 2.5vw, 1.3rem);
      color: #e53e3e;
      padding: clamp(1rem, 2.5vw, 1.25rem);
      font-weight: 600;
      display: none;
      background: rgba(229, 62, 62, 0.1);
      border-radius: var(--radius);
      aria-live: "assertive";
    }

    #error:not(.hidden) {
      display: block;
    }

    #pagination {
      display: flex;
      justify-content: center;
      gap: clamp(0.5rem, 1.2vw, 0.6rem);
      padding: clamp(1rem, 2.5vw, 1.25rem);
      flex-wrap: wrap;
    }

    .page-btn {
      padding: clamp(0.5rem, 1.5vw, 0.6rem) clamp(1rem, 2.5vw, 1.25rem);
      border: none;
      background: var(--primary);
      color: white;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: clamp(0.95rem, 2.5vw, 1.05rem);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .page-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s ease, height 0.3s ease;
    }

    .page-btn:hover::after, .page-btn:focus::after {
      width: 200%;
      height: 200%;
    }

    .page-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }

    .page-btn:hover:not(:disabled), .page-btn:focus:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .skeleton {
      background: linear-gradient(90deg, var(--primary-light) 25%, var(--hover) 50%, var(--primary-light) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
      border-radius: var(--radius);
      height: clamp(150px, 25vw, 170px);
    }

    .skeleton-card {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .skeleton-card .card-body {
      padding: clamp(0.75rem, 1.8vw, 0.9rem);
    }

    .skeleton-text {
      border-radius: var(--radius);
      background: linear-gradient(90deg, var(--primary-light) 25%, var(--hover) 50%, var(--primary-light) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .rarity-common { background: var(--rarity-common); }
    .rarity-uncommon { background: var(--rarity-uncommon); }
    .rarity-rare { background: var(--rarity-rare); }
    .rarity-legendary { background: var(--rarity-legendary); }
    .rarity-mythical { background: var(--rarity-mythical); }
    .rarity-divine { background: var(--rarity-divine); }
    .rarity-prismatic { 
      background: var(--rarity-prismatic);
      background-size: 200% 200%;
      animation: gradientShift 5s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      :root {
        --font-size-base: clamp(15px, 3.5vw, 17px);
        --radius: clamp(9px, 1vw, 11px);
      }
      .card img, .skeleton {
        height: clamp(160px, 25vw, 180px);
      }
      #modalIcon {
        max-width: clamp(150px, 30vw, 190px);
      }
    }

    @media (max-width: 600px) {
      body { padding: clamp(0.8rem, 2vw, 1rem); }
      header { padding: clamp(0.8rem, 2vw, 1rem); }
      header h1 { font-size: clamp(1.4rem, 3vw, 1.8rem); }
      .input-group { flex-direction: column; }
      header input, header select { font-size: clamp(0.85rem, 2vw, 0.95rem); min-width: 100%; }
      #grid { grid-template-columns: repeat(auto-fill, minmax(clamp(160px, 45vw, 200px), 1fr)); }
      .card img, .skeleton { height: clamp(130px, 30vw, 150px); }
      .card-body h3 { font-size: clamp(0.95rem, 2vw, 1.05rem); }
      .card-body p { font-size: clamp(0.75rem, 1.8vw, 0.85rem); }
      .modal-content { padding: clamp(1rem, 2.5vw, 1.25rem); max-width: clamp(300px, 95vw, 380px); }
      #modalIcon { max-width: clamp(120px, 35vw, 160px); }
      .page-btn { font-size: clamp(0.85rem, 2vw, 0.95rem); }
    }

    @media (max-width: 400px) {
      #grid { grid-template-columns: 1fr; }
      .card img, .skeleton { height: clamp(110px, 35vw, 130px); }
      .modal-content { max-width: 95vw; }
    }

    @media (min-width: 1200px) {
      .input-group { max-width: clamp(400px, 40vw, 650px); }
      #grid { grid-template-columns: repeat(auto-fill, minmax(clamp(240px, 25vw, 280px), 1fr)); }
      .card img, .skeleton { height: clamp(170px, 20vw, 190px); }
      .card-body h3 { font-size: clamp(1.2rem, 2vw, 1.4rem); }
      .modal-content { max-width: clamp(380px, 35vw, 480px); }
      #modalIcon { max-width: clamp(160px, 25vw, 200px); }
    }
  </style>
</head>
<body>
  <header>
    <h1>Grow A Garden Pet</h1>
    <div class="input-group">
      <input type="search" id="search" placeholder="Search by name or rarity‚Ä¶" aria-label="Search pets" />
      <select id="filterRarity" aria-label="Filter by rarity">
        <option value="">All Rarity</option>
        <option value="Common">Common</option>
        <option value="Uncommon">Uncommon</option>
        <option value="Rare">Rare</option>
        <option value="Legendary">Legendary</option>
        <option value="Mythical">Mythical</option>
        <option value="Divine">Divine</option>
        <option value="Prismatic">Prismatic</option>
      </select>
    </div>
  </header>

  <main id="grid"></main>
  <div id="loading" class="hidden"><div class="spinner"></div></div>
  <div id="error" class="hidden"></div>
  <div id="pagination"></div>

  <div id="modal" class="hidden" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="modalName">
    <div class="modal-content">
      <button id="modalClose" aria-label="Close modal">&times;</button>
      <img id="modalIcon" src="" alt="" onerror="this.src=FALLBACK_IMAGE; this.onerror=null;" />
      <h2 id="modalName"></h2>
      <div class="modal-detail">
        <p><strong>Rarity:</strong> <span id="modalRarity"></span></p>
        <p><strong>Price:</strong> <span id="modalPrice"></span> <span id="modalCurrency"></span></p>
        <p><strong>Description:</strong> <span id="modalDesc"></span></p>
        <p><strong>Type:</strong> <span id="modalType"></span></p>
        <button id="googleSearch" class="google-search-btn" aria-label="Search pet on Google">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          Search on Google
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://api.joshlei.com/v2/growagarden/info?type=pet';
    const JSTUDIO_KEY = 'js_bfbf185548d8ea2b648c6d971833bbecdcc70a896575b193444af969ecfbaf69';
    const ITEMS_PER_PAGE = 12;
    const FALLBACK_IMAGE = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="16">üêæ</text></svg>';
    const GOOGLE_SEARCH_URL = 'https://www.google.com/search?q=';

    const elements = {
      grid: document.getElementById('grid'),
      searchInput: document.getElementById('search'),
      filterRarity: document.getElementById('filterRarity'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalIcon: document.getElementById('modalIcon'),
      modalName: document.getElementById('modalName'),
      modalRarity: document.getElementById('modalRarity'),
      modalPrice: document.getElementById('modalPrice'),
      modalCurrency: document.getElementById('modalCurrency'),
      modalDesc: document.getElementById('modalDesc'),
      modalType: document.getElementById('modalType'),
      googleSearch: document.getElementById('googleSearch'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      pagination: document.getElementById('pagination')
    };

    let animals = [];
    let filteredAnimals = [];
    let currentPage = 1;
    let isFetching = false;
    let scrollPosition = 0;

    const formatPrice = (price, currency) => {
      if (!price || isNaN(Number(price))) return "N/A";
      return Number(price).toLocaleString('en-US', {
        style: currency === "Chi" ? 'decimal' : 'currency',
        currency: currency === "Chi" ? undefined : 'USD',
        maximumFractionDigits: currency === "Chi" ? 0 : 2
      });
    };

    const getRarityClass = (rarity) => `rarity-${(rarity || 'Common').toLowerCase().replace(' ', '-')}`;

    const showLoading = (show) => {
      elements.loading.classList.toggle('hidden', !show);
    };

    const showError = (msg) => {
      elements.error.textContent = msg || 'An unexpected error occurred';
      elements.error.classList.toggle('hidden', !msg);
    };

    const debounce = (func, delay = 300) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    };

    const throttle = (func, limit = 100) => {
      let inThrottle;
      return (...args) => {
        if (!inThrottle) {
          func(...args);
          inThrottle = true;
          setTimeout(() => (inThrottle = false), limit);
        }
      };
    };

    const sanitizeInput = (input) => {
      if (!input) return '';
      return input.replace(/[<>'"&]/g, '').replace(/[\n\r\t]/g, ' ').trim();
    };

    const generateGoogleSearchUrl = (query) => {
      if (!query) return null;
      const sanitizedQuery = encodeURIComponent(sanitizeInput(query));
      return `${GOOGLE_SEARCH_URL}${sanitizedQuery}+pet`;
    };

    const fetchAnimals = async (retryCount = 0) => {
      if (isFetching) return;
      isFetching = true;
      try {
        const res = await fetch(API_URL, {
          headers: { 'JStudio-key': JSTUDIO_KEY },
          cache: 'default'
        });
        if (!res.ok) {
          if (res.status === 429 && retryCount < 3) {
            await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
            return fetchAnimals(retryCount + 1);
          }
          throw new Error(`API error: ${res.status} ${res.statusText}`);
        }
        animals = await res.json();
        if (!Array.isArray(animals)) throw new Error('Invalid data format');
        filteredAnimals = animals;
        currentPage = 1;
        applyFilters();
        preloadImages(animals);
      } catch (e) {
        showError(`Failed to load data: ${e.message}`);
        elements.grid.innerHTML = '';
        elements.pagination.innerHTML = '';
      } finally {
        isFetching = false;
      }
    };

    const loadAnimals = async () => {
      showLoading(true);
      renderSkeleton();
      await fetchAnimals();
      showLoading(false);
    };

    const applyFilters = () => {
      const q = sanitizeInput(elements.searchInput.value.trim().toLowerCase());
      const rarityFilter = elements.filterRarity.value;

      filteredAnimals = animals.filter(a => {
        if (!a) return false;
        const matchesText = (a.display_name?.toLowerCase() || '').includes(q) ||
                           (a.rarity?.toLowerCase() || '').includes(q);
        const matchesRarity = !rarityFilter || a.rarity === rarityFilter;
        return matchesText && matchesRarity;
      });

      currentPage = 1;
      renderPage();
      renderPagination();
    };

    const renderSkeleton = () => {
      elements.grid.innerHTML = '';
      for (let i = 0; i < ITEMS_PER_PAGE; i++) {
        const card = document.createElement('div');
        card.className = 'skeleton-card';
        card.innerHTML = `
          <div class="skeleton"></div>
          <div class="card-body">
            <h3><div class="skeleton-text" style="height: 1.3rem; width: 70%; margin-bottom: 0.5rem;"></div></h3>
            <p><div class="skeleton-text" style="height: 0.9rem; width: 50%;"></div></p>
            <p><div class="skeleton-text" style="height: 0.9rem; width: 60%;"></div></p>
          </div>`;
        elements.grid.appendChild(card);
      }
    };

    const createCard = (animal, index) => {
      if (!animal) return null;
      const card = document.createElement('div');
      card.className = 'card';
      card.tabIndex = 0;
      card.style.setProperty('--index', index);
      card.innerHTML = `
        <img data-src="${sanitizeInput(animal.icon || '')}" alt="${sanitizeInput(animal.display_name || 'Pet')}" 
             onerror="this.src=FALLBACK_IMAGE; this.onerror=null;">
        <div class="rarity ${getRarityClass(animal.rarity)}">${sanitizeInput(animal.rarity || 'Common')}</div>
        <div class="card-body">
          <h3>${sanitizeInput(animal.display_name || 'Unknown Pet')}</h3>
          <p><strong>Rarity:</strong> ${sanitizeInput(animal.rarity || 'N/A')}</p>
          <p><strong>Price:</strong> ${formatPrice(animal.price, animal.currency)} ${sanitizeInput(animal.currency || '')}</p>
        </div>`;
      const openModalWithAnimation = () => {
        card.style.animation = 'cardFlip 0.3s ease forwards';
        setTimeout(() => openModal(animal), 150);
      };
      card.addEventListener('click', openModalWithAnimation);
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openModalWithAnimation();
        }
      });
      return card;
    };

    const renderPage = () => {
      elements.grid.innerHTML = '';
      if (filteredAnimals.length === 0) {
        elements.grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--muted);font-size:clamp(1rem, 2.5vw, 1.2rem);">No pets found. Try adjusting your filters.</p>';
        return;
      }
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageItems = filteredAnimals.slice(start, end);

      pageItems.forEach((animal, index) => {
        const card = createCard(animal, index);
        if (card) elements.grid.appendChild(card);
      });
      observeCards();
    };

    const createPaginationButton = (text, disabled, onClick, isCurrent = false) => {
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.className = 'page-btn';
      btn.disabled = disabled;
      btn.setAttribute('aria-label', `${text} page`);
      btn.setAttribute('aria-current', isCurrent ? 'page' : 'false');
      const handleAction = () => {
        if (!disabled) {
          scrollPosition = window.scrollY;
          onClick();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };
      btn.addEventListener('click', handleAction);
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleAction();
        }
      });
      return btn;
    };

    const renderPagination = () => {
      elements.pagination.innerHTML = '';
      const totalPages = Math.ceil(filteredAnimals.length / ITEMS_PER_PAGE);
      if (totalPages <= 1) return;

      elements.pagination.appendChild(createPaginationButton('Prev', currentPage === 1, () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
          renderPagination();
        }
      }));

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

      if (startPage > 1) {
        elements.pagination.appendChild(createPaginationButton('1', false, () => {
          currentPage = 1;
          renderPage();
          renderPagination();
        }));
        if (startPage > 2) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'page-btn';
          dots.style.pointerEvents = 'none';
          elements.pagination.appendChild(dots);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        elements.pagination.appendChild(createPaginationButton(i, i === currentPage, () => {
          currentPage = i;
          renderPage();
          renderPagination();
        }, i === currentPage));
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'page-btn';
          dots.style.pointerEvents = 'none';
          elements.pagination.appendChild(dots);
        }
        elements.pagination.appendChild(createPaginationButton(totalPages, false, () => {
          currentPage = totalPages;
          renderPage();
          renderPagination();
        }));
      }

      elements.pagination.appendChild(createPaginationButton('Next', currentPage === totalPages, () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderPage();
          renderPagination();
        }
      }));
    };

    const openModal = (animal) => {
      if (!animal) return;
      elements.modalIcon.src = sanitizeInput(animal.icon || '');
      elements.modalIcon.alt = sanitizeInput(animal.display_name || 'Pet');
      elements.modalName.textContent = sanitizeInput(animal.display_name || 'Unknown Pet');
      elements.modalRarity.textContent = sanitizeInput(animal.rarity || 'N/A');
      elements.modalPrice.textContent = formatPrice(animal.price, animal.currency);
      elements.modalCurrency.textContent = sanitizeInput(animal.currency || '');
      elements.modalDesc.textContent = sanitizeInput(animal.description || 'No description available');
      elements.modalType.textContent = sanitizeInput(animal.type || 'N/A');
      
      const searchUrl = generateGoogleSearchUrl(animal.display_name);
      elements.googleSearch.disabled = !searchUrl;
      elements.googleSearch.setAttribute('aria-label', `Search ${sanitizeInput(animal.display_name || 'pet')} on Google`);
      const handleGoogleSearch = () => {
        if (searchUrl) {
          elements.googleSearch.disabled = true;
          window.open(searchUrl, '_blank');
          setTimeout(() => { elements.googleSearch.disabled = false; }, 1000);
        }
      };
      elements.googleSearch.onclick = handleGoogleSearch;
      elements.googleSearch.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleGoogleSearch();
        }
      };

      elements.modal.classList.remove('hidden');
      elements.modal.focus();
      document.body.style.overflow = 'hidden';
      trapFocus(elements.modal);
    };

    const closeModal = () => {
      elements.modal.classList.add('hidden');
      elements.modalIcon.src = '';
      elements.modalIcon.alt = '';
      elements.modalName.textContent = '';
      elements.modalRarity.textContent = '';
      elements.modalPrice.textContent = '';
      elements.modalCurrency.textContent = '';
      elements.modalDesc.textContent = '';
      elements.modalType.textContent = '';
      elements.googleSearch.disabled = false;
      document.body.style.overflow = '';
      window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
      releaseFocus();
    };

    const trapFocus = (modal) => {
      const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (focusableElements.length === 0) return;
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      const handleKeydown = (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          } else if (!e.shiftKey && document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
      };

      modal.addEventListener('keydown', handleKeydown);
      modal._trapKeydown = handleKeydown;
      firstFocusable.focus();
    };

    const releaseFocus = () => {
      if (elements.modal._trapKeydown) {
        elements.modal.removeEventListener('keydown', elements.modal._trapKeydown);
        elements.modal._trapKeydown = null;
      }
    };

    elements.modalClose.addEventListener('click', closeModal);
    elements.modal.addEventListener('click', e => {
      if (e.target === elements.modal) closeModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && !elements.modal.classList.contains('hidden')) closeModal();
    });

    const debouncedFilter = debounce(applyFilters, 300);
    elements.searchInput.addEventListener('input', debouncedFilter);
    elements.filterRarity.addEventListener('change', applyFilters);

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target.querySelector('img');
          if (img && !img.src && img.dataset.src) {
            img.src = img.dataset.src;
          }
        }
      });
    }, { rootMargin: '100px' });

    const observeCards = () => {
      document.querySelectorAll('.card').forEach(card => observer.observe(card));
    };

    const preloadImages = throttle((animals) => {
      const firstPage = animals.slice(0, ITEMS_PER_PAGE);
      firstPage.forEach(animal => {
        if (animal.icon) {
          const img = new Image();
          img.src = animal.icon;
        }
      });
    }, 1000);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) isFetching = false;
    });

    window.addEventListener('resize', throttle(() => {
      applyFilters();
    }, 100));

    const style = document.createElement('style');
    style.textContent = `
      @keyframes cardFlip {
        0% { transform: perspective(600px) rotateY(0deg); }
        50% { transform: perspective(600px) rotateY(90deg); }
        100% { transform: perspective(600px) rotateY(0deg); }
      }
    `;
    document.head.appendChild(style);

    loadAnimals();
  </script>
</body>
</html>
